<!doctype html><html lang=en-us dir=ltr><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="基于Netty的Spring Boot内置Servlet容器的实现（四） Registration注册器的实现 设计与继承结构 在本系列第一篇提到了javax.servlet.Registration接口，用于实现Filter和Servlet的动态注册，这个接口相对比较简单；有两个子接口，详见下面的UML图：
我们将要分别实现FilterRegistration和ServletRegistration接口，为了保持与Registration接口的继承关系相近，我们设计了三个类，分别是抽象类，Filter注册、Servlet注册：
class AbstractNettyRegistration implements Registration, Registration.Dynamic, ServletConfig, FilterConfig{} public class NettyFilterRegistration extends AbstractNettyRegistration implements FilterRegistration.Dynamic{} public class NettyServletRegistration extends AbstractNettyRegistration implements ServletRegistration.Dynamic{} 这些类构成的UML图如下：
代码实现 在实际实现的过程中，忽略了很多用不到的方法，着重实现了加入Mapping以及获取Filter/Servlet实例的方法。
加入Mapping的方法由ServletContext处理（Mapping本身也是由ServletContext维护），而获取Filter/Servlet的方法使用的是类似于懒加载单例的方法，每个Registration实例维护自己的一个Filter/Servlet实例，首次获取的时候通过反射获取到实例，并将反射获取到的实例由Registration实例持有。具体实现代码如下：
public class NettyServletRegistration extends AbstractNettyRegistration implements ServletRegistration.Dynamic {  private final Logger log = LoggerFactory.getLogger(getClass());  private volatile boolean initialised;  private Servlet servlet;  private Collection&amp;lt;String&amp;gt; urlPatternMappings = new LinkedList&amp;lt;&amp;gt;();   public NettyServletRegistration(NettyContext context, String servletName, String className, Servlet servlet) {  super(servletName, className, context);  this."><title>基于Netty的Spring Boot内置Servlet容器的实现（四）</title><link rel=canonical href=https://leibnizhu.github.io/p/%E5%9F%BA%E4%BA%8ENetty%E7%9A%84Spring-Boot%E5%86%85%E7%BD%AEServlet%E5%AE%B9%E5%99%A8%E7%9A%84%E5%AE%9E%E7%8E%B0%E5%9B%9B/><link rel=stylesheet href=/scss/style.min.f6e1f9fc3ff66a58601c08d5ce96493eafb5f1b936be2f7b2eacd3e7784f2f38.css><meta property="og:title" content="基于Netty的Spring Boot内置Servlet容器的实现（四）"><meta property="og:description" content="基于Netty的Spring Boot内置Servlet容器的实现（四） Registration注册器的实现 设计与继承结构 在本系列第一篇提到了javax.servlet.Registration接口，用于实现Filter和Servlet的动态注册，这个接口相对比较简单；有两个子接口，详见下面的UML图：
我们将要分别实现FilterRegistration和ServletRegistration接口，为了保持与Registration接口的继承关系相近，我们设计了三个类，分别是抽象类，Filter注册、Servlet注册：
class AbstractNettyRegistration implements Registration, Registration.Dynamic, ServletConfig, FilterConfig{} public class NettyFilterRegistration extends AbstractNettyRegistration implements FilterRegistration.Dynamic{} public class NettyServletRegistration extends AbstractNettyRegistration implements ServletRegistration.Dynamic{} 这些类构成的UML图如下：
代码实现 在实际实现的过程中，忽略了很多用不到的方法，着重实现了加入Mapping以及获取Filter/Servlet实例的方法。
加入Mapping的方法由ServletContext处理（Mapping本身也是由ServletContext维护），而获取Filter/Servlet的方法使用的是类似于懒加载单例的方法，每个Registration实例维护自己的一个Filter/Servlet实例，首次获取的时候通过反射获取到实例，并将反射获取到的实例由Registration实例持有。具体实现代码如下：
public class NettyServletRegistration extends AbstractNettyRegistration implements ServletRegistration.Dynamic {  private final Logger log = LoggerFactory.getLogger(getClass());  private volatile boolean initialised;  private Servlet servlet;  private Collection&amp;lt;String&amp;gt; urlPatternMappings = new LinkedList&amp;lt;&amp;gt;();   public NettyServletRegistration(NettyContext context, String servletName, String className, Servlet servlet) {  super(servletName, className, context);  this."><meta property="og:url" content="https://leibnizhu.github.io/p/%E5%9F%BA%E4%BA%8ENetty%E7%9A%84Spring-Boot%E5%86%85%E7%BD%AEServlet%E5%AE%B9%E5%99%A8%E7%9A%84%E5%AE%9E%E7%8E%B0%E5%9B%9B/"><meta property="og:site_name" content="Heaven's Door"><meta property="og:type" content="article"><meta property="article:section" content="Post"><meta property="article:tag" content="Netty"><meta property="article:tag" content="Spring Boot"><meta property="article:tag" content="Servlet"><meta property="article:published_time" content="2017-09-02T15:11:03+08:00"><meta property="article:modified_time" content="2017-09-02T15:11:03+08:00"><meta property="og:image" content="https://leibnizhu.github.io/p/%E5%9F%BA%E4%BA%8ENetty%E7%9A%84Spring-Boot%E5%86%85%E7%BD%AEServlet%E5%AE%B9%E5%99%A8%E7%9A%84%E5%AE%9E%E7%8E%B0%E5%9B%9B/jinjia.png"><meta name=twitter:title content="基于Netty的Spring Boot内置Servlet容器的实现（四）"><meta name=twitter:description content="基于Netty的Spring Boot内置Servlet容器的实现（四） Registration注册器的实现 设计与继承结构 在本系列第一篇提到了javax.servlet.Registration接口，用于实现Filter和Servlet的动态注册，这个接口相对比较简单；有两个子接口，详见下面的UML图：
我们将要分别实现FilterRegistration和ServletRegistration接口，为了保持与Registration接口的继承关系相近，我们设计了三个类，分别是抽象类，Filter注册、Servlet注册：
class AbstractNettyRegistration implements Registration, Registration.Dynamic, ServletConfig, FilterConfig{} public class NettyFilterRegistration extends AbstractNettyRegistration implements FilterRegistration.Dynamic{} public class NettyServletRegistration extends AbstractNettyRegistration implements ServletRegistration.Dynamic{} 这些类构成的UML图如下：
代码实现 在实际实现的过程中，忽略了很多用不到的方法，着重实现了加入Mapping以及获取Filter/Servlet实例的方法。
加入Mapping的方法由ServletContext处理（Mapping本身也是由ServletContext维护），而获取Filter/Servlet的方法使用的是类似于懒加载单例的方法，每个Registration实例维护自己的一个Filter/Servlet实例，首次获取的时候通过反射获取到实例，并将反射获取到的实例由Registration实例持有。具体实现代码如下：
public class NettyServletRegistration extends AbstractNettyRegistration implements ServletRegistration.Dynamic {  private final Logger log = LoggerFactory.getLogger(getClass());  private volatile boolean initialised;  private Servlet servlet;  private Collection&amp;lt;String&amp;gt; urlPatternMappings = new LinkedList&amp;lt;&amp;gt;();   public NettyServletRegistration(NettyContext context, String servletName, String className, Servlet servlet) {  super(servletName, className, context);  this."><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://leibnizhu.github.io/p/%E5%9F%BA%E4%BA%8ENetty%E7%9A%84Spring-Boot%E5%86%85%E7%BD%AEServlet%E5%AE%B9%E5%99%A8%E7%9A%84%E5%AE%9E%E7%8E%B0%E5%9B%9B/jinjia.png"><script async src="https://www.googletagmanager.com/gtag/js?id=G-TK434TCNDK"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-TK434TCNDK",{anonymize_ip:!1})}</script></head><body class=article-page><script>(function(){const e="StackColorScheme";localStorage.getItem(e)||localStorage.setItem(e,"auto")})()</script><script>(function(){const t="StackColorScheme",e=localStorage.getItem(t),n=window.matchMedia("(prefers-color-scheme: dark)").matches===!0;e=="dark"||e==="auto"&&n?document.documentElement.dataset.scheme="dark":document.documentElement.dataset.scheme="light"})()</script><div class="container main-container flex on-phone--column extended"><aside class="sidebar left-sidebar sticky"><button class="hamburger hamburger--spin" type=button id=toggle-menu aria-label="Toggle Menu">
<span class=hamburger-box><span class=hamburger-inner></span></span></button><header><figure class=site-avatar><a href=/><img src=/img/avatar_hu4af873b90feb2f44d14cf5fcf42d034c_7593_300x0_resize_q75_box.jpg width=300 height=300 class=site-logo loading=lazy alt=Avatar></a></figure><div class=site-meta><h1 class=site-name><a href=/>Heaven's Door</a></h1><h2 class=site-description>That cold black cloud is comin' down, Feels like I'm knockin' on heaven's door…</h2></div></header><ol class=social-menu><li><a href=https://leibnizhu.github.io title=Home><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-home" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><polyline points="5 12 3 12 12 3 21 12 19 12"/><path d="M5 12v7a2 2 0 002 2h10a2 2 0 002-2v-7"/><path d="M9 21v-6a2 2 0 012-2h2a2 2 0 012 2v6"/></svg></a></li><li><a href=https://github.com/leibnizhu target=_blank title=GitHub><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-brand-github" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M9 19c-4.3 1.4-4.3-2.5-6-3m12 5v-3.5c0-1 .1-1.4-.5-2 2.8-.3 5.5-1.4 5.5-6a4.6 4.6.0 00-1.3-3.2 4.2 4.2.0 00-.1-3.2s-1.1-.3-3.5 1.3a12.3 12.3.0 00-6.2.0C6.5 2.8 5.4 3.1 5.4 3.1a4.2 4.2.0 00-.1 3.2A4.6 4.6.0 004 9.5c0 4.6 2.7 5.7 5.5 6-.6.6-.6 1.2-.5 2V21"/></svg></a></li><li><a href=mailto:leibnizhu@gmail.com target=_blank title=Email><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-brand-gmail" width="44" height="44" viewBox="0 0 24 24" stroke-width="1.5" stroke="#2c3e50" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M16 20h3a1 1 0 001-1V5a1 1 0 00-1-1h-3v16z"/><path d="M5 20h3V4H5A1 1 0 004 5v14a1 1 0 001 1z"/><path d="M16 4l-4 4-4-4"/><path d="M4 6.5l8 7.5 8-7.5"/></svg></a></li><li><a href=https://leibnizhu.github.io/running target=_blank title=Running><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-run" width="44" height="44" viewBox="0 0 24 24" stroke-width="1.5" stroke="#2c3e50" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><circle cx="13" cy="4" r="1"/><path d="M4 17l5 1 .75-1.5"/><path d="M15 21v-4l-4-3 1-6"/><path d="M7 12V9l5-1 3 3 3 1"/></svg></a></li></ol><ol class=menu id=main-menu><li><a href=/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-home" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><polyline points="5 12 3 12 12 3 21 12 19 12"/><path d="M5 12v7a2 2 0 002 2h10a2 2 0 002-2v-7"/><path d="M9 21v-6a2 2 0 012-2h2a2 2 0 012 2v6"/></svg><span>Home</span></a></li><li><a href=/About/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-user" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="7" r="4"/><path d="M6 21v-2a4 4 0 014-4h4a4 4 0 014 4v2"/></svg><span>About</span></a></li><li><a href=/archives/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-archive" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><rect x="3" y="4" width="18" height="4" rx="2"/><path d="M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8"/><line x1="10" y1="12" x2="14" y2="12"/></svg><span>Archives</span></a></li><li><a href=/search/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-search" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="10" cy="10" r="7"/><line x1="21" y1="21" x2="15" y2="15"/></svg><span>Search</span></a></li><li><a href=/Links/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-link" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M10 14a3.5 3.5.0 005 0l4-4a3.5 3.5.0 00-5-5l-.5.5"/><path d="M14 10a3.5 3.5.0 00-5 0l-4 4a3.5 3.5.0 005 5l.5-.5"/></svg><span>Links</span></a></li><div class=menu-bottom-section><li id=dark-mode-toggle><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="8" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-right" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="16" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg><span>Dark Mode</span></li></div></ol></aside><main class="main full-width"><article class="has-image main-article"><header class=article-header><div class=article-image><a href=/p/%E5%9F%BA%E4%BA%8ENetty%E7%9A%84Spring-Boot%E5%86%85%E7%BD%AEServlet%E5%AE%B9%E5%99%A8%E7%9A%84%E5%AE%9E%E7%8E%B0%E5%9B%9B/><img src=/p/%E5%9F%BA%E4%BA%8ENetty%E7%9A%84Spring-Boot%E5%86%85%E7%BD%AEServlet%E5%AE%B9%E5%99%A8%E7%9A%84%E5%AE%9E%E7%8E%B0%E5%9B%9B/jinjia_hu26351fb12c0954f3f1a41e5c79a350f9_35320_800x0_resize_box_3.png srcset="/p/%E5%9F%BA%E4%BA%8ENetty%E7%9A%84Spring-Boot%E5%86%85%E7%BD%AEServlet%E5%AE%B9%E5%99%A8%E7%9A%84%E5%AE%9E%E7%8E%B0%E5%9B%9B/jinjia_hu26351fb12c0954f3f1a41e5c79a350f9_35320_800x0_resize_box_3.png 800w, /p/%E5%9F%BA%E4%BA%8ENetty%E7%9A%84Spring-Boot%E5%86%85%E7%BD%AEServlet%E5%AE%B9%E5%99%A8%E7%9A%84%E5%AE%9E%E7%8E%B0%E5%9B%9B/jinjia_hu26351fb12c0954f3f1a41e5c79a350f9_35320_1600x0_resize_box_3.png 1600w" width=800 height=318 loading=lazy alt="Featured image of post 基于Netty的Spring Boot内置Servlet容器的实现（四）"></a></div><div class=article-details><div class=article-title-wrapper><h2 class=article-title><a href=/p/%E5%9F%BA%E4%BA%8ENetty%E7%9A%84Spring-Boot%E5%86%85%E7%BD%AEServlet%E5%AE%B9%E5%99%A8%E7%9A%84%E5%AE%9E%E7%8E%B0%E5%9B%9B/>基于Netty的Spring Boot内置Servlet容器的实现（四）</a></h2></div><footer class=article-time><div><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M11.795 21H5a2 2 0 01-2-2V7a2 2 0 012-2h12a2 2 0 012 2v4"/><circle cx="18" cy="18" r="4"/><path d="M15 3v4"/><path d="M7 3v4"/><path d="M3 11h16"/><path d="M18 16.496V18l1 1"/></svg><time class=article-time--published>Sep 02, 2017</time></div><div><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><polyline points="12 7 12 12 15 15"/></svg><time class=article-time--reading>8 minute read</time></div></footer></div></header><section class=article-content><h1 id=基于netty的spring-boot内置servlet容器的实现四>基于Netty的Spring Boot内置Servlet容器的实现（四）</h1><h2 id=registration注册器的实现>Registration注册器的实现</h2><h3 id=设计与继承结构>设计与继承结构</h3><p>在本系列第一篇提到了<code>javax.servlet.Registration</code>接口，用于实现Filter和Servlet的动态注册，这个接口相对比较简单；有两个子接口，详见下面的UML图：<br><img src=/p/%E5%9F%BA%E4%BA%8ENetty%E7%9A%84Spring-Boot%E5%86%85%E7%BD%AEServlet%E5%AE%B9%E5%99%A8%E7%9A%84%E5%AE%9E%E7%8E%B0%E5%9B%9B/registration.png width=332 height=119 srcset="/p/%E5%9F%BA%E4%BA%8ENetty%E7%9A%84Spring-Boot%E5%86%85%E7%BD%AEServlet%E5%AE%B9%E5%99%A8%E7%9A%84%E5%AE%9E%E7%8E%B0%E5%9B%9B/registration_hu831b4d4bf95df234e4449ae778439cb1_7670_480x0_resize_box_3.png 480w, /p/%E5%9F%BA%E4%BA%8ENetty%E7%9A%84Spring-Boot%E5%86%85%E7%BD%AEServlet%E5%AE%B9%E5%99%A8%E7%9A%84%E5%AE%9E%E7%8E%B0%E5%9B%9B/registration_hu831b4d4bf95df234e4449ae778439cb1_7670_1024x0_resize_box_3.png 1024w" loading=lazy class=gallery-image data-flex-grow=278 data-flex-basis=669px><br>我们将要分别实现<code>FilterRegistration</code>和<code>ServletRegistration</code>接口，为了保持与<code>Registration</code>接口的继承关系相近，我们设计了三个类，分别是抽象类，Filter注册、Servlet注册：</p><div class=highlight><pre tabindex=0 style=color:#e7e9db;background-color:#2f1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#815ba4>class</span> <span style=color:#fec418>AbstractNettyRegistration</span> <span style=color:#815ba4>implements</span> Registration<span style=color:#5bc4bf>,</span> Registration<span style=color:#5bc4bf>.</span><span style=color:#06b6ef>Dynamic</span><span style=color:#5bc4bf>,</span> ServletConfig<span style=color:#5bc4bf>,</span> FilterConfig<span style=color:#5bc4bf>{}</span>
</span></span><span style=display:flex><span><span style=color:#815ba4>public</span> <span style=color:#815ba4>class</span> <span style=color:#fec418>NettyFilterRegistration</span> <span style=color:#815ba4>extends</span> AbstractNettyRegistration <span style=color:#815ba4>implements</span> FilterRegistration<span style=color:#5bc4bf>.</span><span style=color:#06b6ef>Dynamic</span><span style=color:#5bc4bf>{}</span>
</span></span><span style=display:flex><span><span style=color:#815ba4>public</span> <span style=color:#815ba4>class</span> <span style=color:#fec418>NettyServletRegistration</span> <span style=color:#815ba4>extends</span> AbstractNettyRegistration <span style=color:#815ba4>implements</span> ServletRegistration<span style=color:#5bc4bf>.</span><span style=color:#06b6ef>Dynamic</span><span style=color:#5bc4bf>{}</span>
</span></span></code></pre></div><p>这些类构成的UML图如下：<br><img src=/p/%E5%9F%BA%E4%BA%8ENetty%E7%9A%84Spring-Boot%E5%86%85%E7%BD%AEServlet%E5%AE%B9%E5%99%A8%E7%9A%84%E5%AE%9E%E7%8E%B0%E5%9B%9B/nettyregistration.png width=763 height=305 srcset="/p/%E5%9F%BA%E4%BA%8ENetty%E7%9A%84Spring-Boot%E5%86%85%E7%BD%AEServlet%E5%AE%B9%E5%99%A8%E7%9A%84%E5%AE%9E%E7%8E%B0%E5%9B%9B/nettyregistration_hu06c2b308d87ab306685ce16afaf10d4e_20515_480x0_resize_box_3.png 480w, /p/%E5%9F%BA%E4%BA%8ENetty%E7%9A%84Spring-Boot%E5%86%85%E7%BD%AEServlet%E5%AE%B9%E5%99%A8%E7%9A%84%E5%AE%9E%E7%8E%B0%E5%9B%9B/nettyregistration_hu06c2b308d87ab306685ce16afaf10d4e_20515_1024x0_resize_box_3.png 1024w" loading=lazy class=gallery-image data-flex-grow=250 data-flex-basis=600px></p><h3 id=代码实现>代码实现</h3><p>在实际实现的过程中，忽略了很多用不到的方法，着重实现了加入Mapping以及获取Filter/Servlet实例的方法。<br>加入Mapping的方法由ServletContext处理（Mapping本身也是由ServletContext维护），而获取Filter/Servlet的方法使用的是类似于懒加载单例的方法，每个Registration实例维护自己的一个Filter/Servlet实例，首次获取的时候通过反射获取到实例，并将反射获取到的实例由Registration实例持有。具体实现代码如下：</p><div class=highlight><pre tabindex=0 style=color:#e7e9db;background-color:#2f1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#815ba4>public</span> <span style=color:#815ba4>class</span> <span style=color:#fec418>NettyServletRegistration</span> <span style=color:#815ba4>extends</span> AbstractNettyRegistration <span style=color:#815ba4>implements</span> ServletRegistration<span style=color:#5bc4bf>.</span><span style=color:#06b6ef>Dynamic</span> <span style=color:#5bc4bf>{</span>
</span></span><span style=display:flex><span>    <span style=color:#815ba4>private</span> <span style=color:#815ba4>final</span> Logger log <span style=color:#5bc4bf>=</span> LoggerFactory<span style=color:#5bc4bf>.</span><span style=color:#06b6ef>getLogger</span><span style=color:#5bc4bf>(</span>getClass<span style=color:#5bc4bf>());</span>
</span></span><span style=display:flex><span>    <span style=color:#815ba4>private</span> <span style=color:#815ba4>volatile</span> <span style=color:#fec418>boolean</span> initialised<span style=color:#5bc4bf>;</span>
</span></span><span style=display:flex><span>    <span style=color:#815ba4>private</span> Servlet servlet<span style=color:#5bc4bf>;</span>
</span></span><span style=display:flex><span>    <span style=color:#815ba4>private</span> Collection<span style=color:#5bc4bf>&lt;</span>String<span style=color:#5bc4bf>&gt;</span> urlPatternMappings <span style=color:#5bc4bf>=</span> <span style=color:#815ba4>new</span> LinkedList<span style=color:#5bc4bf>&lt;&gt;();</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#815ba4>public</span> <span style=color:#06b6ef>NettyServletRegistration</span><span style=color:#5bc4bf>(</span>NettyContext context<span style=color:#5bc4bf>,</span> String servletName<span style=color:#5bc4bf>,</span> String className<span style=color:#5bc4bf>,</span> Servlet servlet<span style=color:#5bc4bf>)</span> <span style=color:#5bc4bf>{</span>
</span></span><span style=display:flex><span>        <span style=color:#815ba4>super</span><span style=color:#5bc4bf>(</span>servletName<span style=color:#5bc4bf>,</span> className<span style=color:#5bc4bf>,</span> context<span style=color:#5bc4bf>);</span>
</span></span><span style=display:flex><span>        <span style=color:#815ba4>this</span><span style=color:#5bc4bf>.</span><span style=color:#06b6ef>servlet</span> <span style=color:#5bc4bf>=</span> servlet<span style=color:#5bc4bf>;</span>
</span></span><span style=display:flex><span>    <span style=color:#5bc4bf>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#815ba4>public</span> Servlet <span style=color:#06b6ef>getServlet</span><span style=color:#5bc4bf>()</span> <span style=color:#815ba4>throws</span> ServletException <span style=color:#5bc4bf>{</span>
</span></span><span style=display:flex><span>        <span style=color:#815ba4>if</span> <span style=color:#5bc4bf>(!</span>initialised<span style=color:#5bc4bf>)</span> <span style=color:#5bc4bf>{</span>
</span></span><span style=display:flex><span>            <span style=color:#815ba4>synchronized</span> <span style=color:#5bc4bf>(</span><span style=color:#815ba4>this</span><span style=color:#5bc4bf>)</span> <span style=color:#5bc4bf>{</span>
</span></span><span style=display:flex><span>                <span style=color:#815ba4>if</span> <span style=color:#5bc4bf>(!</span>initialised<span style=color:#5bc4bf>)</span> <span style=color:#5bc4bf>{</span>
</span></span><span style=display:flex><span>                    <span style=color:#815ba4>if</span> <span style=color:#5bc4bf>(</span><span style=color:#815ba4>null</span> <span style=color:#5bc4bf>==</span> servlet<span style=color:#5bc4bf>)</span> <span style=color:#5bc4bf>{</span>
</span></span><span style=display:flex><span>                        <span style=color:#815ba4>try</span> <span style=color:#5bc4bf>{</span>
</span></span><span style=display:flex><span>                            servlet <span style=color:#5bc4bf>=</span> <span style=color:#5bc4bf>(</span>Servlet<span style=color:#5bc4bf>)</span> Class<span style=color:#5bc4bf>.</span><span style=color:#06b6ef>forName</span><span style=color:#5bc4bf>(</span>getClassName<span style=color:#5bc4bf>()).</span><span style=color:#06b6ef>newInstance</span><span style=color:#5bc4bf>();</span> <span style=color:#776e71>//反射获取实例
</span></span></span><span style=display:flex><span><span style=color:#776e71></span>                        <span style=color:#5bc4bf>}</span> <span style=color:#815ba4>catch</span> <span style=color:#5bc4bf>(</span>Exception e<span style=color:#5bc4bf>)</span> <span style=color:#5bc4bf>{</span>
</span></span><span style=display:flex><span>                            <span style=color:#815ba4>throw</span> <span style=color:#815ba4>new</span> ServletException<span style=color:#5bc4bf>(</span>e<span style=color:#5bc4bf>);</span>
</span></span><span style=display:flex><span>                        <span style=color:#5bc4bf>}</span>
</span></span><span style=display:flex><span>                    <span style=color:#5bc4bf>}</span>
</span></span><span style=display:flex><span>                    servlet<span style=color:#5bc4bf>.</span><span style=color:#06b6ef>init</span><span style=color:#5bc4bf>(</span><span style=color:#815ba4>this</span><span style=color:#5bc4bf>);</span> <span style=color:#776e71>//初始化Servlet
</span></span></span><span style=display:flex><span><span style=color:#776e71></span>                    initialised <span style=color:#5bc4bf>=</span> <span style=color:#815ba4>true</span><span style=color:#5bc4bf>;</span>
</span></span><span style=display:flex><span>                <span style=color:#5bc4bf>}</span>
</span></span><span style=display:flex><span>            <span style=color:#5bc4bf>}</span>
</span></span><span style=display:flex><span>        <span style=color:#5bc4bf>}</span>
</span></span><span style=display:flex><span>        <span style=color:#815ba4>return</span> servlet<span style=color:#5bc4bf>;</span>
</span></span><span style=display:flex><span>    <span style=color:#5bc4bf>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#5bc4bf>@Override</span>
</span></span><span style=display:flex><span>    <span style=color:#815ba4>public</span> Set<span style=color:#5bc4bf>&lt;</span>String<span style=color:#5bc4bf>&gt;</span> <span style=color:#06b6ef>addMapping</span><span style=color:#5bc4bf>(</span>String<span style=color:#5bc4bf>...</span> urlPatterns<span style=color:#5bc4bf>)</span> <span style=color:#5bc4bf>{</span>
</span></span><span style=display:flex><span>        <span style=color:#776e71>//在RequestUrlPatternMapper中会检查url Pattern是否冲突
</span></span></span><span style=display:flex><span><span style=color:#776e71></span>        NettyContext context <span style=color:#5bc4bf>=</span> getNettyContext<span style=color:#5bc4bf>();</span>
</span></span><span style=display:flex><span>        <span style=color:#815ba4>for</span> <span style=color:#5bc4bf>(</span>String urlPattern <span style=color:#5bc4bf>:</span> urlPatterns<span style=color:#5bc4bf>)</span> <span style=color:#5bc4bf>{</span>
</span></span><span style=display:flex><span>            <span style=color:#815ba4>try</span> <span style=color:#5bc4bf>{</span>
</span></span><span style=display:flex><span>                context<span style=color:#5bc4bf>.</span><span style=color:#06b6ef>addServletMapping</span><span style=color:#5bc4bf>(</span>urlPattern<span style=color:#5bc4bf>,</span> getName<span style=color:#5bc4bf>(),</span> getServlet<span style=color:#5bc4bf>());</span>
</span></span><span style=display:flex><span>            <span style=color:#5bc4bf>}</span> <span style=color:#815ba4>catch</span> <span style=color:#5bc4bf>(</span>ServletException e<span style=color:#5bc4bf>)</span> <span style=color:#5bc4bf>{</span>
</span></span><span style=display:flex><span>                log<span style=color:#5bc4bf>.</span><span style=color:#06b6ef>error</span><span style=color:#5bc4bf>(</span><span style=color:#48b685>&#34;Throwing exception when getting Servlet in NettyServletRegistration.&#34;</span><span style=color:#5bc4bf>,</span> e<span style=color:#5bc4bf>);</span>
</span></span><span style=display:flex><span>            <span style=color:#5bc4bf>}</span>
</span></span><span style=display:flex><span>        <span style=color:#5bc4bf>}</span>
</span></span><span style=display:flex><span>        urlPatternMappings<span style=color:#5bc4bf>.</span><span style=color:#06b6ef>addAll</span><span style=color:#5bc4bf>(</span>Arrays<span style=color:#5bc4bf>.</span><span style=color:#06b6ef>asList</span><span style=color:#5bc4bf>(</span>urlPatterns<span style=color:#5bc4bf>));</span>
</span></span><span style=display:flex><span>        <span style=color:#815ba4>return</span> <span style=color:#815ba4>new</span> HashSet<span style=color:#5bc4bf>&lt;&gt;(</span>urlPatternMappings<span style=color:#5bc4bf>);</span>
</span></span><span style=display:flex><span>    <span style=color:#5bc4bf>}</span>
</span></span><span style=display:flex><span><span style=color:#5bc4bf>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#815ba4>public</span> <span style=color:#815ba4>class</span> <span style=color:#fec418>NettyFilterRegistration</span> <span style=color:#815ba4>extends</span> AbstractNettyRegistration <span style=color:#815ba4>implements</span> FilterRegistration<span style=color:#5bc4bf>.</span><span style=color:#06b6ef>Dynamic</span> <span style=color:#5bc4bf>{</span>
</span></span><span style=display:flex><span>    <span style=color:#815ba4>private</span> <span style=color:#815ba4>volatile</span> <span style=color:#fec418>boolean</span> initialised<span style=color:#5bc4bf>;</span>
</span></span><span style=display:flex><span>    <span style=color:#815ba4>private</span> Filter filter<span style=color:#5bc4bf>;</span>
</span></span><span style=display:flex><span>    <span style=color:#815ba4>private</span> Collection<span style=color:#5bc4bf>&lt;</span>String<span style=color:#5bc4bf>&gt;</span> urlPatternMappings <span style=color:#5bc4bf>=</span> <span style=color:#815ba4>new</span> LinkedList<span style=color:#5bc4bf>&lt;&gt;();</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#815ba4>public</span> <span style=color:#06b6ef>NettyFilterRegistration</span><span style=color:#5bc4bf>(</span>NettyContext context<span style=color:#5bc4bf>,</span> String filterName<span style=color:#5bc4bf>,</span> String className<span style=color:#5bc4bf>,</span> Filter filter<span style=color:#5bc4bf>)</span> <span style=color:#5bc4bf>{</span>
</span></span><span style=display:flex><span>        <span style=color:#815ba4>super</span><span style=color:#5bc4bf>(</span>filterName<span style=color:#5bc4bf>,</span> className<span style=color:#5bc4bf>,</span> context<span style=color:#5bc4bf>);</span>
</span></span><span style=display:flex><span>        <span style=color:#815ba4>this</span><span style=color:#5bc4bf>.</span><span style=color:#06b6ef>filter</span> <span style=color:#5bc4bf>=</span> filter<span style=color:#5bc4bf>;</span>
</span></span><span style=display:flex><span>    <span style=color:#5bc4bf>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#815ba4>public</span> Filter <span style=color:#06b6ef>getFilter</span><span style=color:#5bc4bf>()</span> <span style=color:#815ba4>throws</span> ServletException <span style=color:#5bc4bf>{</span>
</span></span><span style=display:flex><span>        <span style=color:#815ba4>if</span> <span style=color:#5bc4bf>(!</span>initialised<span style=color:#5bc4bf>)</span> <span style=color:#5bc4bf>{</span>
</span></span><span style=display:flex><span>            <span style=color:#815ba4>synchronized</span> <span style=color:#5bc4bf>(</span><span style=color:#815ba4>this</span><span style=color:#5bc4bf>)</span> <span style=color:#5bc4bf>{</span>
</span></span><span style=display:flex><span>                <span style=color:#815ba4>if</span> <span style=color:#5bc4bf>(!</span>initialised<span style=color:#5bc4bf>)</span> <span style=color:#5bc4bf>{</span>
</span></span><span style=display:flex><span>                    <span style=color:#815ba4>if</span> <span style=color:#5bc4bf>(</span><span style=color:#815ba4>null</span> <span style=color:#5bc4bf>==</span> filter<span style=color:#5bc4bf>)</span> <span style=color:#5bc4bf>{</span>
</span></span><span style=display:flex><span>                        <span style=color:#815ba4>try</span> <span style=color:#5bc4bf>{</span>
</span></span><span style=display:flex><span>                            filter <span style=color:#5bc4bf>=</span> <span style=color:#5bc4bf>(</span>Filter<span style=color:#5bc4bf>)</span> Class<span style=color:#5bc4bf>.</span><span style=color:#06b6ef>forName</span><span style=color:#5bc4bf>(</span>getClassName<span style=color:#5bc4bf>()).</span><span style=color:#06b6ef>newInstance</span><span style=color:#5bc4bf>();</span> <span style=color:#776e71>//反射获取实例
</span></span></span><span style=display:flex><span><span style=color:#776e71></span>                        <span style=color:#5bc4bf>}</span> <span style=color:#815ba4>catch</span> <span style=color:#5bc4bf>(</span>Exception e<span style=color:#5bc4bf>)</span> <span style=color:#5bc4bf>{</span>
</span></span><span style=display:flex><span>                            <span style=color:#815ba4>throw</span> <span style=color:#815ba4>new</span> ServletException<span style=color:#5bc4bf>(</span>e<span style=color:#5bc4bf>);</span>
</span></span><span style=display:flex><span>                        <span style=color:#5bc4bf>}</span>
</span></span><span style=display:flex><span>                    <span style=color:#5bc4bf>}</span>
</span></span><span style=display:flex><span>                    filter<span style=color:#5bc4bf>.</span><span style=color:#06b6ef>init</span><span style=color:#5bc4bf>(</span><span style=color:#815ba4>this</span><span style=color:#5bc4bf>);</span> <span style=color:#776e71>//初始化Filter
</span></span></span><span style=display:flex><span><span style=color:#776e71></span>                    initialised <span style=color:#5bc4bf>=</span> <span style=color:#815ba4>true</span><span style=color:#5bc4bf>;</span>
</span></span><span style=display:flex><span>                <span style=color:#5bc4bf>}</span>
</span></span><span style=display:flex><span>            <span style=color:#5bc4bf>}</span>
</span></span><span style=display:flex><span>        <span style=color:#5bc4bf>}</span>
</span></span><span style=display:flex><span>        <span style=color:#815ba4>return</span> filter<span style=color:#5bc4bf>;</span>
</span></span><span style=display:flex><span>    <span style=color:#5bc4bf>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#5bc4bf>@Override</span>
</span></span><span style=display:flex><span>    <span style=color:#815ba4>public</span> <span style=color:#fec418>void</span> <span style=color:#06b6ef>addMappingForUrlPatterns</span><span style=color:#5bc4bf>(</span>EnumSet<span style=color:#5bc4bf>&lt;</span>DispatcherType<span style=color:#5bc4bf>&gt;</span> dispatcherTypes<span style=color:#5bc4bf>,</span> <span style=color:#fec418>boolean</span> isMatchAfter<span style=color:#5bc4bf>,</span> String<span style=color:#5bc4bf>...</span> urlPatterns<span style=color:#5bc4bf>)</span> <span style=color:#5bc4bf>{</span>
</span></span><span style=display:flex><span>        NettyContext context <span style=color:#5bc4bf>=</span> getNettyContext<span style=color:#5bc4bf>();</span>
</span></span><span style=display:flex><span>        <span style=color:#815ba4>for</span> <span style=color:#5bc4bf>(</span>String urlPattern <span style=color:#5bc4bf>:</span> urlPatterns<span style=color:#5bc4bf>)</span> <span style=color:#5bc4bf>{</span>
</span></span><span style=display:flex><span>            context<span style=color:#5bc4bf>.</span><span style=color:#06b6ef>addFilterMapping</span><span style=color:#5bc4bf>(</span>dispatcherTypes<span style=color:#5bc4bf>,</span> isMatchAfter<span style=color:#5bc4bf>,</span> urlPattern<span style=color:#5bc4bf>);</span>
</span></span><span style=display:flex><span>        <span style=color:#5bc4bf>}</span>
</span></span><span style=display:flex><span>        urlPatternMappings<span style=color:#5bc4bf>.</span><span style=color:#06b6ef>addAll</span><span style=color:#5bc4bf>(</span>Arrays<span style=color:#5bc4bf>.</span><span style=color:#06b6ef>asList</span><span style=color:#5bc4bf>(</span>urlPatterns<span style=color:#5bc4bf>));</span>
</span></span><span style=display:flex><span>    <span style=color:#5bc4bf>}</span>
</span></span><span style=display:flex><span><span style=color:#5bc4bf>}</span>
</span></span></code></pre></div><h2 id=filterchain过滤器链的实现>FilterChain过滤器链的实现</h2><p>大家应该都知道过滤器链的概念，所有过滤器都在过滤器链上，当有请求进入，将依次经过每个适用的过滤器（根据过滤器的Url Pattern与请求的路径而不同），过滤器里执行<code>doFilter()</code>方法让过滤器链执行下一个过滤器，直到最后一个，则执行Servlet的<code>service()</code>方法。而过滤器链对应的接口<code>javax.servlet.FilterChain</code>里面就一个方法：</p><div class=highlight><pre tabindex=0 style=color:#e7e9db;background-color:#2f1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#815ba4>public</span> <span style=color:#815ba4>interface</span> <span style=color:#fec418>FilterChain</span> <span style=color:#5bc4bf>{</span>
</span></span><span style=display:flex><span>    <span style=color:#815ba4>public</span> <span style=color:#fec418>void</span> <span style=color:#06b6ef>doFilter</span> <span style=color:#5bc4bf>(</span> ServletRequest request<span style=color:#5bc4bf>,</span> ServletResponse response <span style=color:#5bc4bf>)</span> <span style=color:#815ba4>throws</span> IOException<span style=color:#5bc4bf>,</span> ServletException<span style=color:#5bc4bf>;</span>
</span></span><span style=display:flex><span><span style=color:#5bc4bf>}</span>
</span></span></code></pre></div><p>显然，实现<code>FilterChain</code>接口，应该要维护一个过滤器的数组或者List，而在<code>doFilter()</code>方法里面，应该判断有没有下一个过滤器，有则调用其<code>doFilter()</code>方法，无则调用当前请求对应Servlet实例的<code>service()</code>方法，可以用迭代器或者记录游标（数组或List的下标）来实现。具体代码：</p><div class=highlight><pre tabindex=0 style=color:#e7e9db;background-color:#2f1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#815ba4>public</span> <span style=color:#815ba4>class</span> <span style=color:#fec418>NettyFilterChain</span> <span style=color:#815ba4>implements</span> FilterChain <span style=color:#5bc4bf>{</span>
</span></span><span style=display:flex><span>    <span style=color:#776e71>/**
</span></span></span><span style=display:flex><span><span style=color:#776e71>     * 考虑到每个请求只有一个线程处理，而且ServletContext在每次请求时都会new 一个SimpleFilterChain对象
</span></span></span><span style=display:flex><span><span style=color:#776e71>     * 所以这里把过滤器链的Iterator作为FilterChain的私有变量，没有线程安全问题
</span></span></span><span style=display:flex><span><span style=color:#776e71>     */</span>
</span></span><span style=display:flex><span>    <span style=color:#815ba4>private</span> <span style=color:#815ba4>final</span> Iterator<span style=color:#5bc4bf>&lt;</span>Filter<span style=color:#5bc4bf>&gt;</span> filterIterator<span style=color:#5bc4bf>;</span>
</span></span><span style=display:flex><span>    <span style=color:#815ba4>private</span> <span style=color:#815ba4>final</span> Servlet servlet<span style=color:#5bc4bf>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#815ba4>public</span> <span style=color:#06b6ef>NettyFilterChain</span><span style=color:#5bc4bf>(</span>Servlet servlet<span style=color:#5bc4bf>,</span> Iterable<span style=color:#5bc4bf>&lt;</span>Filter<span style=color:#5bc4bf>&gt;</span> filters<span style=color:#5bc4bf>)</span> <span style=color:#815ba4>throws</span> ServletException <span style=color:#5bc4bf>{</span>
</span></span><span style=display:flex><span>        <span style=color:#815ba4>this</span><span style=color:#5bc4bf>.</span><span style=color:#06b6ef>filterIterator</span> <span style=color:#5bc4bf>=</span> checkNotNull<span style=color:#5bc4bf>(</span>filters<span style=color:#5bc4bf>).</span><span style=color:#06b6ef>iterator</span><span style=color:#5bc4bf>();</span>
</span></span><span style=display:flex><span>        <span style=color:#815ba4>this</span><span style=color:#5bc4bf>.</span><span style=color:#06b6ef>servlet</span> <span style=color:#5bc4bf>=</span> checkNotNull<span style=color:#5bc4bf>(</span>servlet<span style=color:#5bc4bf>);</span>
</span></span><span style=display:flex><span>    <span style=color:#5bc4bf>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#776e71>/**
</span></span></span><span style=display:flex><span><span style=color:#776e71>     * 每个Filter在处理完请求之后调用FilterChain的这个方法。
</span></span></span><span style=display:flex><span><span style=color:#776e71>     * 这时候应该找到下一个Filter，调用其doFilter()方法。
</span></span></span><span style=display:flex><span><span style=color:#776e71>     * 如果没有下一个了，应该调用servlet的service()方法了
</span></span></span><span style=display:flex><span><span style=color:#776e71>     */</span>
</span></span><span style=display:flex><span>    <span style=color:#5bc4bf>@Override</span>
</span></span><span style=display:flex><span>    <span style=color:#815ba4>public</span> <span style=color:#fec418>void</span> <span style=color:#06b6ef>doFilter</span><span style=color:#5bc4bf>(</span>ServletRequest request<span style=color:#5bc4bf>,</span> ServletResponse response<span style=color:#5bc4bf>)</span> <span style=color:#815ba4>throws</span> IOException<span style=color:#5bc4bf>,</span> ServletException <span style=color:#5bc4bf>{</span>
</span></span><span style=display:flex><span>        <span style=color:#815ba4>if</span> <span style=color:#5bc4bf>(</span>filterIterator<span style=color:#5bc4bf>.</span><span style=color:#06b6ef>hasNext</span><span style=color:#5bc4bf>())</span> <span style=color:#5bc4bf>{</span>
</span></span><span style=display:flex><span>            Filter filter <span style=color:#5bc4bf>=</span> filterIterator<span style=color:#5bc4bf>.</span><span style=color:#06b6ef>next</span><span style=color:#5bc4bf>();</span>
</span></span><span style=display:flex><span>            filter<span style=color:#5bc4bf>.</span><span style=color:#06b6ef>doFilter</span><span style=color:#5bc4bf>(</span>request<span style=color:#5bc4bf>,</span> response<span style=color:#5bc4bf>,</span> <span style=color:#815ba4>this</span><span style=color:#5bc4bf>);</span>
</span></span><span style=display:flex><span>        <span style=color:#5bc4bf>}</span> <span style=color:#815ba4>else</span> <span style=color:#5bc4bf>{</span>
</span></span><span style=display:flex><span>            servlet<span style=color:#5bc4bf>.</span><span style=color:#06b6ef>service</span><span style=color:#5bc4bf>(</span>request<span style=color:#5bc4bf>,</span> response<span style=color:#5bc4bf>);</span>
</span></span><span style=display:flex><span>        <span style=color:#5bc4bf>}</span>
</span></span><span style=display:flex><span>    <span style=color:#5bc4bf>}</span>
</span></span><span style=display:flex><span><span style=color:#5bc4bf>}</span>
</span></span></code></pre></div><h2 id=httpservletrequest的实现>HttpServletRequest的实现</h2><p>接口<code>javax.servlet.http.HttpServletRequest</code>的方法比较多，大概可以分为Cookie相关、Header相关、各种路径相关、Session相关、请求参数相关、请求协议/地址/端口相关、Attributes相关、异步相关、multipart/form-data相关（上传文件）等等方法，以上提到的方法本文基本实现了，还有一些没实现的是暂时用不到的。</p><h3 id=cookie相关方法>Cookie相关方法</h3><p>Cookie使用“懒解析”，就是用标识<code>isCookieParsed</code>记录Cookie是否被解析过，初始化Request对象的时候不解析，在获取Cookiea相关方法被调用的时候再判断是否未解析，若未解析则解析再返回，否则直接返回。<code>NettyHttpServletRequest</code>的构造方法传入了netty的<code>HttpHeaders</code>实例，可以从中获取Cookie请求头，再进行解析。具体代码如下：</p><div class=highlight><pre tabindex=0 style=color:#e7e9db;background-color:#2f1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#776e71>/*====== Cookie 相关方法 开始 ======*/</span>
</span></span><span style=display:flex><span><span style=color:#815ba4>private</span> Cookie<span style=color:#5bc4bf>[]</span> cookies<span style=color:#5bc4bf>;</span>
</span></span><span style=display:flex><span><span style=color:#815ba4>private</span> <span style=color:#815ba4>transient</span> <span style=color:#fec418>boolean</span> isCookieParsed <span style=color:#5bc4bf>=</span> <span style=color:#815ba4>false</span><span style=color:#5bc4bf>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#5bc4bf>@Override</span>
</span></span><span style=display:flex><span><span style=color:#815ba4>public</span> Cookie<span style=color:#5bc4bf>[]</span> <span style=color:#06b6ef>getCookies</span><span style=color:#5bc4bf>()</span> <span style=color:#5bc4bf>{</span>
</span></span><span style=display:flex><span>    <span style=color:#815ba4>if</span> <span style=color:#5bc4bf>(!</span>isCookieParsed<span style=color:#5bc4bf>)</span> <span style=color:#5bc4bf>{</span>
</span></span><span style=display:flex><span>        parseCookie<span style=color:#5bc4bf>();</span>
</span></span><span style=display:flex><span>    <span style=color:#5bc4bf>}</span>
</span></span><span style=display:flex><span>    <span style=color:#815ba4>return</span> cookies<span style=color:#5bc4bf>;</span>
</span></span><span style=display:flex><span><span style=color:#5bc4bf>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#776e71>/**
</span></span></span><span style=display:flex><span><span style=color:#776e71> * 解析request中的Cookie到本类的cookies数组中
</span></span></span><span style=display:flex><span><span style=color:#776e71> *
</span></span></span><span style=display:flex><span><span style=color:#776e71> * @author Leibniz
</span></span></span><span style=display:flex><span><span style=color:#776e71> */</span>
</span></span><span style=display:flex><span><span style=color:#815ba4>private</span> <span style=color:#fec418>void</span> <span style=color:#06b6ef>parseCookie</span><span style=color:#5bc4bf>()</span> <span style=color:#5bc4bf>{</span>
</span></span><span style=display:flex><span>    <span style=color:#815ba4>if</span> <span style=color:#5bc4bf>(</span>isCookieParsed<span style=color:#5bc4bf>)</span> <span style=color:#5bc4bf>{</span>
</span></span><span style=display:flex><span>        <span style=color:#815ba4>return</span><span style=color:#5bc4bf>;</span>
</span></span><span style=display:flex><span>    <span style=color:#5bc4bf>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    String cookieOriginStr <span style=color:#5bc4bf>=</span> <span style=color:#815ba4>this</span><span style=color:#5bc4bf>.</span><span style=color:#06b6ef>headers</span><span style=color:#5bc4bf>.</span><span style=color:#06b6ef>get</span><span style=color:#5bc4bf>(</span><span style=color:#48b685>&#34;Cookie&#34;</span><span style=color:#5bc4bf>);</span>
</span></span><span style=display:flex><span>    <span style=color:#815ba4>if</span> <span style=color:#5bc4bf>(</span>cookieOriginStr <span style=color:#5bc4bf>==</span> <span style=color:#815ba4>null</span><span style=color:#5bc4bf>)</span> <span style=color:#5bc4bf>{</span>
</span></span><span style=display:flex><span>        <span style=color:#815ba4>return</span><span style=color:#5bc4bf>;</span>
</span></span><span style=display:flex><span>    <span style=color:#5bc4bf>}</span>
</span></span><span style=display:flex><span>    Set<span style=color:#5bc4bf>&lt;</span>io<span style=color:#5bc4bf>.</span><span style=color:#06b6ef>netty</span><span style=color:#5bc4bf>.</span><span style=color:#06b6ef>handler</span><span style=color:#5bc4bf>.</span><span style=color:#06b6ef>codec</span><span style=color:#5bc4bf>.</span><span style=color:#06b6ef>http</span><span style=color:#5bc4bf>.</span><span style=color:#06b6ef>cookie</span><span style=color:#5bc4bf>.</span><span style=color:#06b6ef>Cookie</span><span style=color:#5bc4bf>&gt;</span> nettyCookies <span style=color:#5bc4bf>=</span> ServerCookieDecoder<span style=color:#5bc4bf>.</span><span style=color:#06b6ef>LAX</span><span style=color:#5bc4bf>.</span><span style=color:#06b6ef>decode</span><span style=color:#5bc4bf>(</span>cookieOriginStr<span style=color:#5bc4bf>);</span>
</span></span><span style=display:flex><span>    <span style=color:#815ba4>if</span> <span style=color:#5bc4bf>(</span>nettyCookies<span style=color:#5bc4bf>.</span><span style=color:#06b6ef>size</span><span style=color:#5bc4bf>()</span> <span style=color:#5bc4bf>==</span> 0<span style=color:#5bc4bf>)</span> <span style=color:#5bc4bf>{</span>
</span></span><span style=display:flex><span>        <span style=color:#815ba4>return</span><span style=color:#5bc4bf>;</span>
</span></span><span style=display:flex><span>    <span style=color:#5bc4bf>}</span>
</span></span><span style=display:flex><span>    <span style=color:#815ba4>this</span><span style=color:#5bc4bf>.</span><span style=color:#06b6ef>cookies</span> <span style=color:#5bc4bf>=</span> <span style=color:#815ba4>new</span> Cookie<span style=color:#5bc4bf>[</span>nettyCookies<span style=color:#5bc4bf>.</span><span style=color:#06b6ef>size</span><span style=color:#5bc4bf>()];</span>
</span></span><span style=display:flex><span>    Iterator<span style=color:#5bc4bf>&lt;</span>io<span style=color:#5bc4bf>.</span><span style=color:#06b6ef>netty</span><span style=color:#5bc4bf>.</span><span style=color:#06b6ef>handler</span><span style=color:#5bc4bf>.</span><span style=color:#06b6ef>codec</span><span style=color:#5bc4bf>.</span><span style=color:#06b6ef>http</span><span style=color:#5bc4bf>.</span><span style=color:#06b6ef>cookie</span><span style=color:#5bc4bf>.</span><span style=color:#06b6ef>Cookie</span><span style=color:#5bc4bf>&gt;</span> itr <span style=color:#5bc4bf>=</span> nettyCookies<span style=color:#5bc4bf>.</span><span style=color:#06b6ef>iterator</span><span style=color:#5bc4bf>();</span>
</span></span><span style=display:flex><span>    <span style=color:#fec418>int</span> i <span style=color:#5bc4bf>=</span> 0<span style=color:#5bc4bf>;</span>
</span></span><span style=display:flex><span>    <span style=color:#815ba4>while</span> <span style=color:#5bc4bf>(</span>itr<span style=color:#5bc4bf>.</span><span style=color:#06b6ef>hasNext</span><span style=color:#5bc4bf>())</span> <span style=color:#5bc4bf>{</span>
</span></span><span style=display:flex><span>        io<span style=color:#5bc4bf>.</span><span style=color:#06b6ef>netty</span><span style=color:#5bc4bf>.</span><span style=color:#06b6ef>handler</span><span style=color:#5bc4bf>.</span><span style=color:#06b6ef>codec</span><span style=color:#5bc4bf>.</span><span style=color:#06b6ef>http</span><span style=color:#5bc4bf>.</span><span style=color:#06b6ef>cookie</span><span style=color:#5bc4bf>.</span><span style=color:#06b6ef>Cookie</span> nettyCookie <span style=color:#5bc4bf>=</span> itr<span style=color:#5bc4bf>.</span><span style=color:#06b6ef>next</span><span style=color:#5bc4bf>();</span>
</span></span><span style=display:flex><span>        Cookie servletCookie <span style=color:#5bc4bf>=</span> <span style=color:#815ba4>new</span> Cookie<span style=color:#5bc4bf>(</span>nettyCookie<span style=color:#5bc4bf>.</span><span style=color:#06b6ef>name</span><span style=color:#5bc4bf>(),</span> nettyCookie<span style=color:#5bc4bf>.</span><span style=color:#06b6ef>value</span><span style=color:#5bc4bf>());</span>
</span></span><span style=display:flex><span><span style=color:#776e71>//            servletCookie.setMaxAge(Ints.checkedCast(nettyCookie.maxAge()));
</span></span></span><span style=display:flex><span><span style=color:#776e71></span>        <span style=color:#815ba4>if</span><span style=color:#5bc4bf>(</span>nettyCookie<span style=color:#5bc4bf>.</span><span style=color:#06b6ef>domain</span><span style=color:#5bc4bf>()</span> <span style=color:#5bc4bf>!=</span> <span style=color:#815ba4>null</span><span style=color:#5bc4bf>)</span> servletCookie<span style=color:#5bc4bf>.</span><span style=color:#06b6ef>setDomain</span><span style=color:#5bc4bf>(</span>nettyCookie<span style=color:#5bc4bf>.</span><span style=color:#06b6ef>domain</span><span style=color:#5bc4bf>());</span>
</span></span><span style=display:flex><span>        <span style=color:#815ba4>if</span><span style=color:#5bc4bf>(</span>nettyCookie<span style=color:#5bc4bf>.</span><span style=color:#06b6ef>path</span><span style=color:#5bc4bf>()</span> <span style=color:#5bc4bf>!=</span> <span style=color:#815ba4>null</span><span style=color:#5bc4bf>)</span> servletCookie<span style=color:#5bc4bf>.</span><span style=color:#06b6ef>setPath</span><span style=color:#5bc4bf>(</span>nettyCookie<span style=color:#5bc4bf>.</span><span style=color:#06b6ef>path</span><span style=color:#5bc4bf>());</span>
</span></span><span style=display:flex><span>        servletCookie<span style=color:#5bc4bf>.</span><span style=color:#06b6ef>setHttpOnly</span><span style=color:#5bc4bf>(</span>nettyCookie<span style=color:#5bc4bf>.</span><span style=color:#06b6ef>isHttpOnly</span><span style=color:#5bc4bf>());</span>
</span></span><span style=display:flex><span>        <span style=color:#815ba4>this</span><span style=color:#5bc4bf>.</span><span style=color:#06b6ef>cookies</span><span style=color:#5bc4bf>[</span>i<span style=color:#5bc4bf>++]</span> <span style=color:#5bc4bf>=</span> servletCookie<span style=color:#5bc4bf>;</span>
</span></span><span style=display:flex><span>    <span style=color:#5bc4bf>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#815ba4>this</span><span style=color:#5bc4bf>.</span><span style=color:#06b6ef>isCookieParsed</span> <span style=color:#5bc4bf>=</span> <span style=color:#815ba4>true</span><span style=color:#5bc4bf>;</span>
</span></span><span style=display:flex><span><span style=color:#5bc4bf>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#776e71>/*====== Cookie 相关方法 结束 ======*/</span>
</span></span></code></pre></div><h3 id=header相关方法>Header相关方法</h3><p>上面提到<code>NettyHttpServletRequest</code>的构造方法传入了netty的<code>HttpHeaders</code>实例，可以从中获取所有请求头，而Header相关方法的实现就靠他了：</p><div class=highlight><pre tabindex=0 style=color:#e7e9db;background-color:#2f1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#776e71>/*====== Header 相关方法 开始 ======*/</span>
</span></span><span style=display:flex><span><span style=color:#815ba4>private</span> HttpHeaders headers<span style=color:#5bc4bf>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#5bc4bf>@Override</span>
</span></span><span style=display:flex><span><span style=color:#815ba4>public</span> <span style=color:#fec418>long</span> <span style=color:#06b6ef>getDateHeader</span><span style=color:#5bc4bf>(</span>String name<span style=color:#5bc4bf>)</span> <span style=color:#5bc4bf>{</span>
</span></span><span style=display:flex><span>    <span style=color:#815ba4>return</span> <span style=color:#815ba4>this</span><span style=color:#5bc4bf>.</span><span style=color:#06b6ef>headers</span><span style=color:#5bc4bf>.</span><span style=color:#06b6ef>getTimeMillis</span><span style=color:#5bc4bf>(</span>name<span style=color:#5bc4bf>);</span>
</span></span><span style=display:flex><span><span style=color:#5bc4bf>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#5bc4bf>@Override</span>
</span></span><span style=display:flex><span><span style=color:#815ba4>public</span> String <span style=color:#06b6ef>getHeader</span><span style=color:#5bc4bf>(</span>String name<span style=color:#5bc4bf>)</span> <span style=color:#5bc4bf>{</span>
</span></span><span style=display:flex><span>    <span style=color:#815ba4>return</span> <span style=color:#815ba4>this</span><span style=color:#5bc4bf>.</span><span style=color:#06b6ef>headers</span><span style=color:#5bc4bf>.</span><span style=color:#06b6ef>get</span><span style=color:#5bc4bf>(</span>name<span style=color:#5bc4bf>);</span>
</span></span><span style=display:flex><span><span style=color:#5bc4bf>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#5bc4bf>@Override</span>
</span></span><span style=display:flex><span><span style=color:#815ba4>public</span> Enumeration<span style=color:#5bc4bf>&lt;</span>String<span style=color:#5bc4bf>&gt;</span> <span style=color:#06b6ef>getHeaders</span><span style=color:#5bc4bf>(</span>String name<span style=color:#5bc4bf>)</span> <span style=color:#5bc4bf>{</span>
</span></span><span style=display:flex><span>    <span style=color:#815ba4>return</span> Collections<span style=color:#5bc4bf>.</span><span style=color:#06b6ef>enumeration</span><span style=color:#5bc4bf>(</span><span style=color:#815ba4>this</span><span style=color:#5bc4bf>.</span><span style=color:#06b6ef>headers</span><span style=color:#5bc4bf>.</span><span style=color:#06b6ef>getAll</span><span style=color:#5bc4bf>(</span>name<span style=color:#5bc4bf>));</span>
</span></span><span style=display:flex><span><span style=color:#5bc4bf>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#5bc4bf>@Override</span>
</span></span><span style=display:flex><span><span style=color:#815ba4>public</span> Enumeration<span style=color:#5bc4bf>&lt;</span>String<span style=color:#5bc4bf>&gt;</span> <span style=color:#06b6ef>getHeaderNames</span><span style=color:#5bc4bf>()</span> <span style=color:#5bc4bf>{</span>
</span></span><span style=display:flex><span>    <span style=color:#815ba4>return</span> Collections<span style=color:#5bc4bf>.</span><span style=color:#06b6ef>enumeration</span><span style=color:#5bc4bf>(</span><span style=color:#815ba4>this</span><span style=color:#5bc4bf>.</span><span style=color:#06b6ef>headers</span><span style=color:#5bc4bf>.</span><span style=color:#06b6ef>names</span><span style=color:#5bc4bf>());</span>
</span></span><span style=display:flex><span><span style=color:#5bc4bf>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#5bc4bf>@Override</span>
</span></span><span style=display:flex><span><span style=color:#815ba4>public</span> <span style=color:#fec418>int</span> <span style=color:#06b6ef>getIntHeader</span><span style=color:#5bc4bf>(</span>String name<span style=color:#5bc4bf>)</span> <span style=color:#5bc4bf>{</span>
</span></span><span style=display:flex><span>    String headerStringValue <span style=color:#5bc4bf>=</span> <span style=color:#815ba4>this</span><span style=color:#5bc4bf>.</span><span style=color:#06b6ef>headers</span><span style=color:#5bc4bf>.</span><span style=color:#06b6ef>get</span><span style=color:#5bc4bf>(</span>name<span style=color:#5bc4bf>);</span>
</span></span><span style=display:flex><span>    <span style=color:#815ba4>if</span> <span style=color:#5bc4bf>(</span>headerStringValue <span style=color:#5bc4bf>==</span> <span style=color:#815ba4>null</span><span style=color:#5bc4bf>)</span> <span style=color:#5bc4bf>{</span>
</span></span><span style=display:flex><span>        <span style=color:#815ba4>return</span> <span style=color:#5bc4bf>-</span>1<span style=color:#5bc4bf>;</span>
</span></span><span style=display:flex><span>    <span style=color:#5bc4bf>}</span>
</span></span><span style=display:flex><span>    <span style=color:#815ba4>return</span> Integer<span style=color:#5bc4bf>.</span><span style=color:#06b6ef>parseInt</span><span style=color:#5bc4bf>(</span>headerStringValue<span style=color:#5bc4bf>);</span>
</span></span><span style=display:flex><span><span style=color:#5bc4bf>}</span>
</span></span><span style=display:flex><span><span style=color:#776e71>/*====== Header 相关方法 结束 ======*/</span>
</span></span></code></pre></div><h3 id=session相关方法>Session相关方法</h3><p>Session相关方法相对多一些。Session的解析分两种，首先尝试从Cookie中获取Cookie（名为JSESSIONID），如果没有，则从请求路径中找类似";jsessionid=*******&ldquo;的参数作为SessionID。拿到SessionID后，再调用SessionManager的方法获取Session对象；而根据从哪里解析到的SessionID可以设置<code>isCookieSession</code>和<code>isURLSession</code>两个属性，用于<code>isRequestedSessionIdFromCookie()</code>和<code>isRequestedSessionIdFromURL()</code>方法。如果拿不到SessionID，则调用SessionManager的方法创建一个新Session。<br>至于Session和SessionManager的实现我们在下一小节再讲，值得注意的是，<code>getSession()</code>方法返回的并不是我们定义的Session类实例，而是其门面类，是出于安全的考虑；这一点参考了Tomcat的做法（Tomcat的Request、Response、Session等对象都是用门面模式）。</p><div class=highlight><pre tabindex=0 style=color:#e7e9db;background-color:#2f1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#815ba4>private</span> NettyHttpSession session<span style=color:#5bc4bf>;</span>
</span></span><span style=display:flex><span><span style=color:#815ba4>private</span> <span style=color:#fec418>boolean</span> isCookieSession<span style=color:#5bc4bf>;</span>
</span></span><span style=display:flex><span><span style=color:#815ba4>private</span> <span style=color:#fec418>boolean</span> isURLSession<span style=color:#5bc4bf>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#776e71>/**
</span></span></span><span style=display:flex><span><span style=color:#776e71> * 先后看请求路径和Cookie中是否有sessionid
</span></span></span><span style=display:flex><span><span style=color:#776e71> * 有，则从SessionManager获取session对象放入session属性
</span></span></span><span style=display:flex><span><span style=color:#776e71> * 如果session对象过期，则创建一个新的并放入
</span></span></span><span style=display:flex><span><span style=color:#776e71> * 无，则创建一个新Session并放入
</span></span></span><span style=display:flex><span><span style=color:#776e71> */</span>
</span></span><span style=display:flex><span><span style=color:#815ba4>private</span> <span style=color:#fec418>void</span> <span style=color:#06b6ef>parseSession</span><span style=color:#5bc4bf>()</span> <span style=color:#5bc4bf>{</span>
</span></span><span style=display:flex><span>    String sessionId<span style=color:#5bc4bf>;</span>
</span></span><span style=display:flex><span>    NettyHttpSession curSession<span style=color:#5bc4bf>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#776e71>//从Cookie解析SessionID
</span></span></span><span style=display:flex><span><span style=color:#776e71></span>    sessionId <span style=color:#5bc4bf>=</span> getSessionIdFromCookie<span style=color:#5bc4bf>();</span>
</span></span><span style=display:flex><span>    <span style=color:#815ba4>if</span><span style=color:#5bc4bf>(</span>sessionId <span style=color:#5bc4bf>!=</span> <span style=color:#815ba4>null</span><span style=color:#5bc4bf>){</span>
</span></span><span style=display:flex><span>        curSession <span style=color:#5bc4bf>=</span> servletContext<span style=color:#5bc4bf>.</span><span style=color:#06b6ef>getSessionManager</span><span style=color:#5bc4bf>().</span><span style=color:#06b6ef>getSession</span><span style=color:#5bc4bf>(</span>sessionId<span style=color:#5bc4bf>);</span>
</span></span><span style=display:flex><span>        <span style=color:#815ba4>if</span> <span style=color:#5bc4bf>(</span><span style=color:#815ba4>null</span> <span style=color:#5bc4bf>!=</span> curSession<span style=color:#5bc4bf>)</span> <span style=color:#5bc4bf>{</span>
</span></span><span style=display:flex><span>            <span style=color:#815ba4>this</span><span style=color:#5bc4bf>.</span><span style=color:#06b6ef>isCookieSession</span> <span style=color:#5bc4bf>=</span> <span style=color:#815ba4>true</span><span style=color:#5bc4bf>;</span>
</span></span><span style=display:flex><span>            recoverySession<span style=color:#5bc4bf>(</span>curSession<span style=color:#5bc4bf>);</span>
</span></span><span style=display:flex><span>            <span style=color:#815ba4>return</span><span style=color:#5bc4bf>;</span>
</span></span><span style=display:flex><span>        <span style=color:#5bc4bf>}</span>
</span></span><span style=display:flex><span>    <span style=color:#5bc4bf>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#815ba4>if</span> <span style=color:#5bc4bf>(!</span><span style=color:#815ba4>this</span><span style=color:#5bc4bf>.</span><span style=color:#06b6ef>isCookieSession</span><span style=color:#5bc4bf>)</span> <span style=color:#5bc4bf>{</span>
</span></span><span style=display:flex><span>        <span style=color:#776e71>// 从请求路径解析SessionID
</span></span></span><span style=display:flex><span><span style=color:#776e71></span>        sessionId <span style=color:#5bc4bf>=</span> getSessionIdFromUrl<span style=color:#5bc4bf>();</span>
</span></span><span style=display:flex><span>        curSession <span style=color:#5bc4bf>=</span> servletContext<span style=color:#5bc4bf>.</span><span style=color:#06b6ef>getSessionManager</span><span style=color:#5bc4bf>().</span><span style=color:#06b6ef>getSession</span><span style=color:#5bc4bf>(</span>sessionId<span style=color:#5bc4bf>);</span>
</span></span><span style=display:flex><span>        <span style=color:#815ba4>if</span><span style=color:#5bc4bf>(</span><span style=color:#815ba4>null</span> <span style=color:#5bc4bf>!=</span> curSession<span style=color:#5bc4bf>){</span>
</span></span><span style=display:flex><span>            <span style=color:#815ba4>this</span><span style=color:#5bc4bf>.</span><span style=color:#06b6ef>isURLSession</span> <span style=color:#5bc4bf>=</span> <span style=color:#815ba4>true</span><span style=color:#5bc4bf>;</span>
</span></span><span style=display:flex><span>            recoverySession<span style=color:#5bc4bf>(</span>curSession<span style=color:#5bc4bf>);</span>
</span></span><span style=display:flex><span>            <span style=color:#815ba4>return</span><span style=color:#5bc4bf>;</span>
</span></span><span style=display:flex><span>        <span style=color:#5bc4bf>}</span>
</span></span><span style=display:flex><span>    <span style=color:#5bc4bf>}</span>
</span></span><span style=display:flex><span>    <span style=color:#776e71>//Cookie和请求参数中都没拿到Session，则创建一个
</span></span></span><span style=display:flex><span><span style=color:#776e71></span>    <span style=color:#815ba4>if</span> <span style=color:#5bc4bf>(</span><span style=color:#815ba4>this</span><span style=color:#5bc4bf>.</span><span style=color:#06b6ef>session</span> <span style=color:#5bc4bf>==</span> <span style=color:#815ba4>null</span><span style=color:#5bc4bf>)</span> <span style=color:#5bc4bf>{</span>
</span></span><span style=display:flex><span>        <span style=color:#815ba4>this</span><span style=color:#5bc4bf>.</span><span style=color:#06b6ef>session</span> <span style=color:#5bc4bf>=</span> createtSession<span style=color:#5bc4bf>();</span>
</span></span><span style=display:flex><span>    <span style=color:#5bc4bf>}</span>
</span></span><span style=display:flex><span><span style=color:#5bc4bf>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#776e71>/**
</span></span></span><span style=display:flex><span><span style=color:#776e71> * @return 从URL解析到的SessionID
</span></span></span><span style=display:flex><span><span style=color:#776e71> */</span>
</span></span><span style=display:flex><span><span style=color:#815ba4>private</span> String <span style=color:#06b6ef>getSessionIdFromUrl</span><span style=color:#5bc4bf>()</span> <span style=color:#5bc4bf>{</span>
</span></span><span style=display:flex><span>    StringBuilder u <span style=color:#5bc4bf>=</span> <span style=color:#815ba4>new</span> StringBuilder<span style=color:#5bc4bf>(</span>request<span style=color:#5bc4bf>.</span><span style=color:#06b6ef>uri</span><span style=color:#5bc4bf>());</span>
</span></span><span style=display:flex><span>    <span style=color:#fec418>int</span> sessionStart <span style=color:#5bc4bf>=</span> u<span style=color:#5bc4bf>.</span><span style=color:#06b6ef>toString</span><span style=color:#5bc4bf>().</span><span style=color:#06b6ef>indexOf</span><span style=color:#5bc4bf>(</span><span style=color:#48b685>&#34;;&#34;</span> <span style=color:#5bc4bf>+</span> NettyHttpSession<span style=color:#5bc4bf>.</span><span style=color:#06b6ef>SESSION_REQUEST_PARAMETER_NAME</span> <span style=color:#5bc4bf>+</span> <span style=color:#48b685>&#34;=&#34;</span><span style=color:#5bc4bf>);</span>
</span></span><span style=display:flex><span>    <span style=color:#815ba4>if</span><span style=color:#5bc4bf>(</span>sessionStart <span style=color:#5bc4bf>==</span> <span style=color:#5bc4bf>-</span>1<span style=color:#5bc4bf>)</span> <span style=color:#5bc4bf>{</span>
</span></span><span style=display:flex><span>        <span style=color:#815ba4>return</span> <span style=color:#815ba4>null</span><span style=color:#5bc4bf>;</span>
</span></span><span style=display:flex><span>    <span style=color:#5bc4bf>}</span>
</span></span><span style=display:flex><span>    <span style=color:#fec418>int</span> sessionEnd <span style=color:#5bc4bf>=</span> u<span style=color:#5bc4bf>.</span><span style=color:#06b6ef>toString</span><span style=color:#5bc4bf>().</span><span style=color:#06b6ef>indexOf</span><span style=color:#5bc4bf>(</span><span style=color:#48b685>&#39;;&#39;</span><span style=color:#5bc4bf>,</span> sessionStart <span style=color:#5bc4bf>+</span> 1<span style=color:#5bc4bf>);</span>
</span></span><span style=display:flex><span>    <span style=color:#815ba4>if</span> <span style=color:#5bc4bf>(</span>sessionEnd <span style=color:#5bc4bf>==</span> <span style=color:#5bc4bf>-</span>1<span style=color:#5bc4bf>)</span>
</span></span><span style=display:flex><span>        sessionEnd <span style=color:#5bc4bf>=</span> u<span style=color:#5bc4bf>.</span><span style=color:#06b6ef>toString</span><span style=color:#5bc4bf>().</span><span style=color:#06b6ef>indexOf</span><span style=color:#5bc4bf>(</span><span style=color:#48b685>&#39;?&#39;</span><span style=color:#5bc4bf>,</span> sessionStart <span style=color:#5bc4bf>+</span> 1<span style=color:#5bc4bf>);</span>
</span></span><span style=display:flex><span>    <span style=color:#815ba4>if</span> <span style=color:#5bc4bf>(</span>sessionEnd <span style=color:#5bc4bf>==</span> <span style=color:#5bc4bf>-</span>1<span style=color:#5bc4bf>)</span> <span style=color:#776e71>// still
</span></span></span><span style=display:flex><span><span style=color:#776e71></span>        sessionEnd <span style=color:#5bc4bf>=</span> u<span style=color:#5bc4bf>.</span><span style=color:#06b6ef>length</span><span style=color:#5bc4bf>();</span>
</span></span><span style=display:flex><span>    <span style=color:#815ba4>return</span> u<span style=color:#5bc4bf>.</span><span style=color:#06b6ef>substring</span><span style=color:#5bc4bf>(</span>sessionStart <span style=color:#5bc4bf>+</span> NettyHttpSession<span style=color:#5bc4bf>.</span><span style=color:#06b6ef>SESSION_REQUEST_PARAMETER_NAME</span><span style=color:#5bc4bf>.</span><span style=color:#06b6ef>length</span><span style=color:#5bc4bf>()</span> <span style=color:#5bc4bf>+</span> 2<span style=color:#5bc4bf>,</span> sessionEnd<span style=color:#5bc4bf>);</span>
</span></span><span style=display:flex><span><span style=color:#5bc4bf>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#776e71>/**
</span></span></span><span style=display:flex><span><span style=color:#776e71> * @return 从Cookie解析到的SessionID
</span></span></span><span style=display:flex><span><span style=color:#776e71> */</span>
</span></span><span style=display:flex><span><span style=color:#815ba4>private</span> String <span style=color:#06b6ef>getSessionIdFromCookie</span><span style=color:#5bc4bf>()</span> <span style=color:#5bc4bf>{</span>
</span></span><span style=display:flex><span>    Cookie<span style=color:#5bc4bf>[]</span> cookies <span style=color:#5bc4bf>=</span> getCookies<span style=color:#5bc4bf>();</span>
</span></span><span style=display:flex><span>    <span style=color:#815ba4>if</span><span style=color:#5bc4bf>(</span>cookies <span style=color:#5bc4bf>==</span> <span style=color:#815ba4>null</span><span style=color:#5bc4bf>){</span>
</span></span><span style=display:flex><span>        <span style=color:#815ba4>return</span> <span style=color:#815ba4>null</span><span style=color:#5bc4bf>;</span>
</span></span><span style=display:flex><span>    <span style=color:#5bc4bf>}</span>
</span></span><span style=display:flex><span>    <span style=color:#815ba4>for</span> <span style=color:#5bc4bf>(</span>Cookie cookie <span style=color:#5bc4bf>:</span> cookies<span style=color:#5bc4bf>)</span> <span style=color:#5bc4bf>{</span>
</span></span><span style=display:flex><span>        <span style=color:#815ba4>if</span> <span style=color:#5bc4bf>(</span>cookie<span style=color:#5bc4bf>.</span><span style=color:#06b6ef>getName</span><span style=color:#5bc4bf>().</span><span style=color:#06b6ef>equals</span><span style=color:#5bc4bf>(</span>NettyHttpSession<span style=color:#5bc4bf>.</span><span style=color:#06b6ef>SESSION_COOKIE_NAME</span><span style=color:#5bc4bf>))</span> <span style=color:#5bc4bf>{</span>
</span></span><span style=display:flex><span>            <span style=color:#815ba4>return</span> cookie<span style=color:#5bc4bf>.</span><span style=color:#06b6ef>getValue</span><span style=color:#5bc4bf>();</span>
</span></span><span style=display:flex><span>        <span style=color:#5bc4bf>}</span>
</span></span><span style=display:flex><span>    <span style=color:#5bc4bf>}</span>
</span></span><span style=display:flex><span>    <span style=color:#815ba4>return</span> <span style=color:#815ba4>null</span><span style=color:#5bc4bf>;</span>
</span></span><span style=display:flex><span><span style=color:#5bc4bf>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#776e71>/**
</span></span></span><span style=display:flex><span><span style=color:#776e71> * 恢复旧Session
</span></span></span><span style=display:flex><span><span style=color:#776e71> * @param curSession 要恢复的Session对象
</span></span></span><span style=display:flex><span><span style=color:#776e71> */</span>
</span></span><span style=display:flex><span><span style=color:#815ba4>private</span> <span style=color:#fec418>void</span> <span style=color:#06b6ef>recoverySession</span><span style=color:#5bc4bf>(</span>NettyHttpSession curSession<span style=color:#5bc4bf>)</span> <span style=color:#5bc4bf>{</span>
</span></span><span style=display:flex><span>    <span style=color:#815ba4>this</span><span style=color:#5bc4bf>.</span><span style=color:#06b6ef>session</span> <span style=color:#5bc4bf>=</span> curSession<span style=color:#5bc4bf>;</span>
</span></span><span style=display:flex><span>    <span style=color:#815ba4>this</span><span style=color:#5bc4bf>.</span><span style=color:#06b6ef>session</span><span style=color:#5bc4bf>.</span><span style=color:#06b6ef>setNew</span><span style=color:#5bc4bf>(</span><span style=color:#815ba4>false</span><span style=color:#5bc4bf>);</span>
</span></span><span style=display:flex><span>    <span style=color:#815ba4>this</span><span style=color:#5bc4bf>.</span><span style=color:#06b6ef>servletContext</span><span style=color:#5bc4bf>.</span><span style=color:#06b6ef>getSessionManager</span><span style=color:#5bc4bf>().</span><span style=color:#06b6ef>updateAccessTime</span><span style=color:#5bc4bf>(</span><span style=color:#815ba4>this</span><span style=color:#5bc4bf>.</span><span style=color:#06b6ef>session</span><span style=color:#5bc4bf>);</span>
</span></span><span style=display:flex><span><span style=color:#5bc4bf>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#5bc4bf>@Override</span>
</span></span><span style=display:flex><span><span style=color:#815ba4>public</span> HttpSession <span style=color:#06b6ef>getSession</span><span style=color:#5bc4bf>(</span><span style=color:#fec418>boolean</span> create<span style=color:#5bc4bf>)</span> <span style=color:#5bc4bf>{</span>
</span></span><span style=display:flex><span>    <span style=color:#fec418>boolean</span> valid <span style=color:#5bc4bf>=</span> isRequestedSessionIdValid<span style=color:#5bc4bf>();</span> <span style=color:#776e71>//在管理器存在，且没到期
</span></span></span><span style=display:flex><span><span style=color:#776e71></span>    <span style=color:#776e71>//可用则直接返回
</span></span></span><span style=display:flex><span><span style=color:#776e71></span>    <span style=color:#815ba4>if</span> <span style=color:#5bc4bf>(</span>valid<span style=color:#5bc4bf>)</span> <span style=color:#5bc4bf>{</span>
</span></span><span style=display:flex><span>        <span style=color:#815ba4>return</span> session<span style=color:#5bc4bf>.</span><span style=color:#06b6ef>getSession</span><span style=color:#5bc4bf>();</span>
</span></span><span style=display:flex><span>    <span style=color:#5bc4bf>}</span>
</span></span><span style=display:flex><span>    <span style=color:#776e71>//不可用则判断是否新建
</span></span></span><span style=display:flex><span><span style=color:#776e71></span>    <span style=color:#815ba4>if</span> <span style=color:#5bc4bf>(!</span>create<span style=color:#5bc4bf>)</span> <span style=color:#5bc4bf>{</span>
</span></span><span style=display:flex><span>        session <span style=color:#5bc4bf>=</span> <span style=color:#815ba4>null</span><span style=color:#5bc4bf>;</span> <span style=color:#776e71>//如果过期了设为null
</span></span></span><span style=display:flex><span><span style=color:#776e71></span>        <span style=color:#815ba4>return</span> <span style=color:#815ba4>null</span><span style=color:#5bc4bf>;</span>
</span></span><span style=display:flex><span>    <span style=color:#5bc4bf>}</span>
</span></span><span style=display:flex><span>    <span style=color:#776e71>//不可用且允许新建则新建之
</span></span></span><span style=display:flex><span><span style=color:#776e71></span>    <span style=color:#815ba4>this</span><span style=color:#5bc4bf>.</span><span style=color:#06b6ef>session</span> <span style=color:#5bc4bf>=</span> createtSession<span style=color:#5bc4bf>();</span>
</span></span><span style=display:flex><span>    <span style=color:#815ba4>return</span> <span style=color:#815ba4>this</span><span style=color:#5bc4bf>.</span><span style=color:#06b6ef>session</span><span style=color:#5bc4bf>.</span><span style=color:#06b6ef>getSession</span><span style=color:#5bc4bf>();</span>
</span></span><span style=display:flex><span><span style=color:#5bc4bf>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#5bc4bf>@Override</span>
</span></span><span style=display:flex><span><span style=color:#815ba4>public</span> HttpSession <span style=color:#06b6ef>getSession</span><span style=color:#5bc4bf>()</span> <span style=color:#5bc4bf>{</span>
</span></span><span style=display:flex><span>    <span style=color:#815ba4>return</span> getSession<span style=color:#5bc4bf>(</span><span style=color:#815ba4>true</span><span style=color:#5bc4bf>);</span>
</span></span><span style=display:flex><span><span style=color:#5bc4bf>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#5bc4bf>@Override</span>
</span></span><span style=display:flex><span><span style=color:#815ba4>public</span> String <span style=color:#06b6ef>changeSessionId</span><span style=color:#5bc4bf>()</span> <span style=color:#5bc4bf>{</span>
</span></span><span style=display:flex><span>    <span style=color:#815ba4>this</span><span style=color:#5bc4bf>.</span><span style=color:#06b6ef>session</span> <span style=color:#5bc4bf>=</span> createtSession<span style=color:#5bc4bf>();</span>
</span></span><span style=display:flex><span>    <span style=color:#815ba4>return</span> <span style=color:#815ba4>this</span><span style=color:#5bc4bf>.</span><span style=color:#06b6ef>session</span><span style=color:#5bc4bf>.</span><span style=color:#06b6ef>getId</span><span style=color:#5bc4bf>();</span>
</span></span><span style=display:flex><span><span style=color:#5bc4bf>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#815ba4>private</span> NettyHttpSession <span style=color:#06b6ef>createtSession</span><span style=color:#5bc4bf>()</span> <span style=color:#5bc4bf>{</span>
</span></span><span style=display:flex><span>    <span style=color:#815ba4>return</span> servletContext<span style=color:#5bc4bf>.</span><span style=color:#06b6ef>getSessionManager</span><span style=color:#5bc4bf>().</span><span style=color:#06b6ef>createSession</span><span style=color:#5bc4bf>();</span>
</span></span><span style=display:flex><span><span style=color:#5bc4bf>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#5bc4bf>@Override</span>
</span></span><span style=display:flex><span><span style=color:#815ba4>public</span> <span style=color:#fec418>boolean</span> <span style=color:#06b6ef>isRequestedSessionIdValid</span><span style=color:#5bc4bf>()</span> <span style=color:#5bc4bf>{</span>
</span></span><span style=display:flex><span>    <span style=color:#815ba4>return</span> servletContext<span style=color:#5bc4bf>.</span><span style=color:#06b6ef>getSessionManager</span><span style=color:#5bc4bf>().</span><span style=color:#06b6ef>checkValid</span><span style=color:#5bc4bf>(</span>session<span style=color:#5bc4bf>);</span>
</span></span><span style=display:flex><span><span style=color:#5bc4bf>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#5bc4bf>@Override</span>
</span></span><span style=display:flex><span><span style=color:#815ba4>public</span> <span style=color:#fec418>boolean</span> <span style=color:#06b6ef>isRequestedSessionIdFromCookie</span><span style=color:#5bc4bf>()</span> <span style=color:#5bc4bf>{</span>
</span></span><span style=display:flex><span>    <span style=color:#815ba4>return</span> isCookieSession<span style=color:#5bc4bf>;</span>
</span></span><span style=display:flex><span><span style=color:#5bc4bf>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#5bc4bf>@Override</span>
</span></span><span style=display:flex><span><span style=color:#815ba4>public</span> <span style=color:#fec418>boolean</span> <span style=color:#06b6ef>isRequestedSessionIdFromURL</span><span style=color:#5bc4bf>()</span> <span style=color:#5bc4bf>{</span>
</span></span><span style=display:flex><span>    <span style=color:#815ba4>return</span> isURLSession<span style=color:#5bc4bf>;</span>
</span></span><span style=display:flex><span><span style=color:#5bc4bf>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#5bc4bf>@Override</span>
</span></span><span style=display:flex><span><span style=color:#5bc4bf>@Deprecated</span>
</span></span><span style=display:flex><span><span style=color:#815ba4>public</span> <span style=color:#fec418>boolean</span> <span style=color:#06b6ef>isRequestedSessionIdFromUrl</span><span style=color:#5bc4bf>()</span> <span style=color:#5bc4bf>{</span>
</span></span><span style=display:flex><span>    <span style=color:#815ba4>return</span> isRequestedSessionIdFromURL<span style=color:#5bc4bf>();</span>
</span></span><span style=display:flex><span><span style=color:#5bc4bf>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#5bc4bf>@Override</span>
</span></span><span style=display:flex><span><span style=color:#815ba4>public</span> String <span style=color:#06b6ef>getRequestedSessionId</span><span style=color:#5bc4bf>()</span> <span style=color:#5bc4bf>{</span>
</span></span><span style=display:flex><span>    <span style=color:#815ba4>return</span> session<span style=color:#5bc4bf>.</span><span style=color:#06b6ef>getId</span><span style=color:#5bc4bf>();</span>
</span></span><span style=display:flex><span><span style=color:#5bc4bf>}</span>
</span></span><span style=display:flex><span><span style=color:#776e71>/*====== Session 相关方法 结束 ======*/</span>
</span></span></code></pre></div><h2 id=httpservletresponse实现>HttpServletResponse实现</h2><p>HttpServletResponse接口相对简单一点，方法少一点，下面列举出部分方法的实现。</p><h3 id=header相关方法-1>Header相关方法</h3><p>这里的Header指响应头。<code>NettyHttpServletResponse</code>的构造方法里传入了netty的<code>HttpResponse</code>对象，默认的调用是传入一个200的正常HTTP响应。我们可以通过这个<code>HttpResponse</code>对象的<code>headers()</code>方法对响应头进行操作。具体代码如下：</p><div class=highlight><pre tabindex=0 style=color:#e7e9db;background-color:#2f1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#5bc4bf>@Override</span>
</span></span><span style=display:flex><span><span style=color:#815ba4>public</span> <span style=color:#fec418>void</span> <span style=color:#06b6ef>setDateHeader</span><span style=color:#5bc4bf>(</span>String name<span style=color:#5bc4bf>,</span> <span style=color:#fec418>long</span> date<span style=color:#5bc4bf>)</span> <span style=color:#5bc4bf>{</span>
</span></span><span style=display:flex><span>    response<span style=color:#5bc4bf>.</span><span style=color:#06b6ef>headers</span><span style=color:#5bc4bf>().</span><span style=color:#06b6ef>set</span><span style=color:#5bc4bf>(</span>name<span style=color:#5bc4bf>,</span> date<span style=color:#5bc4bf>);</span>
</span></span><span style=display:flex><span><span style=color:#5bc4bf>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#5bc4bf>@Override</span>
</span></span><span style=display:flex><span><span style=color:#815ba4>public</span> <span style=color:#fec418>void</span> <span style=color:#06b6ef>addDateHeader</span><span style=color:#5bc4bf>(</span>String name<span style=color:#5bc4bf>,</span> <span style=color:#fec418>long</span> date<span style=color:#5bc4bf>)</span> <span style=color:#5bc4bf>{</span>
</span></span><span style=display:flex><span>    response<span style=color:#5bc4bf>.</span><span style=color:#06b6ef>headers</span><span style=color:#5bc4bf>().</span><span style=color:#06b6ef>add</span><span style=color:#5bc4bf>(</span>name<span style=color:#5bc4bf>,</span> date<span style=color:#5bc4bf>);</span>
</span></span><span style=display:flex><span><span style=color:#5bc4bf>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#5bc4bf>@Override</span>
</span></span><span style=display:flex><span><span style=color:#815ba4>public</span> <span style=color:#fec418>void</span> <span style=color:#06b6ef>setHeader</span><span style=color:#5bc4bf>(</span>String name<span style=color:#5bc4bf>,</span> String value<span style=color:#5bc4bf>)</span> <span style=color:#5bc4bf>{</span>
</span></span><span style=display:flex><span>    <span style=color:#815ba4>if</span> <span style=color:#5bc4bf>(</span>name <span style=color:#5bc4bf>==</span> <span style=color:#815ba4>null</span> <span style=color:#5bc4bf>||</span> name<span style=color:#5bc4bf>.</span><span style=color:#06b6ef>length</span><span style=color:#5bc4bf>()</span> <span style=color:#5bc4bf>==</span> 0 <span style=color:#5bc4bf>||</span> value <span style=color:#5bc4bf>==</span> <span style=color:#815ba4>null</span><span style=color:#5bc4bf>)</span> <span style=color:#5bc4bf>{</span>
</span></span><span style=display:flex><span>        <span style=color:#815ba4>return</span><span style=color:#5bc4bf>;</span>
</span></span><span style=display:flex><span>    <span style=color:#5bc4bf>}</span>
</span></span><span style=display:flex><span>    <span style=color:#815ba4>if</span> <span style=color:#5bc4bf>(</span>isCommitted<span style=color:#5bc4bf>())</span> <span style=color:#5bc4bf>{</span>
</span></span><span style=display:flex><span>        <span style=color:#815ba4>return</span><span style=color:#5bc4bf>;</span>
</span></span><span style=display:flex><span>    <span style=color:#5bc4bf>}</span>
</span></span><span style=display:flex><span>    <span style=color:#815ba4>if</span> <span style=color:#5bc4bf>(</span>setHeaderField<span style=color:#5bc4bf>(</span>name<span style=color:#5bc4bf>,</span> value<span style=color:#5bc4bf>))</span> <span style=color:#5bc4bf>{</span>
</span></span><span style=display:flex><span>        <span style=color:#815ba4>return</span><span style=color:#5bc4bf>;</span>
</span></span><span style=display:flex><span>    <span style=color:#5bc4bf>}</span>
</span></span><span style=display:flex><span>    response<span style=color:#5bc4bf>.</span><span style=color:#06b6ef>headers</span><span style=color:#5bc4bf>().</span><span style=color:#06b6ef>set</span><span style=color:#5bc4bf>(</span>name<span style=color:#5bc4bf>,</span> value<span style=color:#5bc4bf>);</span>
</span></span><span style=display:flex><span><span style=color:#5bc4bf>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#815ba4>private</span> <span style=color:#fec418>boolean</span> <span style=color:#06b6ef>setHeaderField</span><span style=color:#5bc4bf>(</span>String name<span style=color:#5bc4bf>,</span> String value<span style=color:#5bc4bf>)</span> <span style=color:#5bc4bf>{</span>
</span></span><span style=display:flex><span>    <span style=color:#fec418>char</span> c <span style=color:#5bc4bf>=</span> name<span style=color:#5bc4bf>.</span><span style=color:#06b6ef>charAt</span><span style=color:#5bc4bf>(</span>0<span style=color:#5bc4bf>);</span><span style=color:#776e71>//减少判断的时间，提高效率
</span></span></span><span style=display:flex><span><span style=color:#776e71></span>    <span style=color:#815ba4>if</span> <span style=color:#5bc4bf>(</span><span style=color:#48b685>&#39;C&#39;</span> <span style=color:#5bc4bf>==</span> c <span style=color:#5bc4bf>||</span> <span style=color:#48b685>&#39;c&#39;</span> <span style=color:#5bc4bf>==</span> c<span style=color:#5bc4bf>)</span> <span style=color:#5bc4bf>{</span>
</span></span><span style=display:flex><span>        <span style=color:#815ba4>if</span> <span style=color:#5bc4bf>(</span>HttpHeaderNames<span style=color:#5bc4bf>.</span><span style=color:#06b6ef>CONTENT_TYPE</span><span style=color:#5bc4bf>.</span><span style=color:#06b6ef>contentEqualsIgnoreCase</span><span style=color:#5bc4bf>(</span>name<span style=color:#5bc4bf>))</span> <span style=color:#5bc4bf>{</span>
</span></span><span style=display:flex><span>            setContentType<span style=color:#5bc4bf>(</span>value<span style=color:#5bc4bf>);</span>
</span></span><span style=display:flex><span>            <span style=color:#815ba4>return</span> <span style=color:#815ba4>true</span><span style=color:#5bc4bf>;</span>
</span></span><span style=display:flex><span>        <span style=color:#5bc4bf>}</span>
</span></span><span style=display:flex><span>    <span style=color:#5bc4bf>}</span>
</span></span><span style=display:flex><span>    <span style=color:#815ba4>return</span> <span style=color:#815ba4>false</span><span style=color:#5bc4bf>;</span>
</span></span><span style=display:flex><span><span style=color:#5bc4bf>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#5bc4bf>@Override</span>
</span></span><span style=display:flex><span><span style=color:#815ba4>public</span> <span style=color:#fec418>void</span> <span style=color:#06b6ef>addHeader</span><span style=color:#5bc4bf>(</span>String name<span style=color:#5bc4bf>,</span> String value<span style=color:#5bc4bf>)</span> <span style=color:#5bc4bf>{</span>
</span></span><span style=display:flex><span>    <span style=color:#815ba4>if</span> <span style=color:#5bc4bf>(</span>name <span style=color:#5bc4bf>==</span> <span style=color:#815ba4>null</span> <span style=color:#5bc4bf>||</span> name<span style=color:#5bc4bf>.</span><span style=color:#06b6ef>length</span><span style=color:#5bc4bf>()</span> <span style=color:#5bc4bf>==</span> 0 <span style=color:#5bc4bf>||</span> value <span style=color:#5bc4bf>==</span> <span style=color:#815ba4>null</span><span style=color:#5bc4bf>)</span> <span style=color:#5bc4bf>{</span>
</span></span><span style=display:flex><span>        <span style=color:#815ba4>return</span><span style=color:#5bc4bf>;</span>
</span></span><span style=display:flex><span>    <span style=color:#5bc4bf>}</span>
</span></span><span style=display:flex><span>    <span style=color:#815ba4>if</span> <span style=color:#5bc4bf>(</span>isCommitted<span style=color:#5bc4bf>())</span> <span style=color:#5bc4bf>{</span>
</span></span><span style=display:flex><span>        <span style=color:#815ba4>return</span><span style=color:#5bc4bf>;</span>
</span></span><span style=display:flex><span>    <span style=color:#5bc4bf>}</span>
</span></span><span style=display:flex><span>    <span style=color:#815ba4>if</span> <span style=color:#5bc4bf>(</span>setHeaderField<span style=color:#5bc4bf>(</span>name<span style=color:#5bc4bf>,</span> value<span style=color:#5bc4bf>))</span> <span style=color:#5bc4bf>{</span>
</span></span><span style=display:flex><span>        <span style=color:#815ba4>return</span><span style=color:#5bc4bf>;</span>
</span></span><span style=display:flex><span>    <span style=color:#5bc4bf>}</span>
</span></span><span style=display:flex><span>    response<span style=color:#5bc4bf>.</span><span style=color:#06b6ef>headers</span><span style=color:#5bc4bf>().</span><span style=color:#06b6ef>add</span><span style=color:#5bc4bf>(</span>name<span style=color:#5bc4bf>,</span> value<span style=color:#5bc4bf>);</span>
</span></span><span style=display:flex><span><span style=color:#5bc4bf>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#5bc4bf>@Override</span>
</span></span><span style=display:flex><span><span style=color:#815ba4>public</span> <span style=color:#fec418>void</span> <span style=color:#06b6ef>setIntHeader</span><span style=color:#5bc4bf>(</span>String name<span style=color:#5bc4bf>,</span> <span style=color:#fec418>int</span> value<span style=color:#5bc4bf>)</span> <span style=color:#5bc4bf>{</span>
</span></span><span style=display:flex><span>    <span style=color:#815ba4>if</span> <span style=color:#5bc4bf>(</span>name <span style=color:#5bc4bf>==</span> <span style=color:#815ba4>null</span> <span style=color:#5bc4bf>||</span> name<span style=color:#5bc4bf>.</span><span style=color:#06b6ef>length</span><span style=color:#5bc4bf>()</span> <span style=color:#5bc4bf>==</span> 0<span style=color:#5bc4bf>)</span> <span style=color:#5bc4bf>{</span>
</span></span><span style=display:flex><span>        <span style=color:#815ba4>return</span><span style=color:#5bc4bf>;</span>
</span></span><span style=display:flex><span>    <span style=color:#5bc4bf>}</span>
</span></span><span style=display:flex><span>    <span style=color:#815ba4>if</span> <span style=color:#5bc4bf>(</span>isCommitted<span style=color:#5bc4bf>())</span> <span style=color:#5bc4bf>{</span>
</span></span><span style=display:flex><span>        <span style=color:#815ba4>return</span><span style=color:#5bc4bf>;</span>
</span></span><span style=display:flex><span>    <span style=color:#5bc4bf>}</span>
</span></span><span style=display:flex><span>    response<span style=color:#5bc4bf>.</span><span style=color:#06b6ef>headers</span><span style=color:#5bc4bf>().</span><span style=color:#06b6ef>set</span><span style=color:#5bc4bf>(</span>name<span style=color:#5bc4bf>,</span> value<span style=color:#5bc4bf>);</span>
</span></span><span style=display:flex><span><span style=color:#5bc4bf>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span><span style=color:#5bc4bf>@Override</span>
</span></span><span style=display:flex><span><span style=color:#815ba4>public</span> <span style=color:#fec418>void</span> <span style=color:#06b6ef>addIntHeader</span><span style=color:#5bc4bf>(</span>String name<span style=color:#5bc4bf>,</span> <span style=color:#fec418>int</span> value<span style=color:#5bc4bf>)</span> <span style=color:#5bc4bf>{</span>
</span></span><span style=display:flex><span>    <span style=color:#815ba4>if</span> <span style=color:#5bc4bf>(</span>name <span style=color:#5bc4bf>==</span> <span style=color:#815ba4>null</span> <span style=color:#5bc4bf>||</span> name<span style=color:#5bc4bf>.</span><span style=color:#06b6ef>length</span><span style=color:#5bc4bf>()</span> <span style=color:#5bc4bf>==</span> 0<span style=color:#5bc4bf>)</span> <span style=color:#5bc4bf>{</span>
</span></span><span style=display:flex><span>        <span style=color:#815ba4>return</span><span style=color:#5bc4bf>;</span>
</span></span><span style=display:flex><span>    <span style=color:#5bc4bf>}</span>
</span></span><span style=display:flex><span>    <span style=color:#815ba4>if</span> <span style=color:#5bc4bf>(</span>isCommitted<span style=color:#5bc4bf>())</span> <span style=color:#5bc4bf>{</span>
</span></span><span style=display:flex><span>        <span style=color:#815ba4>return</span><span style=color:#5bc4bf>;</span>
</span></span><span style=display:flex><span>    <span style=color:#5bc4bf>}</span>
</span></span><span style=display:flex><span>    response<span style=color:#5bc4bf>.</span><span style=color:#06b6ef>headers</span><span style=color:#5bc4bf>().</span><span style=color:#06b6ef>add</span><span style=color:#5bc4bf>(</span>name<span style=color:#5bc4bf>,</span> value<span style=color:#5bc4bf>);</span>
</span></span><span style=display:flex><span><span style=color:#5bc4bf>}</span>
</span></span></code></pre></div><h3 id=getnettyresponse方法>getNettyResponse()方法</h3><p>方法<code>public HttpResponse getNettyResponse()</code>是我们自己定义的，用于响应输出流在写入时做的一些基本处理，主要是请求头的处理，具体代码如下：</p><div class=highlight><pre tabindex=0 style=color:#e7e9db;background-color:#2f1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#776e71>/**
</span></span></span><span style=display:flex><span><span style=color:#776e71> * 设置基本的请求头
</span></span></span><span style=display:flex><span><span style=color:#776e71> */</span>
</span></span><span style=display:flex><span><span style=color:#815ba4>public</span> HttpResponse <span style=color:#06b6ef>getNettyResponse</span><span style=color:#5bc4bf>()</span> <span style=color:#5bc4bf>{</span>
</span></span><span style=display:flex><span>    <span style=color:#815ba4>if</span> <span style=color:#5bc4bf>(</span>committed<span style=color:#5bc4bf>)</span> <span style=color:#5bc4bf>{</span>
</span></span><span style=display:flex><span>        <span style=color:#815ba4>return</span> response<span style=color:#5bc4bf>;</span>
</span></span><span style=display:flex><span>    <span style=color:#5bc4bf>}</span>
</span></span><span style=display:flex><span>    committed <span style=color:#5bc4bf>=</span> <span style=color:#815ba4>true</span><span style=color:#5bc4bf>;</span>
</span></span><span style=display:flex><span>    HttpHeaders headers <span style=color:#5bc4bf>=</span> response<span style=color:#5bc4bf>.</span><span style=color:#06b6ef>headers</span><span style=color:#5bc4bf>();</span>
</span></span><span style=display:flex><span>    <span style=color:#815ba4>if</span> <span style=color:#5bc4bf>(</span><span style=color:#815ba4>null</span> <span style=color:#5bc4bf>!=</span> contentType<span style=color:#5bc4bf>)</span> <span style=color:#5bc4bf>{</span>
</span></span><span style=display:flex><span>        String value <span style=color:#5bc4bf>=</span> <span style=color:#815ba4>null</span> <span style=color:#5bc4bf>==</span> characterEncoding <span style=color:#5bc4bf>?</span> contentType <span style=color:#5bc4bf>:</span> contentType <span style=color:#5bc4bf>+</span> <span style=color:#48b685>&#34;; charset=&#34;</span> <span style=color:#5bc4bf>+</span> characterEncoding<span style=color:#5bc4bf>;</span> <span style=color:#776e71>//Content Type 响应头的内容
</span></span></span><span style=display:flex><span><span style=color:#776e71></span>        headers<span style=color:#5bc4bf>.</span><span style=color:#06b6ef>set</span><span style=color:#5bc4bf>(</span>HttpHeaderNames<span style=color:#5bc4bf>.</span><span style=color:#06b6ef>CONTENT_TYPE</span><span style=color:#5bc4bf>,</span> value<span style=color:#5bc4bf>);</span>
</span></span><span style=display:flex><span>    <span style=color:#5bc4bf>}</span>
</span></span><span style=display:flex><span>    CharSequence date <span style=color:#5bc4bf>=</span> getFormattedDate<span style=color:#5bc4bf>();</span>
</span></span><span style=display:flex><span>    headers<span style=color:#5bc4bf>.</span><span style=color:#06b6ef>set</span><span style=color:#5bc4bf>(</span>HttpHeaderNames<span style=color:#5bc4bf>.</span><span style=color:#06b6ef>DATE</span><span style=color:#5bc4bf>,</span> date<span style=color:#5bc4bf>);</span> <span style=color:#776e71>// 时间日期响应头
</span></span></span><span style=display:flex><span><span style=color:#776e71></span>    headers<span style=color:#5bc4bf>.</span><span style=color:#06b6ef>set</span><span style=color:#5bc4bf>(</span>HttpHeaderNames<span style=color:#5bc4bf>.</span><span style=color:#06b6ef>SERVER</span><span style=color:#5bc4bf>,</span> servletContext<span style=color:#5bc4bf>.</span><span style=color:#06b6ef>getServerInfo</span><span style=color:#5bc4bf>());</span> <span style=color:#776e71>//服务器信息响应头
</span></span></span><span style=display:flex><span><span style=color:#776e71></span>
</span></span><span style=display:flex><span>    <span style=color:#776e71>// cookies处理
</span></span></span><span style=display:flex><span><span style=color:#776e71>//        long curTime = System.currentTimeMillis(); //用于根据maxAge计算Cookie的Expires
</span></span></span><span style=display:flex><span><span style=color:#776e71></span>    <span style=color:#776e71>//先处理Session ，如果是新Session需要通过Cookie写入
</span></span></span><span style=display:flex><span><span style=color:#776e71></span>    <span style=color:#815ba4>if</span> <span style=color:#5bc4bf>(</span>request<span style=color:#5bc4bf>.</span><span style=color:#06b6ef>getSession</span><span style=color:#5bc4bf>().</span><span style=color:#06b6ef>isNew</span><span style=color:#5bc4bf>())</span> <span style=color:#5bc4bf>{</span>
</span></span><span style=display:flex><span>        String sessionCookieStr <span style=color:#5bc4bf>=</span> NettyHttpSession<span style=color:#5bc4bf>.</span><span style=color:#06b6ef>SESSION_COOKIE_NAME</span> <span style=color:#5bc4bf>+</span> <span style=color:#48b685>&#34;=&#34;</span> <span style=color:#5bc4bf>+</span> request<span style=color:#5bc4bf>.</span><span style=color:#06b6ef>getRequestedSessionId</span><span style=color:#5bc4bf>()</span> <span style=color:#5bc4bf>+</span> <span style=color:#48b685>&#34;; path=/; domain=&#34;</span> <span style=color:#5bc4bf>+</span> request<span style=color:#5bc4bf>.</span><span style=color:#06b6ef>getServerName</span><span style=color:#5bc4bf>();</span>
</span></span><span style=display:flex><span>        headers<span style=color:#5bc4bf>.</span><span style=color:#06b6ef>add</span><span style=color:#5bc4bf>(</span>HttpHeaderNames<span style=color:#5bc4bf>.</span><span style=color:#06b6ef>SET_COOKIE</span><span style=color:#5bc4bf>,</span> sessionCookieStr<span style=color:#5bc4bf>);</span>
</span></span><span style=display:flex><span>    <span style=color:#5bc4bf>}</span>
</span></span><span style=display:flex><span>    <span style=color:#776e71>//其他业务或框架设置的cookie，逐条写入到响应头去
</span></span></span><span style=display:flex><span><span style=color:#776e71></span>    <span style=color:#815ba4>for</span> <span style=color:#5bc4bf>(</span>Cookie cookie <span style=color:#5bc4bf>:</span> cookies<span style=color:#5bc4bf>)</span> <span style=color:#5bc4bf>{</span>
</span></span><span style=display:flex><span>        StringBuilder sb <span style=color:#5bc4bf>=</span> <span style=color:#815ba4>new</span> StringBuilder<span style=color:#5bc4bf>();</span>
</span></span><span style=display:flex><span>        sb<span style=color:#5bc4bf>.</span><span style=color:#06b6ef>append</span><span style=color:#5bc4bf>(</span>cookie<span style=color:#5bc4bf>.</span><span style=color:#06b6ef>getName</span><span style=color:#5bc4bf>()).</span><span style=color:#06b6ef>append</span><span style=color:#5bc4bf>(</span><span style=color:#48b685>&#34;=&#34;</span><span style=color:#5bc4bf>).</span><span style=color:#06b6ef>append</span><span style=color:#5bc4bf>(</span>cookie<span style=color:#5bc4bf>.</span><span style=color:#06b6ef>getValue</span><span style=color:#5bc4bf>())</span>
</span></span><span style=display:flex><span>                <span style=color:#5bc4bf>.</span><span style=color:#06b6ef>append</span><span style=color:#5bc4bf>(</span><span style=color:#48b685>&#34;; max-Age=&#34;</span><span style=color:#5bc4bf>).</span><span style=color:#06b6ef>append</span><span style=color:#5bc4bf>(</span>cookie<span style=color:#5bc4bf>.</span><span style=color:#06b6ef>getMaxAge</span><span style=color:#5bc4bf>());</span>
</span></span><span style=display:flex><span>        <span style=color:#815ba4>if</span> <span style=color:#5bc4bf>(</span>cookie<span style=color:#5bc4bf>.</span><span style=color:#06b6ef>getPath</span><span style=color:#5bc4bf>()</span> <span style=color:#5bc4bf>!=</span> <span style=color:#815ba4>null</span><span style=color:#5bc4bf>)</span> sb<span style=color:#5bc4bf>.</span><span style=color:#06b6ef>append</span><span style=color:#5bc4bf>(</span><span style=color:#48b685>&#34;; path=&#34;</span><span style=color:#5bc4bf>).</span><span style=color:#06b6ef>append</span><span style=color:#5bc4bf>(</span>cookie<span style=color:#5bc4bf>.</span><span style=color:#06b6ef>getPath</span><span style=color:#5bc4bf>());</span>
</span></span><span style=display:flex><span>        <span style=color:#815ba4>if</span> <span style=color:#5bc4bf>(</span>cookie<span style=color:#5bc4bf>.</span><span style=color:#06b6ef>getDomain</span><span style=color:#5bc4bf>()</span> <span style=color:#5bc4bf>!=</span> <span style=color:#815ba4>null</span><span style=color:#5bc4bf>)</span> sb<span style=color:#5bc4bf>.</span><span style=color:#06b6ef>append</span><span style=color:#5bc4bf>(</span><span style=color:#48b685>&#34;; domain=&#34;</span><span style=color:#5bc4bf>).</span><span style=color:#06b6ef>append</span><span style=color:#5bc4bf>(</span>cookie<span style=color:#5bc4bf>.</span><span style=color:#06b6ef>getDomain</span><span style=color:#5bc4bf>());</span>
</span></span><span style=display:flex><span>        headers<span style=color:#5bc4bf>.</span><span style=color:#06b6ef>add</span><span style=color:#5bc4bf>(</span>HttpHeaderNames<span style=color:#5bc4bf>.</span><span style=color:#06b6ef>SET_COOKIE</span><span style=color:#5bc4bf>,</span> sb<span style=color:#5bc4bf>.</span><span style=color:#06b6ef>toString</span><span style=color:#5bc4bf>());</span>
</span></span><span style=display:flex><span>    <span style=color:#5bc4bf>}</span>
</span></span><span style=display:flex><span>    <span style=color:#815ba4>return</span> response<span style=color:#5bc4bf>;</span>
</span></span><span style=display:flex><span><span style=color:#5bc4bf>}</span>
</span></span></code></pre></div><h2 id=session实现>Session实现</h2><p>Session相关的包括Session实现类<code>NettyHttpSession</code>，Sessionn门面包装类<code>NettyHttpSessionFacade</code>，以及Session管理器<code>NettySessionManager</code>。<br>门面类前面提及到了，构造的时候传入一个<code>NettyHttpSession</code>实例并持有，所有<code>HttpSession</code>接口的方法都调用<code>NettyHttpSession</code>实例的对应方法去处理。<br>Session管理器<code>NettySessionManager</code>是单例，由<code>NettyContext</code>实例持有，负责存储所有Session的映射，方便其他类根据SessionID去获取Session对象，提供创建新Session的方法，允许更新Session访问时间，同时定时清理过期的Session。<br>每个<code>NettyHttpSession</code>实例都持有<code>NettySessionManager</code>的引用，实现了<code>HttpSession</code>接口。</p><h3 id=nettyhttpsession>NettyHttpSession</h3><p>实现比较简单，Attribute由对象持有的HashMap进行存储，自身保存ID、创建时间、访问时间、生命周期等信息。
具体代码如下（部分过时的方法、简单的getter不列出）：</p><div class=highlight><pre tabindex=0 style=color:#e7e9db;background-color:#2f1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#815ba4>public</span> <span style=color:#815ba4>class</span> <span style=color:#fec418>NettyHttpSession</span> <span style=color:#815ba4>implements</span> HttpSession<span style=color:#5bc4bf>,</span> Serializable <span style=color:#5bc4bf>{</span>
</span></span><span style=display:flex><span>    <span style=color:#815ba4>public</span> <span style=color:#815ba4>static</span> <span style=color:#815ba4>final</span> String SESSION_COOKIE_NAME <span style=color:#5bc4bf>=</span> <span style=color:#48b685>&#34;JSESSIONID&#34;</span><span style=color:#5bc4bf>;</span>
</span></span><span style=display:flex><span>    <span style=color:#815ba4>public</span> <span style=color:#815ba4>static</span> <span style=color:#815ba4>final</span> String SESSION_REQUEST_PARAMETER_NAME <span style=color:#5bc4bf>=</span> <span style=color:#48b685>&#34;jsessionid&#34;</span><span style=color:#5bc4bf>;</span>
</span></span><span style=display:flex><span>    <span style=color:#815ba4>private</span> NettySessionManager manager<span style=color:#5bc4bf>;</span>
</span></span><span style=display:flex><span>    <span style=color:#815ba4>private</span> <span style=color:#fec418>long</span> creationTime<span style=color:#5bc4bf>;</span>
</span></span><span style=display:flex><span>    <span style=color:#815ba4>private</span> <span style=color:#fec418>long</span> lastAccessedTime<span style=color:#5bc4bf>;</span>
</span></span><span style=display:flex><span>    <span style=color:#815ba4>private</span> <span style=color:#fec418>int</span> interval <span style=color:#5bc4bf>=</span> NettySessionManager<span style=color:#5bc4bf>.</span><span style=color:#06b6ef>SESSION_LIFE_SECONDS</span><span style=color:#5bc4bf>;</span>
</span></span><span style=display:flex><span>    <span style=color:#815ba4>private</span> String id<span style=color:#5bc4bf>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    NettyHttpSession<span style=color:#5bc4bf>(</span>String id<span style=color:#5bc4bf>,</span> NettySessionManager manager<span style=color:#5bc4bf>){</span>
</span></span><span style=display:flex><span>        <span style=color:#fec418>long</span> curTime <span style=color:#5bc4bf>=</span> System<span style=color:#5bc4bf>.</span><span style=color:#06b6ef>currentTimeMillis</span><span style=color:#5bc4bf>();</span>
</span></span><span style=display:flex><span>        <span style=color:#815ba4>this</span><span style=color:#5bc4bf>.</span><span style=color:#06b6ef>creationTime</span> <span style=color:#5bc4bf>=</span> curTime<span style=color:#5bc4bf>;</span>
</span></span><span style=display:flex><span>        <span style=color:#815ba4>this</span><span style=color:#5bc4bf>.</span><span style=color:#06b6ef>lastAccessedTime</span> <span style=color:#5bc4bf>=</span> curTime<span style=color:#5bc4bf>;</span>
</span></span><span style=display:flex><span>        <span style=color:#815ba4>this</span><span style=color:#5bc4bf>.</span><span style=color:#06b6ef>id</span> <span style=color:#5bc4bf>=</span> id<span style=color:#5bc4bf>;</span>
</span></span><span style=display:flex><span>        <span style=color:#815ba4>this</span><span style=color:#5bc4bf>.</span><span style=color:#06b6ef>manager</span> <span style=color:#5bc4bf>=</span> manager<span style=color:#5bc4bf>;</span>
</span></span><span style=display:flex><span>        <span style=color:#815ba4>this</span><span style=color:#5bc4bf>.</span><span style=color:#06b6ef>sessionFacade</span> <span style=color:#5bc4bf>=</span> <span style=color:#815ba4>new</span> NettyHttpSessionFacade<span style=color:#5bc4bf>(</span><span style=color:#815ba4>this</span><span style=color:#5bc4bf>);</span>
</span></span><span style=display:flex><span>    <span style=color:#5bc4bf>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#815ba4>private</span> HttpSession sessionFacade<span style=color:#5bc4bf>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#815ba4>public</span> HttpSession <span style=color:#06b6ef>getSession</span><span style=color:#5bc4bf>(){</span>
</span></span><span style=display:flex><span>        <span style=color:#815ba4>return</span> sessionFacade<span style=color:#5bc4bf>;</span>
</span></span><span style=display:flex><span>    <span style=color:#5bc4bf>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#fec418>void</span> <span style=color:#06b6ef>updateAccessTime</span><span style=color:#5bc4bf>()</span> <span style=color:#5bc4bf>{</span>
</span></span><span style=display:flex><span>        lastAccessedTime <span style=color:#5bc4bf>=</span> System<span style=color:#5bc4bf>.</span><span style=color:#06b6ef>currentTimeMillis</span><span style=color:#5bc4bf>();</span>
</span></span><span style=display:flex><span>    <span style=color:#5bc4bf>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#5bc4bf>@Override</span>
</span></span><span style=display:flex><span>    <span style=color:#815ba4>public</span> <span style=color:#fec418>void</span> <span style=color:#06b6ef>setMaxInactiveInterval</span><span style=color:#5bc4bf>(</span><span style=color:#fec418>int</span> interval<span style=color:#5bc4bf>)</span> <span style=color:#5bc4bf>{</span>
</span></span><span style=display:flex><span>        <span style=color:#815ba4>this</span><span style=color:#5bc4bf>.</span><span style=color:#06b6ef>interval</span> <span style=color:#5bc4bf>=</span> interval<span style=color:#5bc4bf>;</span>
</span></span><span style=display:flex><span>    <span style=color:#5bc4bf>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#815ba4>private</span> Map<span style=color:#5bc4bf>&lt;</span>String<span style=color:#5bc4bf>,</span> Object<span style=color:#5bc4bf>&gt;</span> attributes <span style=color:#5bc4bf>=</span> <span style=color:#815ba4>new</span> ConcurrentHashMap<span style=color:#5bc4bf>&lt;&gt;();</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#5bc4bf>@Override</span>
</span></span><span style=display:flex><span>    <span style=color:#815ba4>public</span> Object <span style=color:#06b6ef>getAttribute</span><span style=color:#5bc4bf>(</span>String name<span style=color:#5bc4bf>)</span> <span style=color:#5bc4bf>{</span>
</span></span><span style=display:flex><span>        <span style=color:#815ba4>return</span> attributes<span style=color:#5bc4bf>.</span><span style=color:#06b6ef>get</span><span style=color:#5bc4bf>(</span>name<span style=color:#5bc4bf>);</span>
</span></span><span style=display:flex><span>    <span style=color:#5bc4bf>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#5bc4bf>@Override</span>
</span></span><span style=display:flex><span>    <span style=color:#815ba4>public</span> <span style=color:#fec418>void</span> <span style=color:#06b6ef>setAttribute</span><span style=color:#5bc4bf>(</span>String name<span style=color:#5bc4bf>,</span> Object value<span style=color:#5bc4bf>)</span> <span style=color:#5bc4bf>{</span>
</span></span><span style=display:flex><span>        attributes<span style=color:#5bc4bf>.</span><span style=color:#06b6ef>put</span><span style=color:#5bc4bf>(</span>name<span style=color:#5bc4bf>,</span> value<span style=color:#5bc4bf>);</span>
</span></span><span style=display:flex><span>    <span style=color:#5bc4bf>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#5bc4bf>@Override</span>
</span></span><span style=display:flex><span>    <span style=color:#815ba4>public</span> <span style=color:#fec418>void</span> <span style=color:#06b6ef>removeAttribute</span><span style=color:#5bc4bf>(</span>String name<span style=color:#5bc4bf>)</span> <span style=color:#5bc4bf>{</span>
</span></span><span style=display:flex><span>        attributes<span style=color:#5bc4bf>.</span><span style=color:#06b6ef>remove</span><span style=color:#5bc4bf>(</span>name<span style=color:#5bc4bf>);</span>
</span></span><span style=display:flex><span>    <span style=color:#5bc4bf>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#5bc4bf>@Override</span>
</span></span><span style=display:flex><span>    <span style=color:#815ba4>public</span> <span style=color:#fec418>void</span> <span style=color:#06b6ef>invalidate</span><span style=color:#5bc4bf>()</span> <span style=color:#5bc4bf>{</span>
</span></span><span style=display:flex><span>        attributes<span style=color:#5bc4bf>.</span><span style=color:#06b6ef>clear</span><span style=color:#5bc4bf>();</span>
</span></span><span style=display:flex><span>        attributes <span style=color:#5bc4bf>=</span> <span style=color:#815ba4>null</span><span style=color:#5bc4bf>;</span>
</span></span><span style=display:flex><span>        manager<span style=color:#5bc4bf>.</span><span style=color:#06b6ef>invalidate</span><span style=color:#5bc4bf>(</span><span style=color:#815ba4>this</span><span style=color:#5bc4bf>);</span>
</span></span><span style=display:flex><span>        manager <span style=color:#5bc4bf>=</span> <span style=color:#815ba4>null</span><span style=color:#5bc4bf>;</span>
</span></span><span style=display:flex><span>    <span style=color:#5bc4bf>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#815ba4>private</span> <span style=color:#fec418>boolean</span> isNew <span style=color:#5bc4bf>=</span> <span style=color:#815ba4>true</span><span style=color:#5bc4bf>;</span>
</span></span><span style=display:flex><span>    <span style=color:#5bc4bf>@Override</span>
</span></span><span style=display:flex><span>    <span style=color:#815ba4>public</span> <span style=color:#fec418>boolean</span> <span style=color:#06b6ef>isNew</span><span style=color:#5bc4bf>()</span> <span style=color:#5bc4bf>{</span>
</span></span><span style=display:flex><span>        <span style=color:#815ba4>return</span> isNew<span style=color:#5bc4bf>;</span>
</span></span><span style=display:flex><span>    <span style=color:#5bc4bf>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#815ba4>public</span> <span style=color:#fec418>void</span> <span style=color:#06b6ef>setNew</span><span style=color:#5bc4bf>(</span><span style=color:#fec418>boolean</span> isNew<span style=color:#5bc4bf>){</span>
</span></span><span style=display:flex><span>        <span style=color:#815ba4>this</span><span style=color:#5bc4bf>.</span><span style=color:#06b6ef>isNew</span> <span style=color:#5bc4bf>=</span> isNew<span style=color:#5bc4bf>;</span>
</span></span><span style=display:flex><span>    <span style=color:#5bc4bf>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#776e71>/**
</span></span></span><span style=display:flex><span><span style=color:#776e71>     * 是否过期
</span></span></span><span style=display:flex><span><span style=color:#776e71>     * @return
</span></span></span><span style=display:flex><span><span style=color:#776e71>     */</span>
</span></span><span style=display:flex><span>    <span style=color:#815ba4>public</span> <span style=color:#fec418>boolean</span> <span style=color:#06b6ef>expire</span><span style=color:#5bc4bf>(){</span>
</span></span><span style=display:flex><span>        <span style=color:#815ba4>return</span> System<span style=color:#5bc4bf>.</span><span style=color:#06b6ef>currentTimeMillis</span><span style=color:#5bc4bf>()</span> <span style=color:#5bc4bf>-</span> creationTime <span style=color:#5bc4bf>&gt;=</span> interval <span style=color:#5bc4bf>*</span> 1000<span style=color:#5bc4bf>;</span>
</span></span><span style=display:flex><span>    <span style=color:#5bc4bf>}</span>
</span></span><span style=display:flex><span><span style=color:#5bc4bf>}</span>
</span></span></code></pre></div><h3 id=nettysessionmanager>NettySessionManager</h3><p>Session管理器没有现成的接口，因为比较简单所以也没抽出接口，自己在实现的过程中根据需求写了一些public方法：</p><ul><li>使用ConcurrentHashMap存储所有Session。</li><li>在构造的同时开启一个线程，每隔<code>SESSION_LIFE_CHECK_INTER</code>毫秒扫描所有Session判断是否过期需要清除（有待优化，比如等待时间按最快过期的session的过期时间，或者记录预计下次需要处理的个数，减少遍历的数量）。</li><li>SessionID是6位随机数字+时间戳翻转。</li></ul><div class=highlight><pre tabindex=0 style=color:#e7e9db;background-color:#2f1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4><code class=language-java data-lang=java><span style=display:flex><span><span style=color:#815ba4>public</span> <span style=color:#815ba4>class</span> <span style=color:#fec418>NettySessionManager</span> <span style=color:#5bc4bf>{</span>
</span></span><span style=display:flex><span>    <span style=color:#815ba4>private</span> Logger log <span style=color:#5bc4bf>=</span> LoggerFactory<span style=color:#5bc4bf>.</span><span style=color:#06b6ef>getLogger</span><span style=color:#5bc4bf>(</span>getClass<span style=color:#5bc4bf>());</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#815ba4>private</span> NettyContext servletContext<span style=color:#5bc4bf>;</span>
</span></span><span style=display:flex><span>    <span style=color:#815ba4>private</span> Map<span style=color:#5bc4bf>&lt;</span>String<span style=color:#5bc4bf>,</span> NettyHttpSession<span style=color:#5bc4bf>&gt;</span> sessions <span style=color:#5bc4bf>=</span> <span style=color:#815ba4>new</span> ConcurrentHashMap<span style=color:#5bc4bf>&lt;&gt;();</span>
</span></span><span style=display:flex><span>    <span style=color:#815ba4>static</span> <span style=color:#815ba4>final</span> <span style=color:#fec418>int</span> SESSION_LIFE_SECONDS <span style=color:#5bc4bf>=</span> 60 <span style=color:#5bc4bf>*</span> 30<span style=color:#5bc4bf>;</span>
</span></span><span style=display:flex><span>    <span style=color:#815ba4>static</span> <span style=color:#815ba4>final</span> <span style=color:#fec418>int</span> SESSION_LIFE_MILLISECONDS <span style=color:#5bc4bf>=</span> SESSION_LIFE_SECONDS <span style=color:#5bc4bf>*</span> 1000<span style=color:#5bc4bf>;</span>
</span></span><span style=display:flex><span>    <span style=color:#815ba4>private</span> <span style=color:#815ba4>static</span> <span style=color:#815ba4>final</span> <span style=color:#fec418>int</span> SESSION_LIFE_CHECK_INTER <span style=color:#5bc4bf>=</span> 1000 <span style=color:#5bc4bf>*</span> 60<span style=color:#5bc4bf>;</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#815ba4>public</span> <span style=color:#06b6ef>NettySessionManager</span><span style=color:#5bc4bf>(</span>NettyContext servletContext<span style=color:#5bc4bf>){</span>
</span></span><span style=display:flex><span>        <span style=color:#815ba4>this</span><span style=color:#5bc4bf>.</span><span style=color:#06b6ef>servletContext</span> <span style=color:#5bc4bf>=</span> servletContext<span style=color:#5bc4bf>;</span>
</span></span><span style=display:flex><span>        <span style=color:#815ba4>new</span> Thread<span style=color:#5bc4bf>(</span><span style=color:#815ba4>new</span> checkInvalidSessions<span style=color:#5bc4bf>(),</span> <span style=color:#48b685>&#34;Session-Check&#34;</span><span style=color:#5bc4bf>).</span><span style=color:#06b6ef>start</span><span style=color:#5bc4bf>();</span>
</span></span><span style=display:flex><span>    <span style=color:#5bc4bf>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#fec418>void</span> <span style=color:#06b6ef>invalidate</span><span style=color:#5bc4bf>(</span>HttpSession session<span style=color:#5bc4bf>)</span> <span style=color:#5bc4bf>{</span>
</span></span><span style=display:flex><span>        sessions<span style=color:#5bc4bf>.</span><span style=color:#06b6ef>remove</span><span style=color:#5bc4bf>(</span>session<span style=color:#5bc4bf>.</span><span style=color:#06b6ef>getId</span><span style=color:#5bc4bf>());</span>
</span></span><span style=display:flex><span>    <span style=color:#5bc4bf>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#815ba4>public</span> <span style=color:#fec418>void</span> <span style=color:#06b6ef>updateAccessTime</span><span style=color:#5bc4bf>(</span>NettyHttpSession session<span style=color:#5bc4bf>){</span>
</span></span><span style=display:flex><span>        <span style=color:#815ba4>if</span><span style=color:#5bc4bf>(</span>session <span style=color:#5bc4bf>!=</span> <span style=color:#815ba4>null</span><span style=color:#5bc4bf>){</span>
</span></span><span style=display:flex><span>            session<span style=color:#5bc4bf>.</span><span style=color:#06b6ef>updateAccessTime</span><span style=color:#5bc4bf>();</span>
</span></span><span style=display:flex><span>        <span style=color:#5bc4bf>}</span>
</span></span><span style=display:flex><span>    <span style=color:#5bc4bf>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#815ba4>public</span> <span style=color:#fec418>boolean</span> <span style=color:#06b6ef>checkValid</span><span style=color:#5bc4bf>(</span>NettyHttpSession session<span style=color:#5bc4bf>)</span> <span style=color:#5bc4bf>{</span>
</span></span><span style=display:flex><span>        <span style=color:#815ba4>return</span> session <span style=color:#5bc4bf>!=</span> <span style=color:#815ba4>null</span> <span style=color:#5bc4bf>&amp;&amp;</span> sessions<span style=color:#5bc4bf>.</span><span style=color:#06b6ef>get</span><span style=color:#5bc4bf>(</span>session<span style=color:#5bc4bf>.</span><span style=color:#06b6ef>getId</span><span style=color:#5bc4bf>())</span> <span style=color:#5bc4bf>!=</span> <span style=color:#815ba4>null</span> <span style=color:#5bc4bf>&amp;&amp;</span> <span style=color:#5bc4bf>!</span>session<span style=color:#5bc4bf>.</span><span style=color:#06b6ef>expire</span><span style=color:#5bc4bf>();</span>
</span></span><span style=display:flex><span>    <span style=color:#5bc4bf>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#815ba4>public</span> NettyHttpSession <span style=color:#06b6ef>getSession</span><span style=color:#5bc4bf>(</span>String id<span style=color:#5bc4bf>){</span>
</span></span><span style=display:flex><span>        <span style=color:#815ba4>return</span> id <span style=color:#5bc4bf>==</span> <span style=color:#815ba4>null</span> <span style=color:#5bc4bf>?</span> <span style=color:#815ba4>null</span> <span style=color:#5bc4bf>:</span> sessions<span style=color:#5bc4bf>.</span><span style=color:#06b6ef>get</span><span style=color:#5bc4bf>(</span>id<span style=color:#5bc4bf>);</span>
</span></span><span style=display:flex><span>    <span style=color:#5bc4bf>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#815ba4>public</span> NettyHttpSession <span style=color:#06b6ef>createSession</span><span style=color:#5bc4bf>(){</span>
</span></span><span style=display:flex><span>        String id <span style=color:#5bc4bf>=</span> createUniqueSessionId<span style=color:#5bc4bf>();</span>
</span></span><span style=display:flex><span>        NettyHttpSession newSession <span style=color:#5bc4bf>=</span> <span style=color:#815ba4>new</span> NettyHttpSession<span style=color:#5bc4bf>(</span>id<span style=color:#5bc4bf>,</span> <span style=color:#815ba4>this</span><span style=color:#5bc4bf>);</span>
</span></span><span style=display:flex><span>        sessions<span style=color:#5bc4bf>.</span><span style=color:#06b6ef>put</span><span style=color:#5bc4bf>(</span>id <span style=color:#5bc4bf>,</span>newSession<span style=color:#5bc4bf>);</span>
</span></span><span style=display:flex><span>        <span style=color:#815ba4>return</span> newSession<span style=color:#5bc4bf>;</span>
</span></span><span style=display:flex><span>    <span style=color:#5bc4bf>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#815ba4>private</span> String <span style=color:#06b6ef>createUniqueSessionId</span><span style=color:#5bc4bf>()</span> <span style=color:#5bc4bf>{</span>
</span></span><span style=display:flex><span>        String prefix <span style=color:#5bc4bf>=</span> String<span style=color:#5bc4bf>.</span><span style=color:#06b6ef>valueOf</span><span style=color:#5bc4bf>(</span>100000 <span style=color:#5bc4bf>+</span> <span style=color:#815ba4>new</span> Random<span style=color:#5bc4bf>().</span><span style=color:#06b6ef>nextInt</span><span style=color:#5bc4bf>(</span>899999<span style=color:#5bc4bf>));</span>
</span></span><span style=display:flex><span>        <span style=color:#815ba4>return</span> <span style=color:#815ba4>new</span> StringBuilder<span style=color:#5bc4bf>().</span><span style=color:#06b6ef>append</span><span style=color:#5bc4bf>(</span>System<span style=color:#5bc4bf>.</span><span style=color:#06b6ef>currentTimeMillis</span><span style=color:#5bc4bf>()).</span><span style=color:#06b6ef>reverse</span><span style=color:#5bc4bf>().</span><span style=color:#06b6ef>append</span><span style=color:#5bc4bf>(</span>prefix<span style=color:#5bc4bf>).</span><span style=color:#06b6ef>toString</span><span style=color:#5bc4bf>();</span>
</span></span><span style=display:flex><span>    <span style=color:#5bc4bf>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#815ba4>public</span> <span style=color:#fec418>void</span> <span style=color:#06b6ef>setOldSession</span><span style=color:#5bc4bf>(</span>NettyHttpSession session<span style=color:#5bc4bf>)</span> <span style=color:#5bc4bf>{</span>
</span></span><span style=display:flex><span>        <span style=color:#815ba4>if</span><span style=color:#5bc4bf>(</span>session <span style=color:#5bc4bf>!=</span> <span style=color:#815ba4>null</span><span style=color:#5bc4bf>){</span>
</span></span><span style=display:flex><span>            session<span style=color:#5bc4bf>.</span><span style=color:#06b6ef>setNew</span><span style=color:#5bc4bf>(</span><span style=color:#815ba4>false</span><span style=color:#5bc4bf>);</span>
</span></span><span style=display:flex><span>        <span style=color:#5bc4bf>}</span>
</span></span><span style=display:flex><span>    <span style=color:#5bc4bf>}</span>
</span></span><span style=display:flex><span>
</span></span><span style=display:flex><span>    <span style=color:#776e71>/**
</span></span></span><span style=display:flex><span><span style=color:#776e71>     * 超时的Session无效化，定期执行
</span></span></span><span style=display:flex><span><span style=color:#776e71>     */</span>
</span></span><span style=display:flex><span>    <span style=color:#815ba4>private</span> <span style=color:#815ba4>class</span> <span style=color:#fec418>checkInvalidSessions</span> <span style=color:#815ba4>implements</span> Runnable <span style=color:#5bc4bf>{</span>
</span></span><span style=display:flex><span>        <span style=color:#5bc4bf>@Override</span>
</span></span><span style=display:flex><span>        <span style=color:#815ba4>public</span> <span style=color:#fec418>void</span> <span style=color:#06b6ef>run</span><span style=color:#5bc4bf>()</span> <span style=color:#5bc4bf>{</span>
</span></span><span style=display:flex><span>            log<span style=color:#5bc4bf>.</span><span style=color:#06b6ef>info</span><span style=color:#5bc4bf>(</span><span style=color:#48b685>&#34;Session Manager expire-checking thread has been started...&#34;</span><span style=color:#5bc4bf>);</span>
</span></span><span style=display:flex><span>            <span style=color:#815ba4>while</span><span style=color:#5bc4bf>(</span><span style=color:#815ba4>true</span><span style=color:#5bc4bf>){</span>
</span></span><span style=display:flex><span>                <span style=color:#815ba4>try</span> <span style=color:#5bc4bf>{</span>
</span></span><span style=display:flex><span>                    Thread<span style=color:#5bc4bf>.</span><span style=color:#06b6ef>sleep</span><span style=color:#5bc4bf>(</span>SESSION_LIFE_CHECK_INTER<span style=color:#5bc4bf>);</span>
</span></span><span style=display:flex><span>                <span style=color:#5bc4bf>}</span> <span style=color:#815ba4>catch</span> <span style=color:#5bc4bf>(</span>InterruptedException e<span style=color:#5bc4bf>)</span> <span style=color:#5bc4bf>{</span>
</span></span><span style=display:flex><span>                    e<span style=color:#5bc4bf>.</span><span style=color:#06b6ef>printStackTrace</span><span style=color:#5bc4bf>();</span>
</span></span><span style=display:flex><span>                <span style=color:#5bc4bf>}</span>
</span></span><span style=display:flex><span>                <span style=color:#fec418>long</span> curTime <span style=color:#5bc4bf>=</span> System<span style=color:#5bc4bf>.</span><span style=color:#06b6ef>currentTimeMillis</span><span style=color:#5bc4bf>();</span>
</span></span><span style=display:flex><span>                <span style=color:#815ba4>for</span><span style=color:#5bc4bf>(</span>NettyHttpSession session <span style=color:#5bc4bf>:</span> sessions<span style=color:#5bc4bf>.</span><span style=color:#06b6ef>values</span><span style=color:#5bc4bf>()){</span>
</span></span><span style=display:flex><span>                    <span style=color:#815ba4>if</span><span style=color:#5bc4bf>(</span>session<span style=color:#5bc4bf>.</span><span style=color:#06b6ef>expire</span><span style=color:#5bc4bf>()){</span>
</span></span><span style=display:flex><span>                        log<span style=color:#5bc4bf>.</span><span style=color:#06b6ef>info</span><span style=color:#5bc4bf>(</span><span style=color:#48b685>&#34;Session(ID={}) is invalidated by Session Manager&#34;</span><span style=color:#5bc4bf>,</span> session<span style=color:#5bc4bf>.</span><span style=color:#06b6ef>getId</span><span style=color:#5bc4bf>());</span>
</span></span><span style=display:flex><span>                        session<span style=color:#5bc4bf>.</span><span style=color:#06b6ef>invalidate</span><span style=color:#5bc4bf>();</span>
</span></span><span style=display:flex><span>                    <span style=color:#5bc4bf>}</span>
</span></span><span style=display:flex><span>                <span style=color:#5bc4bf>}</span>
</span></span><span style=display:flex><span>            <span style=color:#5bc4bf>}</span>
</span></span><span style=display:flex><span>        <span style=color:#5bc4bf>}</span>
</span></span><span style=display:flex><span>    <span style=color:#5bc4bf>}</span>
</span></span><span style=display:flex><span><span style=color:#5bc4bf>}</span>
</span></span></code></pre></div><h3 id=可以改进的地方>可以改进的地方</h3><ul><li>Session持久化，包括可选的持久化时间间隔、shutdown自动持久化、startup自动读入。</li><li>Redis集中存储Session，便于服务集群使用</li><li>优化解析速度</li></ul></section><footer class=article-footer><section class=article-tags><a href=/tags/Netty/>Netty</a>
<a href=/tags/Spring-Boot/>Spring Boot</a>
<a href=/tags/Servlet/>Servlet</a></section><section class=article-copyright><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-copyright" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><path d="M14.5 9a3.5 4 0 100 6"/></svg><span>Licensed under Apache License 2.0</span></section></footer></article><aside class=related-contents--wrapper><h2 class=section-title>Related contents</h2><div class=related-contents><div class="flex article-list--tile"><article class=has-image><a href=/p/%E5%9F%BA%E4%BA%8ENetty%E7%9A%84Spring-Boot%E5%86%85%E7%BD%AEServlet%E5%AE%B9%E5%99%A8%E7%9A%84%E5%AE%9E%E7%8E%B0%E4%BA%94/><div class=article-image><img src=/p/%E5%9F%BA%E4%BA%8ENetty%E7%9A%84Spring-Boot%E5%86%85%E7%BD%AEServlet%E5%AE%B9%E5%99%A8%E7%9A%84%E5%AE%9E%E7%8E%B0%E4%BA%94/lzwx.e90c62716067760f53ef8748025a1653_hu1afe6b3663fa6cb2c80c0a666eabfb57_157940_250x150_fill_box_smart1_3.png width=250 height=150 loading=lazy alt="Featured image of post 基于Netty的Spring Boot内置Servlet容器的实现（五）" data-hash="md5-6QxicWBndg9T74dIAloWUw=="></div><div class=article-details><h2 class=article-title>基于Netty的Spring Boot内置Servlet容器的实现（五）</h2></div></a></article><article class=has-image><a href=/p/%E5%9F%BA%E4%BA%8ENetty%E7%9A%84Spring-Boot%E5%86%85%E7%BD%AEServlet%E5%AE%B9%E5%99%A8%E7%9A%84%E5%AE%9E%E7%8E%B0%E4%B8%89/><div class=article-image><img src=/p/%E5%9F%BA%E4%BA%8ENetty%E7%9A%84Spring-Boot%E5%86%85%E7%BD%AEServlet%E5%AE%B9%E5%99%A8%E7%9A%84%E5%AE%9E%E7%8E%B0%E4%B8%89/yuyuko2.1c117d4033c6a3d65832bc8cb5537310_hueaf00a8425bfe94574c5d8750a924d5c_123372_250x150_fill_box_smart1_3.png width=250 height=150 loading=lazy alt="Featured image of post 基于Netty的Spring Boot内置Servlet容器的实现（三）" data-hash="md5-HBF9QDPGo9ZYMryMtVNzEA=="></div><div class=article-details><h2 class=article-title>基于Netty的Spring Boot内置Servlet容器的实现（三）</h2></div></a></article><article class=has-image><a href=/p/%E5%9F%BA%E4%BA%8ENetty%E7%9A%84Spring-Boot%E5%86%85%E7%BD%AEServlet%E5%AE%B9%E5%99%A8%E7%9A%84%E5%AE%9E%E7%8E%B0%E4%BA%8C/><div class=article-image><img src=/p/%E5%9F%BA%E4%BA%8ENetty%E7%9A%84Spring-Boot%E5%86%85%E7%BD%AEServlet%E5%AE%B9%E5%99%A8%E7%9A%84%E5%AE%9E%E7%8E%B0%E4%BA%8C/sanae.ad1a3b3f97a8ef8c39506c03f84ad1f7_hu112f514aec6702f2f444da4fa7f9ccac_72624_250x150_fill_box_smart1_3.png width=250 height=150 loading=lazy alt="Featured image of post 基于Netty的Spring Boot内置Servlet容器的实现（二）" data-hash="md5-rRo7P5eo74w5UGwD+ErR9w=="></div><div class=article-details><h2 class=article-title>基于Netty的Spring Boot内置Servlet容器的实现（二）</h2></div></a></article><article class=has-image><a href=/p/%E5%9F%BA%E4%BA%8ENetty%E7%9A%84Spring-Boot%E5%86%85%E7%BD%AEServlet%E5%AE%B9%E5%99%A8%E7%9A%84%E5%AE%9E%E7%8E%B0%E4%B8%80/><div class=article-image><img src=/p/%E5%9F%BA%E4%BA%8ENetty%E7%9A%84Spring-Boot%E5%86%85%E7%BD%AEServlet%E5%AE%B9%E5%99%A8%E7%9A%84%E5%AE%9E%E7%8E%B0%E4%B8%80/yuyuko.fce0b1976f277f565fe6da2813834311_hua56c2355a3520ae6430109398d99a70a_98080_250x150_fill_box_smart1_3.png width=250 height=150 loading=lazy alt="Featured image of post 基于Netty的Spring Boot内置Servlet容器的实现（一）" data-hash="md5-/OCxl28nf1Zf5tooE4NDEQ=="></div><div class=article-details><h2 class=article-title>基于Netty的Spring Boot内置Servlet容器的实现（一）</h2></div></a></article><article class=has-image><a href=/p/%E6%9C%80%E8%BF%91%E5%AF%B9Java%E6%9C%8D%E5%8A%A1%E6%A1%86%E6%9E%B6%E7%9A%84%E6%80%9D%E8%80%83/><div class=article-image><img src=/p/%E6%9C%80%E8%BF%91%E5%AF%B9Java%E6%9C%8D%E5%8A%A1%E6%A1%86%E6%9E%B6%E7%9A%84%E6%80%9D%E8%80%83/mokou_kaguya.f8956c7d4c79ae0c70980bce3b639df0_hu1b6d38c05bcdc128b7d4abee3ea0602c_80982_250x150_fill_box_smart1_3.png width=250 height=150 loading=lazy alt="Featured image of post 最近对Java服务框架的思考" data-hash="md5-+JVsfUx5rgxwmAvOO2Od8A=="></div><div class=article-details><h2 class=article-title>最近对Java服务框架的思考</h2></div></a></article></div></div></aside><div class=disqus-container><div id=disqus_thread></div><script type=application/javascript>window.disqus_config=function(){},function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById("disqus_thread").innerHTML="Disqus comments not available by default when the website is previewed locally.";return}var t=document,e=t.createElement("script");e.async=!0,e.src="//leibnizhu.disqus.com/embed.js",e.setAttribute("data-timestamp",+new Date),(t.head||t.body).appendChild(e)}()</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></div><style>.disqus-container{background-color:var(--card-background);border-radius:var(--card-border-radius);box-shadow:var(--shadow-l1);padding:var(--card-padding)}</style><script>window.addEventListener("onColorSchemeChange",e=>{DISQUS&&DISQUS.reset({reload:!0})})</script><footer class=site-footer><section class=copyright>&copy;
2016 -
2022 Heaven's Door</section><section class=powerby>Built with <a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a><br>Theme <b><a href=https://github.com/CaiJimmy/hugo-theme-stack target=_blank rel=noopener data-version=3.11.0>Stack</a></b> designed by <a href=https://jimmycai.com target=_blank rel=noopener>Jimmy</a></section></footer><div class=pswp tabindex=-1 role=dialog aria-hidden=true><div class=pswp__bg></div><div class=pswp__scroll-wrap><div class=pswp__container><div class=pswp__item></div><div class=pswp__item></div><div class=pswp__item></div></div><div class="pswp__ui pswp__ui--hidden"><div class=pswp__top-bar><div class=pswp__counter></div><button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
<button class="pswp__button pswp__button--share" title=Share></button>
<button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
<button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button><div class=pswp__preloader><div class=pswp__preloader__icn><div class=pswp__preloader__cut><div class=pswp__preloader__donut></div></div></div></div></div><div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap"><div class=pswp__share-tooltip></div></div><button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)"></button>
<button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)"></button><div class=pswp__caption><div class=pswp__caption__center></div></div></div></div></div><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo=" crossorigin=anonymous defer></script><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU=" crossorigin=anonymous defer></script><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.css integrity="sha256-c0uckgykQ9v5k+IqViZOZKc47Jn7KQil4/MP3ySA3F8=" crossorigin=anonymous><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.css integrity="sha256-SBLU4vv6CA6lHsZ1XyTdhyjJxCjPif/TRkjnsyGAGnE=" crossorigin=anonymous></main><aside class="sidebar right-sidebar sticky"><section class="widget archives"><div class=widget-icon><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><line x1="5" y1="9" x2="19" y2="9"/><line x1="5" y1="15" x2="19" y2="15"/><line x1="11" y1="4" x2="7" y2="20"/><line x1="17" y1="4" x2="13" y2="20"/></svg></div><h2 class="widget-title section-title">Table of contents</h2><div class=widget--toc><nav id=TableOfContents><ol><li><a href=#registration注册器的实现>Registration注册器的实现</a><ol><li><a href=#设计与继承结构>设计与继承结构</a></li><li><a href=#代码实现>代码实现</a></li></ol></li><li><a href=#filterchain过滤器链的实现>FilterChain过滤器链的实现</a></li><li><a href=#httpservletrequest的实现>HttpServletRequest的实现</a><ol><li><a href=#cookie相关方法>Cookie相关方法</a></li><li><a href=#header相关方法>Header相关方法</a></li><li><a href=#session相关方法>Session相关方法</a></li></ol></li><li><a href=#httpservletresponse实现>HttpServletResponse实现</a><ol><li><a href=#header相关方法-1>Header相关方法</a></li><li><a href=#getnettyresponse方法>getNettyResponse()方法</a></li></ol></li><li><a href=#session实现>Session实现</a><ol><li><a href=#nettyhttpsession>NettyHttpSession</a></li><li><a href=#nettysessionmanager>NettySessionManager</a></li><li><a href=#可以改进的地方>可以改进的地方</a></li></ol></li></ol></nav></div></section></aside></div><script src=https://cdn.jsdelivr.net/npm/node-vibrant@3.1.5/dist/vibrant.min.js integrity="sha256-5NovOZc4iwiAWTYIFiIM7DxKUXKWvpVEuMEPLzcm5/g=" crossorigin=anonymous></script><script type=text/javascript src=/ts/main.js defer></script>
<script>(function(){const e=document.createElement("link");e.href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap",e.type="text/css",e.rel="stylesheet",document.head.appendChild(e)})()</script></body></html>