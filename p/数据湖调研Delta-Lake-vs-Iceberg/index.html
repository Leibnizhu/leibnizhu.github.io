<!doctype html><html lang=en-us dir=ltr><head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content="Delta Lake Delta Lake是Databricks推出的流批一体存储层，分为开源版和商业版，深度绑定自家Spark。 Lakehouse论文 请先快速阅读Da"><title>数据湖调研：Delta Lake vs Iceberg</title><link rel=canonical href=https://leibnizhu.github.io/p/%E6%95%B0%E6%8D%AE%E6%B9%96%E8%B0%83%E7%A0%94Delta-Lake-vs-Iceberg/><link rel=stylesheet href=/scss/style.min.23e1d8e9a6160c668989a401c0af6c7e300683648c9edcf1dec562b9b0efc7b4.css><meta property="og:title" content="数据湖调研：Delta Lake vs Iceberg"><meta property="og:description" content="Delta Lake Delta Lake是Databricks推出的流批一体存储层，分为开源版和商业版，深度绑定自家Spark。 Lakehouse论文 请先快速阅读Da"><meta property="og:url" content="https://leibnizhu.github.io/p/%E6%95%B0%E6%8D%AE%E6%B9%96%E8%B0%83%E7%A0%94Delta-Lake-vs-Iceberg/"><meta property="og:site_name" content="Heaven's Door"><meta property="og:type" content="article"><meta property="article:section" content="Post"><meta property="article:tag" content="DeltaLake"><meta property="article:tag" content="LakeHouse"><meta property="article:tag" content="IceBerg"><meta property="article:tag" content="DataLake"><meta property="article:tag" content="数据湖"><meta property="article:published_time" content="2022-07-20T10:03:41+08:00"><meta property="article:modified_time" content="2022-07-20T10:03:41+08:00"><meta property="og:image" content="https://leibnizhu.github.io/p/%E6%95%B0%E6%8D%AE%E6%B9%96%E8%B0%83%E7%A0%94Delta-Lake-vs-Iceberg/magician.jpg"><meta name=twitter:title content="数据湖调研：Delta Lake vs Iceberg"><meta name=twitter:description content="Delta Lake Delta Lake是Databricks推出的流批一体存储层，分为开源版和商业版，深度绑定自家Spark。 Lakehouse论文 请先快速阅读Da"><meta name=twitter:card content="summary_large_image"><meta name=twitter:image content="https://leibnizhu.github.io/p/%E6%95%B0%E6%8D%AE%E6%B9%96%E8%B0%83%E7%A0%94Delta-Lake-vs-Iceberg/magician.jpg"><link rel="shortcut icon" href=favicon.jpg><script async src="https://www.googletagmanager.com/gtag/js?id=G-TK434TCNDK"></script>
<script>var doNotTrack=!1;if(!doNotTrack){window.dataLayer=window.dataLayer||[];function gtag(){dataLayer.push(arguments)}gtag("js",new Date),gtag("config","G-TK434TCNDK",{anonymize_ip:!1})}</script></head><body class=article-page><script>(function(){const e="StackColorScheme";localStorage.getItem(e)||localStorage.setItem(e,"auto")})()</script><script>(function(){const t="StackColorScheme",e=localStorage.getItem(t),n=window.matchMedia("(prefers-color-scheme: dark)").matches===!0;e=="dark"||e==="auto"&&n?document.documentElement.dataset.scheme="dark":document.documentElement.dataset.scheme="light"})()</script><div class="container main-container flex on-phone--column extended"><aside class="sidebar left-sidebar sticky"><button class="hamburger hamburger--spin" type=button id=toggle-menu aria-label="Toggle Menu">
<span class=hamburger-box><span class=hamburger-inner></span></span></button><header><figure class=site-avatar><a href=/><img src=/img/avatar_hu4af873b90feb2f44d14cf5fcf42d034c_7593_300x0_resize_q75_box.jpg width=300 height=300 class=site-logo loading=lazy alt=Avatar></a></figure><div class=site-meta><h1 class=site-name><a href=/>Heaven's Door</a></h1><h2 class=site-description>That cold black cloud is comin' down, Feels like I'm knockin' on heaven's door…</h2></div></header><ol class=social-menu><li><a href=/ title=Home><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-home" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><polyline points="5 12 3 12 12 3 21 12 19 12"/><path d="M5 12v7a2 2 0 002 2h10a2 2 0 002-2v-7"/><path d="M9 21v-6a2 2 0 012-2h2a2 2 0 012 2v6"/></svg></a></li><li><a href=https://github.com/leibnizhu target=_blank title=GitHub><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-brand-github" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M9 19c-4.3 1.4-4.3-2.5-6-3m12 5v-3.5c0-1 .1-1.4-.5-2 2.8-.3 5.5-1.4 5.5-6a4.6 4.6.0 00-1.3-3.2 4.2 4.2.0 00-.1-3.2s-1.1-.3-3.5 1.3a12.3 12.3.0 00-6.2.0C6.5 2.8 5.4 3.1 5.4 3.1a4.2 4.2.0 00-.1 3.2A4.6 4.6.0 004 9.5c0 4.6 2.7 5.7 5.5 6-.6.6-.6 1.2-.5 2V21"/></svg></a></li><li><a href=mailto:leibnizhu@gmail.com target=_blank title=Email><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-brand-gmail" width="44" height="44" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><path d="M16 20h3a1 1 0 001-1V5a1 1 0 00-1-1h-3v16z"/><path d="M5 20h3V4H5A1 1 0 004 5v14a1 1 0 001 1z"/><path d="M16 4l-4 4-4-4"/><path d="M4 6.5l8 7.5 8-7.5"/></svg></a></li></ol><ol class=menu id=main-menu><li><a href=/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-home" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><polyline points="5 12 3 12 12 3 21 12 19 12"/><path d="M5 12v7a2 2 0 002 2h10a2 2 0 002-2v-7"/><path d="M9 21v-6a2 2 0 012-2h2a2 2 0 012 2v6"/></svg><span>Home</span></a></li><li><a href=/About/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-user" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="7" r="4"/><path d="M6 21v-2a4 4 0 014-4h4a4 4 0 014 4v2"/></svg><span>About</span></a></li><li><a href=/Workouts/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-run" width="44" height="44" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z" fill="none"/><circle cx="13" cy="4" r="1"/><path d="M4 17l5 1 .75-1.5"/><path d="M15 21v-4l-4-3 1-6"/><path d="M7 12V9l5-1 3 3 3 1"/></svg><span>Workouts</span></a></li><li><a href=/archives/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-archive" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><rect x="3" y="4" width="18" height="4" rx="2"/><path d="M5 8v10a2 2 0 002 2h10a2 2 0 002-2V8"/><line x1="10" y1="12" x2="14" y2="12"/></svg><span>Archives</span></a></li><li><a href=/search/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-search" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="10" cy="10" r="7"/><line x1="21" y1="21" x2="15" y2="15"/></svg><span>Search</span></a></li><li><a href=/Links/><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-link" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M10 14a3.5 3.5.0 005 0l4-4a3.5 3.5.0 00-5-5l-.5.5"/><path d="M14 10a3.5 3.5.0 00-5 0l-4 4a3.5 3.5.0 005 5l.5-.5"/></svg><span>Links</span></a></li><div class=menu-bottom-section><li id=dark-mode-toggle><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-left" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="8" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-toggle-right" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="16" cy="12" r="2"/><rect x="2" y="6" width="20" height="12" rx="6"/></svg><span>Dark Mode</span></li></div></ol></aside><main class="main full-width"><article class="has-image main-article"><header class=article-header><div class=article-image><a href=/p/%E6%95%B0%E6%8D%AE%E6%B9%96%E8%B0%83%E7%A0%94Delta-Lake-vs-Iceberg/><img src=/p/%E6%95%B0%E6%8D%AE%E6%B9%96%E8%B0%83%E7%A0%94Delta-Lake-vs-Iceberg/magician_hud45400ab03b8bcc6bc10b4c1488a0b09_97675_800x0_resize_q75_box.jpg srcset="/p/%E6%95%B0%E6%8D%AE%E6%B9%96%E8%B0%83%E7%A0%94Delta-Lake-vs-Iceberg/magician_hud45400ab03b8bcc6bc10b4c1488a0b09_97675_800x0_resize_q75_box.jpg 800w, /p/%E6%95%B0%E6%8D%AE%E6%B9%96%E8%B0%83%E7%A0%94Delta-Lake-vs-Iceberg/magician_hud45400ab03b8bcc6bc10b4c1488a0b09_97675_1600x0_resize_q75_box.jpg 1600w" width=800 height=453 loading=lazy alt="Featured image of post 数据湖调研：Delta Lake vs Iceberg"></a></div><div class=article-details><div class=article-title-wrapper><h2 class=article-title><a href=/p/%E6%95%B0%E6%8D%AE%E6%B9%96%E8%B0%83%E7%A0%94Delta-Lake-vs-Iceberg/>数据湖调研：Delta Lake vs Iceberg</a></h2></div><footer class=article-time><div><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-calendar-time" width="56" height="56" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><path d="M11.795 21H5a2 2 0 01-2-2V7a2 2 0 012-2h12a2 2 0 012 2v4"/><circle cx="18" cy="18" r="4"/><path d="M15 3v4"/><path d="M7 3v4"/><path d="M3 11h16"/><path d="M18 16.496V18l1 1"/></svg><time class=article-time--published>Jul 20, 2022</time></div><div><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-clock" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><polyline points="12 7 12 12 15 15"/></svg><time class=article-time--reading>13 minute read</time>
<time class=article-time--reading>6364 words</time></div></footer></div></header><section class=article-content><h2 id=delta-lake>Delta Lake</h2><p>Delta Lake是Databricks推出的流批一体存储层，分为开源版和商业版，深度绑定自家Spark。</p><h3 id=lakehouse论文>Lakehouse论文</h3><p>请先快速阅读Databricks的论文 <a class=link href=https://databricks.com/wp-content/uploads/2020/12/cidr_lakehouse.pdf target=_blank rel=noopener>Lakehouse: A New Generation of Open Platforms that Unify Data Warehousing and Advanced Analytics</a>。</p><p>这篇论文主要讲了传统的数仓和数据湖模型的缺陷，在此基础上提出湖仓一体的LakeHouse模型，并阐述了LakeHouse的一些设计细节。下面挑一些要点来讲讲。</p><p>LakeHouse是Databricks提出的一种将在未来几年取代传统数仓结构的架构。传统数仓将业务数据库数据收集到集中式的数仓，在写入时针对下游BI消费对schema进行优化；然而传统数仓将计算与存储耦合，且对非结构化数据支持不佳。于是出现了数据湖，以开放格式（如Parquet、ORC）存储在低成本的存储系统（如S3），湖中的数据ETL到下游数仓，再提供给BI使用。但这样的两层结构带来了一下问题：</p><ul><li><strong>可靠性</strong>：难以维持数据湖与下游数仓的数据一致性</li><li><strong>数据不及时</strong>：需要两次ETL才到BI，对于传统数仓而言，甚至是开历史倒车</li><li><strong>对高级分析支持不佳</strong>：机器学习Tensorflow、PyTorch等，需要通过非SQL处理大量数据，无法通过JDBC/ODBC高效运行</li><li><strong>总成本高</strong></li></ul><p>于是噔噔瞪瞪，LakeHouse出来了：基于开放文件格式（如ORC/Parquet）的低成本存储，同时提供数仓的管理功能、传统DBMS的管理特性（如ACID事务、版本控制、审计、索引、缓存等）、及for高级分析（如机器学习）的高速I/O，的高性能系统。同时在设计上适应可存储计算隔离的云计算环境。LakeHouse解决了以下关键问题：</p><ul><li><strong>可靠的数据管理</strong>：传统数据湖只是管理了一堆半结构化文件，在事务、回滚等方面的能力太差。</li><li><strong>支持机器学习</strong>：支持DataFrame API；而ML系统可以直接读取数据湖的格式，很多也支持DataFrame</li><li><strong>SQL查询性能</strong>：归功于过去对ORC/Parquet做SQL查询的性能优化经验</li></ul><p>下面是这三代数仓/数据湖结构对比：</p><p><img src=/p/%E6%95%B0%E6%8D%AE%E6%B9%96%E8%B0%83%E7%A0%94Delta-Lake-vs-Iceberg/lakehouse1.png width=2100 height=836 srcset="/p/%E6%95%B0%E6%8D%AE%E6%B9%96%E8%B0%83%E7%A0%94Delta-Lake-vs-Iceberg/lakehouse1_hua80d5848797b05fbcec254ae3a94cf3f_794557_480x0_resize_box_3.png 480w, /p/%E6%95%B0%E6%8D%AE%E6%B9%96%E8%B0%83%E7%A0%94Delta-Lake-vs-Iceberg/lakehouse1_hua80d5848797b05fbcec254ae3a94cf3f_794557_1024x0_resize_box_3.png 1024w" loading=lazy alt=三代数仓/数据湖结构对比 class=gallery-image data-flex-grow=251 data-flex-basis=602px></p><p>下面是LakeHouse架构和实现要点。</p><p><strong>元数据层</strong>：</p><p>LakeHouse设计理念是使用标准文件格式以低成本存储，在存储的顶层设计实现传统的元数据层，可提高抽象级别、实现ACID事务、版本控制等特性。DeltaLake <em><strong>以Parquet格式在数据湖本身的存储上存放事务日志</strong></em> ，可以存储哪些对象属于表的信息：</p><ul><li>实践证明这套设计在性能类似或更优于原始Parquet/ORC的同时，提供了事务等管理功能</li><li>元数据层同时可以保证数据质量，如强制schema（schema enforcement）可以保障新增数据必须匹配已有schema，并提供了API允许配置数据约束（如某列数据需要满足枚举要求）。</li><li>元数据层可实施ACL、日志审计等功能</li></ul><p><strong>SQL性能优化</strong>：</p><ul><li>缓存：热数据缓存到更快的存储设备，如SSD、RAM</li><li>辅助数据：Lakehouse虽然使用了公开的文件格式（Parquet/ORC），但可以通过辅助数据帮助优化查询速度，如构建索引、维护统计信息。DeltaLake在上面提到的事务日志中维护列的最大最小值信息，方便查询时跳过；并实现了基于布龙过滤器的索引</li><li>数据布局优化：在Parquet格式不变的基础上，还是有优化空间，如记录排序，让数据聚拢便于读取。DeltaLake使用Z-order和Hilbert曲线对记录排序以在读取时更好地进行文件修剪。</li></ul><p><strong>针对高级分析的优化</strong>：</p><p>通过声明式的DataFrame API加速高级分析。DataFrame API在DeltaLake的位置：</p><p><img src=/p/%E6%95%B0%E6%8D%AE%E6%B9%96%E8%B0%83%E7%A0%94Delta-Lake-vs-Iceberg/lakehouse2.png width=1046 height=788 srcset="/p/%E6%95%B0%E6%8D%AE%E6%B9%96%E8%B0%83%E7%A0%94Delta-Lake-vs-Iceberg/lakehouse2_hu29e2705cbf93e41a5d284ca61a497d45_214685_480x0_resize_box_3.png 480w, /p/%E6%95%B0%E6%8D%AE%E6%B9%96%E8%B0%83%E7%A0%94Delta-Lake-vs-Iceberg/lakehouse2_hu29e2705cbf93e41a5d284ca61a497d45_214685_1024x0_resize_box_3.png 1024w" loading=lazy alt="DataFrame API在DeltaLake的位置" class=gallery-image data-flex-grow=132 data-flex-basis=318px></p><p>下图是Spark MLlib中执行声明式的DataFrame API。用户的DataFrame调用是lazy的，执行时Spark引擎获取执行计划，传给DeltaLake的库，后者读取元数据层，根据缓存、索引、统计信息等进行优化查询，最后执行。</p><p><img src=/p/%E6%95%B0%E6%8D%AE%E6%B9%96%E8%B0%83%E7%A0%94Delta-Lake-vs-Iceberg/lakehouse3.png width=1030 height=568 srcset="/p/%E6%95%B0%E6%8D%AE%E6%B9%96%E8%B0%83%E7%A0%94Delta-Lake-vs-Iceberg/lakehouse3_hu9da49551a80d03814825ede3c8f48533_95914_480x0_resize_box_3.png 480w, /p/%E6%95%B0%E6%8D%AE%E6%B9%96%E8%B0%83%E7%A0%94Delta-Lake-vs-Iceberg/lakehouse3_hu9da49551a80d03814825ede3c8f48533_95914_1024x0_resize_box_3.png 1024w" loading=lazy alt=DeltaLake的DataFrame查询优化 class=gallery-image data-flex-grow=181 data-flex-basis=435px></p><h3 id=delta-lake白皮书>Delta Lake白皮书</h3><p>请先快速阅读Databricks的论文 <a class=link href=https://databricks.com/wp-content/uploads/2020/08/p975-armbrust.pdf target=_blank rel=noopener>Delta Lake: High-Performance ACID Table Storage over Cloud Object Stores</a> 。</p><p><strong>纯Parquet/ORC的缺陷</strong>：</p><ul><li>多对象更新不是原子的，所以查询之间没有隔离；回滚写操作也很困难：如果更新查询崩溃，则表处于损坏状态。</li><li>元数据操作的成本很高</li><li>大多数企业数据集是不断更新的，因此它们需要一个原子性的写入解决方案</li></ul><p>Delta Lake应运而生，它是一个云对象存储上的ACID表存储层。核心思想：</p><ul><li>用ACID方式在云对象中存储日志（write-ahead），以纪录哪些对象是Delta表的一部分</li><li>日志还包含元数据，例如每个数据文件的最小/最大统计信息，用于查询优化。</li><li>将所有元数据都存在底层对象存储中，并且使用针对对象存储的乐观并发协议实现事务，意味着不需要运行服务器来维护Delta表的状态</li></ul><p><strong>特性</strong>：</p><ul><li>Time travel</li><li>UPSERT, DELETE and MERGE operations</li><li>Efficient streamingI/O</li><li>Caching</li><li>Data layout optimization</li><li>Schema evolution</li><li>Audit logging</li></ul><p>使用DeltaLake的例子：</p><p><img src=/p/%E6%95%B0%E6%8D%AE%E6%B9%96%E8%B0%83%E7%A0%94Delta-Lake-vs-Iceberg/deltalake1.png width=1008 height=1166 srcset="/p/%E6%95%B0%E6%8D%AE%E6%B9%96%E8%B0%83%E7%A0%94Delta-Lake-vs-Iceberg/deltalake1_hu4e9ebd4c418f2361977445627d1a6903_285704_480x0_resize_box_3.png 480w, /p/%E6%95%B0%E6%8D%AE%E6%B9%96%E8%B0%83%E7%A0%94Delta-Lake-vs-Iceberg/deltalake1_hu4e9ebd4c418f2361977445627d1a6903_285704_1024x0_resize_box_3.png 1024w" loading=lazy alt=使用DeltaLake的例子 class=gallery-image data-flex-grow=86 data-flex-basis=207px></p><p><strong>旧世界的桎梏</strong>：</p><ul><li>对象存储API：云对象存储的API太慢太麻烦云云</li><li>一致性保证：云对象存储为每个键提供了最终的一致性，并且没有跨键的一致性保证；对现有对象的更新可能不会立即对其他客户端可见</li><li>性能问题</li><li>目前有三种表存储方式：<ul><li>文件目录：将表存储为对象的集合，基于一个或多个属性将记录“分区”到目录中。比如Hive。主要问题是存在性能和一致性问题</li><li>自定义存储引擎：在一个单独的、高度一致的服务中管理元数据本身。比如Snowflake。需要运行一个高可用性的服务来管理元数据，这可能很开销很大；而且表的所有I/O操作都需要联系元数据服务，这会增加其资源成本，降低性能和可用性；现有计算引擎的连接器需要更多的开发对接工作。</li><li>噔噔瞪瞪，<em><strong>对象存储中的元数据</strong></em> ：DeltaLake将事务日志和元数据直接存储在云对象存储中，并在对象存储操作上使用一组协议来实现序列化</li></ul></li></ul><p>后面是具体的存储格式和访问协议，篇幅太长，不展开了。后面再补吧。</p><h3 id=deltalake基本概念与使用>DeltaLake基本概念与使用</h3><p><a class=link href=https://docs.delta.io/latest/delta-intro.html target=_blank rel=noopener>官方文档</a></p><p>注意到上文所说的事务日志放在对象存储的同一位置，就是在表的目录下，有个 <code>_delta_log</code> 子目录，一个版本对应里面一个json，记录了事务操作，Time Travel显然也是基于此。</p><h2 id=iceberg>Iceberg</h2><h3 id=设计理念>设计理念</h3><p>Meetup视频： <a class=link href="https://www.youtube.com/watch?v=N4gAi_zpN88" target=_blank rel=noopener>Data Science DC Nov 2021 Meetup: Apache Iceberg - An Architectural Look Under the Covers</a>，也可以看 <a class=link href=https://www.dremio.com/resources/guides/apache-iceberg-an-architectural-look-under-the-covers/ target=_blank rel=noopener>演讲稿</a>。</p><h4 id=what-is-iceberg>What is Iceberg</h4><div class=table-wrapper><table><thead><tr><th>✅ Iceberg 是……</th><th>❌ Iceberg不是……</th></tr></thead><tbody><tr><td>Table Format定义</td><td>存储引擎</td></tr><tr><td>遵循Iceberg Table Format定义与表进行交互的一套API及库</td><td>执行引擎</td></tr><tr><td></td><td>一套服务</td></tr></tbody></table></div><h4 id=table-format>Table Format?</h4><blockquote><p>A good way to define a table format is a way to organize a dataset’s files to present them as a single “table”.<br>Another somewhat simpler definition from a user’s perspective is a way to answer the question “what data is in this table?”.<br>A single answer to that question allows multiple people, groups, and tools to interact with data in the table at the same time, whether they’re writing to the table or reading from the table.</p></blockquote><p><code>Table Format</code> 是表的抽象，将数据集文件组合起来，以单个“表”的形式呈现，允许人和工具与表数据高效交互。</p><h4 id=table-format简史>Table Format简史</h4><p><strong>Hadoop刀耕火种</strong>：直撸HDFS，用户必须清楚如何将问题转化为MR模型并用java编码，数据也没有schema，用户必须熟知他处理的文件的实际schema。</p><p><strong>Hive</strong>：针对Hadoop第一个问题，用SQL替代之；针对Hadoop第二个问题，用metastore记录schema。Hive从此成为了事实上的Table Format标准。Hive的Table Format我们比较熟知，就不细述了，更多优点也不说了，看视频有。说下缺点：</p><ul><li>修改数据太低效，尤其分区很大，修改里面的少量数据、或频繁更改</li><li>无法安全地更改多个分区的数据，Hive只保证单个分区的事务一致性</li><li>在实际操作中，多个作业同时修改一个数据集是不安全的</li><li>对于大型表，即便只是列出所有目录也要耗费很多时间</li><li>为了利用分区优化查询，用户必须知道物理的分区布局（比如按年、月、日分区）</li><li>Hive表的统计信息往往是过时的，可能导致优化器选择效率低的计划</li><li>在云存储中性能不佳。Hive表一个分区中的所有数据都具有相同的目录前缀，利用不到云存储不同前缀的分流</li></ul><p><strong>Iceberg</strong>：Netflix发现，解决Hive Table Format问题的关键是放弃在文件夹级别跟踪表数据，改为在文件级别跟踪。修改之后，还能做到：</p><ul><li>保证表视图的正确性和一致性</li><li>实现更快的查询计划和执行</li><li>用户无需了解数据的物理布局（如分区）</li><li>实现更好、更安全的表进化（table evolution，即表schema变更）</li></ul><h4 id=iceberg-table-format定义>Iceberg Table Format定义</h4><p><strong>Iceberg Table Format架构</strong>：</p><p><img src=/p/%E6%95%B0%E6%8D%AE%E6%B9%96%E8%B0%83%E7%A0%94Delta-Lake-vs-Iceberg/iceberg1.png width=1230 height=1282 srcset="/p/%E6%95%B0%E6%8D%AE%E6%B9%96%E8%B0%83%E7%A0%94Delta-Lake-vs-Iceberg/iceberg1_hu60d45ae1d07beb91112bb0d0d565fdfb_134710_480x0_resize_box_3.png 480w, /p/%E6%95%B0%E6%8D%AE%E6%B9%96%E8%B0%83%E7%A0%94Delta-Lake-vs-Iceberg/iceberg1_hu60d45ae1d07beb91112bb0d0d565fdfb_134710_1024x0_resize_box_3.png 1024w" loading=lazy alt="Iceberg Table Format架构" class=gallery-image data-flex-grow=95 data-flex-basis=230px></p><p>分了三层：</p><ol><li><code>Iceberg catalog</code> ：记录各个表当前元数据指针的位置。<code>Iceberg catalog</code> 要求元数据指针的实现支持原子性的更新操作。实际的存储方式取决于具体使用的存储：<ol><li>HDFS：元数据文件夹中有一个名为 <code>version-hint.text</code> 的文件，其内容是当前元数据文件的版本号</li><li>Hive metastore：metastore的表对象用表属性记录当前元数据文件的位置</li><li>Nessie：Nessie保存了当前元数据文件的位置</li></ol></li><li><code>metadata layer</code>，具体又包括：<ol><li><code>metadata file</code>：存储表的元信息，包括表的schema、分区信息、所有快照信息、及当前快照等等,json格式。查询过程：按 <code>current-snapshot-id</code> 在 <code>snapshots</code> 找到对应快照，读取其 <code>manifest-list</code> 属性，打开 <code>manifest lists</code>。</li><li><code>manifest list</code>：<code>manifest files</code> 的列表，每一行是构成该快照的一个 <code>manifest file</code> 的信息，包括 <code>manifest file</code> 位置、所属分区、分区列的最大最小值等。查询时可以在此阶段进行一些优化，例如使用行计数或使用分区信息过滤数据。</li><li><code>manifest file</code>：记录数据文件以及有关每个文件的其他详细信息和统计信息，可用于优化查询，而且这些信息是在写入操作期间更新的，比Hive记录的统计信息的更准确、更新。Iceberg 与文件格式无关，因此清单文件还指定了数据文件的文件格式，例如 Parquet、ORC 或 Avro</li></ol></li><li><code>data layer</code> ：实际存储的文件</li></ol><p>日常表操作在Iceberg Table Format中的体现：</p><ol><li><code>CREATE TABLE xxx</code>：创建metadata file，里面有快照s0（但不指向任何manifest list），表的当前元数据指针指向该metadata file</li><li><code>INSERT INTO xxx</code>：<ol><li>创建数据文件（Parquet或其他格式）</li><li>创建manifest file，指向该数据文件</li><li>创建manifest list，指向该manifest file</li><li>创建新的metadata file，带有快照s1和s0，<code>current-snapshot-id</code> 是s1</li><li>表的当前元数据指针指向新的metadata file</li></ol></li><li><code>MERGE INTO xxx USING ... ON ... WHEN MATCHED THEN UPDATE ... WHEN NOT MATCHED THEN INSERT...</code>：upsert的操作，步骤比较多：<ol><li>找出满足 <code>USING ... ON ...</code> 条件的数据，读取查询引擎，执行 <code>UPDATE</code> 子句的更新，写入新的数据文件（不满足条件的也写入了，也就是 <code>copy-on-write</code> 策略；此外还有<code>merge-on-read</code> 策略）</li><li>读取不满足 <code>ON</code> 条件的外部表数据，写入另一个数据文件</li><li>创建manifest file，指向新建的两个数据文件</li><li>创建manifest list，指向该manifest file</li><li>创建新的metadata file，带有快照s2、s1和s0，<code>current-snapshot-id</code> 是s2</li><li>表的当前元数据指针指向新的metadata file</li></ol></li><li><code>SELECT * FROM xxx</code>：<ol><li>查询Iceberg catalog，获取表的当前云数据指针</li><li>读取当前元数据指针指向的metadata file，获取当前快照的manifest list地址</li><li>读取manifest list，获取manifest file地址</li><li>读取manifest file，获取所有数据文件的地址</li><li>读取所有数据文件、返回</li></ol></li><li><strong>隐式分区查询</strong> ：前面说到的，Hive的分区查询经常需要用户熟知分区物理布局，Iceberg对此进行了优化，实际操作是：a)读取 <code>metadata file</code>，获取要查询的snapshot的分区信息（有哪些字段，当前查询的是否包含在内），b)读取 <code>manifest file</code>，读取里面记录的所有数据文件的分区字段信息，与用户的查询条件做对比，找出要读取的数据文件，c)最后只读取这些数据文件</li><li><strong>Time Travel</strong>：其实就是表级版本控制，语法是 <code>SELECT * FROM xxx AS OF '日期'</code>，实际操作是：打开当前 <code>metadata file</code>，在 <code>snapshots</code> 数组查找满足查询版本日期的snapshot，后面就是正常流程（<code>manifest list</code> -> <code>manifest file</code> -> 数据文件）。</li></ol><p>注意 <strong>Time Travel</strong>，Iceberg保留了旧版本的数据，也提供了异步后台进程去清理这些旧snapshot（垃圾回收GC）。用户可以配置GC策略，这里就是存储空间的衡量了。</p><h4 id=小文件合并compaction>小文件合并（Compaction）</h4><p>Compaction是后台的异步进程，负责将一组小文件合并压缩成少量大文件，可以平衡写入和读取性能的权衡：低延迟写入需要在获取数据后尽快写入，意味着生产更多小文件；而高吞吐量读取需要单个文件保存尽量多的文件。合并操作的输入输出可以是不同的文件格式。</p><p>但Iceberg只是提供了File Format及其API和库，实际的Compaction操作由集成了Iceberg的其他工具/引擎负责调度、执行。</p><h4 id=iceberg-table-format优势>Iceberg Table Format优势</h4><ul><li>事务的快照隔离：乐观锁</li><li>更快的执行计划和执行速度：写入数据时更新统计信息、文件级跟踪统计信息</li><li>对物理布局做抽象，对用户暴露逻辑视图</li><li>所有引擎都能立即看到变化：写入时更新</li><li>事件监听器：允许在Iceberg表上发生事件时通知其他服务</li><li>有效地对数据集进行较小的更新：文件级别跟踪数据</li></ul><h3 id=iceberg基本使用>Iceberg基本使用</h3><p>目前有 Spark、Flink、PrestoDB、Hive、Impala等集成。</p><p><a class=link href=https://iceberg.apache.org/spark-quickstart/ target=_blank rel=noopener>Quick Start</a></p><p><a class=link href=https://iceberg.apache.org/docs/latest/ target=_blank rel=noopener>官方文档</a></p><p><a class=link href=https://www.dremio.com/subsurface/migrating-a-hive-table-to-an-iceberg-table-hands-on-tutorial/ target=_blank rel=noopener>从Hive迁移到Iceberg</a></p><h2 id=delta-lake-vs-iceberg>Delta Lake vs Iceberg</h2><h3 id=解决的痛点>解决的痛点</h3><p>从上面的介绍可以看出，DeltaLake和Iceberg的着重点不太一样。DataLake着眼于数仓/数据湖的架构优化、对流批一体的支持，而Iceberg站在了更高的抽象级别，定义TableFormat，制定标准和核心API，提供多种实现。</p><div class=table-wrapper><table><thead><tr><th>DeltaLake</th><th>Iceberg</th></tr></thead><tbody><tr><td>• 快速upsert/delete数据<br>• Schema限制<br>• ACID事务<br>• 多版本控制<br>• 小文件Compaction<br>• 支持流批读写</td><td>• ACID事务<br>• 多版本控制<br>• 抽象、通用、优雅<br>• 灵活的元数据管理<br>• 元数据性能(文件粒度跟踪)<br>• 隐式分区、分区演进</td></tr></tbody></table></div><h3 id=对比表>对比表</h3><div class=table-wrapper><table><thead><tr><th></th><th>Iceberg</th><th>Hudi</th><th>Delta Lake</th></tr></thead><tbody><tr><td>ACID事务</td><td>√</td><td>√</td><td>√</td></tr><tr><td>分区演进</td><td><a class=link href=https://iceberg.apache.org/docs/latest/partitioning/ target=_blank rel=noopener>分区演进</a> 支持更改分区方案；<br><a class=link href=https://iceberg.apache.org/spec/#partition-transforms target=_blank rel=noopener>分区转换</a> 可对时间戳字段以年、月、日、小时粒度隐式分区</td><td>× <a class=link href=https://docs.databricks.com/delta/delta-batch.html#deltausegeneratedcolumns target=_blank rel=noopener>Generated Columns</a>可以实现类似隐式分区的功能，但目前是Public Preview状态</td><td>× <a class=link href=https://hudi.apache.org/releases/release-0.11.0/#data-skipping-with-metadata-table target=_blank rel=noopener>Data Skipping</a>可以实现类似隐式分区的功能</td></tr><tr><td>Schema演进</td><td>增/删/改/重命名/重排列</td><td>删/改名/重排只在Spark中支持</td><td>2.0.0之前只支持增加列、列重命名、更新列、重排序，<a class=link href=https://github.com/delta-io/delta/releases/tag/v2.0.0 target=_blank rel=noopener>2.0.0</a>(2022-07-21发布)开始支持删除列</td></tr><tr><td>Time-Travel(表版本管理)</td><td>√ 通过快照实现</td><td>√</td><td>√ 每个Delta文件都代表了表对上一版本的更改，<a class=link href=https://docs.delta.io/latest/delta-batch.html#data-retention target=_blank rel=noopener>默认保留30天</a></td></tr><tr><td>项目级别</td><td>Apache顶级项目</td><td>Apache顶级项目</td><td>Linux基金会项目（Databricks TSC）</td></tr><tr><td>社区活跃度<br>(截至2022/03/28)</td><td>240贡献者<br>2241已合并PR<br>275未关闭PR</td><td>252贡献者<br>2880已合并PR<br>160未关闭PR</td><td>145贡献者<br>16已合并PR<br>43未关闭PR</td></tr><tr><td>兼容读取的工具</td><td>Apache Hive, Dremio Sonar, Apache Flink, Apache Spark, Presto, Trino, Athena, Snowflake, Databricks Spark, Apache Impala, Apache Drill</td><td>Apache Hive, Apache Flink, Apache Spark, Presto, Trino, Athena, Databricks Spark, Redshift, Apache Impala, BigQuery</td><td>Apache Hive, Dremio Sonar, Apache Flink, Databricks Spark, Apache Spark, Databricks SQL Analytics, Trino, Presto, Snowflake, Redshift, Apache Beam, Athena</td></tr><tr><td>兼容写入的工具</td><td>Apache Hive, Dremio Sonar, Apache Flink, Apache Spark, Trino, Athena, Databricks Spark, Debezium</td><td>Apache Flink, Apache Spark, Databricks Spark, Debezium, Kafka Connect</td><td>OSS Delta Lake: Trino, Apache Spark, Databricks Spark Apache Flink, Debezium.Databricks Delta Lake: Databricks Spark, Kafka Connect</td></tr><tr><td>文件格式支持</td><td>Parquet<br>ORC<br>Avro</td><td>Parquet<br>ORC</td><td>Parquet</td></tr></tbody></table></div><h3 id=社区活跃度>社区活跃度</h3><p><img src=/p/%E6%95%B0%E6%8D%AE%E6%B9%96%E8%B0%83%E7%A0%94Delta-Lake-vs-Iceberg/community1.jpeg width=653 height=386 srcset="/p/%E6%95%B0%E6%8D%AE%E6%B9%96%E8%B0%83%E7%A0%94Delta-Lake-vs-Iceberg/community1_hud8640d57255481ab82dc6a427dfb0842_60631_480x0_resize_q75_box.jpeg 480w, /p/%E6%95%B0%E6%8D%AE%E6%B9%96%E8%B0%83%E7%A0%94Delta-Lake-vs-Iceberg/community1_hud8640d57255481ab82dc6a427dfb0842_60631_1024x0_resize_q75_box.jpeg 1024w" loading=lazy alt=社区活跃度 class=gallery-image data-flex-grow=169 data-flex-basis=406px></p><p>此外值得注意的是，DeltaLake有81%的提交来自Databricks自己，而Iceberg的提交前5名提交是：Netfix 18.7%，Apple 17.1%，AWS 10.4%，Tabular 8.3%,Dremio 5.5%。</p><p>另外，整个DeltaLake项目，无论是对Issue的反应处理/回答、提PR、<a class=link href=https://github.com/delta-io/delta/issues/920 target=_blank rel=noopener>RoadMap</a> 的Issue，基本都是Databrick的员工，因此，DeltaLake相对而言没那么开放，不那么社区驱动：</p><p><img src=/p/%E6%95%B0%E6%8D%AE%E6%B9%96%E8%B0%83%E7%A0%94Delta-Lake-vs-Iceberg/community2.png width=2718 height=952 srcset="/p/%E6%95%B0%E6%8D%AE%E6%B9%96%E8%B0%83%E7%A0%94Delta-Lake-vs-Iceberg/community2_hu0a210b65b45a734162fe39533454c163_100128_480x0_resize_box_3.png 480w, /p/%E6%95%B0%E6%8D%AE%E6%B9%96%E8%B0%83%E7%A0%94Delta-Lake-vs-Iceberg/community2_hu0a210b65b45a734162fe39533454c163_100128_1024x0_resize_box_3.png 1024w" loading=lazy alt=提交比例 class=gallery-image data-flex-grow=285 data-flex-basis=685px></p><p>另一个值得注意的是DeltaLake跟Spark的绑定，及其社区版与商业版的区别（Databricks拥有自己的Delta Lake 专有分支，该分支具有仅在Databricks平台上可用的功能，Spark也是）。</p></section><footer class=article-footer><section class=article-tags><a href=/tags/DeltaLake/>DeltaLake</a>
<a href=/tags/LakeHouse/>LakeHouse</a>
<a href=/tags/IceBerg/>IceBerg</a>
<a href=/tags/DataLake/>DataLake</a>
<a href=/tags/%E6%95%B0%E6%8D%AE%E6%B9%96/>数据湖</a></section><section class=article-copyright><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-copyright" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><circle cx="12" cy="12" r="9"/><path d="M14.5 9a3.5 4 0 100 6"/></svg><span>Licensed under Apache License 2.0</span></section></footer></article><div class=disqus-container><div id=disqus_thread></div><script type=application/javascript>window.disqus_config=function(){},function(){if(["localhost","127.0.0.1"].indexOf(window.location.hostname)!=-1){document.getElementById("disqus_thread").innerHTML="Disqus comments not available by default when the website is previewed locally.";return}var t=document,e=t.createElement("script");e.async=!0,e.src="//leibnizhu.disqus.com/embed.js",e.setAttribute("data-timestamp",+new Date),(t.head||t.body).appendChild(e)}()</script><noscript>Please enable JavaScript to view the <a href=https://disqus.com/?ref_noscript>comments powered by Disqus.</a></noscript><a href=https://disqus.com class=dsq-brlink>comments powered by <span class=logo-disqus>Disqus</span></a></div><style>.disqus-container{background-color:var(--card-background);border-radius:var(--card-border-radius);box-shadow:var(--shadow-l1);padding:var(--card-padding)}</style><script>window.addEventListener("onColorSchemeChange",e=>{typeof DISQUS=="object"&&DISQUS.reset({reload:!0})})</script><footer class=site-footer><section class=copyright>&copy;
2016 -
2023 Heaven's Door</section><section class=powerby>Built with <a href=https://gohugo.io/ target=_blank rel=noopener>Hugo</a><br>Theme <b><a href=https://github.com/CaiJimmy/hugo-theme-stack target=_blank rel=noopener data-version=3.13.0>Stack</a></b> designed by <a href=https://jimmycai.com target=_blank rel=noopener>Jimmy</a></section></footer><div class=pswp tabindex=-1 role=dialog aria-hidden=true><div class=pswp__bg></div><div class=pswp__scroll-wrap><div class=pswp__container><div class=pswp__item></div><div class=pswp__item></div><div class=pswp__item></div></div><div class="pswp__ui pswp__ui--hidden"><div class=pswp__top-bar><div class=pswp__counter></div><button class="pswp__button pswp__button--close" title="Close (Esc)"></button>
<button class="pswp__button pswp__button--share" title=Share></button>
<button class="pswp__button pswp__button--fs" title="Toggle fullscreen"></button>
<button class="pswp__button pswp__button--zoom" title="Zoom in/out"></button><div class=pswp__preloader><div class=pswp__preloader__icn><div class=pswp__preloader__cut><div class=pswp__preloader__donut></div></div></div></div></div><div class="pswp__share-modal pswp__share-modal--hidden pswp__single-tap"><div class=pswp__share-tooltip></div></div><button class="pswp__button pswp__button--arrow--left" title="Previous (arrow left)"></button>
<button class="pswp__button pswp__button--arrow--right" title="Next (arrow right)"></button><div class=pswp__caption><div class=pswp__caption__center></div></div></div></div></div><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.js integrity="sha256-ePwmChbbvXbsO02lbM3HoHbSHTHFAeChekF1xKJdleo=" crossorigin=anonymous defer></script><script src=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe-ui-default.min.js integrity="sha256-UKkzOn/w1mBxRmLLGrSeyB4e1xbrp4xylgAWb3M42pU=" crossorigin=anonymous defer></script><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/default-skin/default-skin.min.css crossorigin=anonymous><link rel=stylesheet href=https://cdn.jsdelivr.net/npm/photoswipe@4.1.3/dist/photoswipe.min.css crossorigin=anonymous></main><aside class="sidebar right-sidebar sticky"><section class="widget archives"><div class=widget-icon><svg xmlns="http://www.w3.org/2000/svg" class="icon icon-tabler icon-tabler-hash" width="24" height="24" viewBox="0 0 24 24" stroke-width="2" stroke="currentcolor" fill="none" stroke-linecap="round" stroke-linejoin="round"><path stroke="none" d="M0 0h24v24H0z"/><line x1="5" y1="9" x2="19" y2="9"/><line x1="5" y1="15" x2="19" y2="15"/><line x1="11" y1="4" x2="7" y2="20"/><line x1="17" y1="4" x2="13" y2="20"/></svg></div><h2 class="widget-title section-title">Table of contents</h2><div class=widget--toc><nav id=TableOfContents><ol><li><a href=#delta-lake>Delta Lake</a><ol><li><a href=#lakehouse论文>Lakehouse论文</a></li><li><a href=#delta-lake白皮书>Delta Lake白皮书</a></li><li><a href=#deltalake基本概念与使用>DeltaLake基本概念与使用</a></li></ol></li><li><a href=#iceberg>Iceberg</a><ol><li><a href=#设计理念>设计理念</a><ol><li><a href=#what-is-iceberg>What is Iceberg</a></li><li><a href=#table-format>Table Format?</a></li><li><a href=#table-format简史>Table Format简史</a></li><li><a href=#iceberg-table-format定义>Iceberg Table Format定义</a></li><li><a href=#小文件合并compaction>小文件合并（Compaction）</a></li><li><a href=#iceberg-table-format优势>Iceberg Table Format优势</a></li></ol></li><li><a href=#iceberg基本使用>Iceberg基本使用</a></li></ol></li><li><a href=#delta-lake-vs-iceberg>Delta Lake vs Iceberg</a><ol><li><a href=#解决的痛点>解决的痛点</a></li><li><a href=#对比表>对比表</a></li><li><a href=#社区活跃度>社区活跃度</a></li></ol></li></ol></nav></div></section></aside></div><script src=https://cdn.jsdelivr.net/npm/node-vibrant@3.1.6/dist/vibrant.min.js integrity="sha256-awcR2jno4kI5X0zL8ex0vi2z+KMkF24hUW8WePSA9HM=" crossorigin=anonymous></script><script type=text/javascript src=/ts/main.js defer></script>
<script>(function(){const e=document.createElement("link");e.href="https://fonts.googleapis.com/css2?family=Lato:wght@300;400;700&display=swap",e.type="text/css",e.rel="stylesheet",document.head.appendChild(e)})()</script></body></html>