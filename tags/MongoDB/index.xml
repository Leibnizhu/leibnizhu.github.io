<?xml version="1.0" encoding="utf-8" standalone="yes"?><rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom"><channel><title>MongoDB on Heaven's Door</title><link>https://leibnizhu.github.io/tags/MongoDB/</link><description>Recent content in MongoDB on Heaven's Door</description><generator>Hugo -- gohugo.io</generator><language>en</language><lastBuildDate>Wed, 15 Jan 2020 15:47:27 +0800</lastBuildDate><atom:link href="https://leibnizhu.github.io/tags/MongoDB/index.xml" rel="self" type="application/rss+xml"/><item><title>Spark写Mongodb的小坑</title><link>https://leibnizhu.github.io/p/Spark%E5%86%99Mongodb%E7%9A%84%E5%B0%8F%E5%9D%91/</link><pubDate>Wed, 15 Jan 2020 15:47:27 +0800</pubDate><guid>https://leibnizhu.github.io/p/Spark%E5%86%99Mongodb%E7%9A%84%E5%B0%8F%E5%9D%91/</guid><description>&lt;img src="https://leibnizhu.github.io/p/Spark%E5%86%99Mongodb%E7%9A%84%E5%B0%8F%E5%9D%91/zelda.jpg" alt="Featured image of post Spark写Mongodb的小坑" />&lt;h1 id="spark写mongodb的小坑">Spark写Mongodb的小坑&lt;/h1>
&lt;p>首先证明我还活着。&lt;br>
因为Spark老集群版本限制(参见:&lt;a class="link" href="https://docs.mongodb.com/spark-connector/master/" target="_blank" rel="noopener"
>https://docs.mongodb.com/spark-connector/master/&lt;/a>)，&lt;code>mongodb-connector&lt;/code>用的版本是&lt;code>1.1.0&lt;/code>，以下坑基于该版本出现，新版本未验证。&lt;/p>
&lt;h2 id="用mongosparksave写入rdd报错e11000-duplicate-key-error">用MongoSpark.save写入RDD报错E11000 duplicate key error&lt;/h2>
&lt;p>观察源码&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#e7e9db;background-color:#2f1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-scala" data-lang="scala">&lt;span style="display:flex;">&lt;span> &lt;span style="color:#815ba4">def&lt;/span> save&lt;span style="color:#5bc4bf">[&lt;/span>&lt;span style="color:#fec418">D:&lt;/span> &lt;span style="color:#fec418">ClassTag&lt;/span>&lt;span style="color:#5bc4bf">](&lt;/span>rdd&lt;span style="color:#815ba4">:&lt;/span> &lt;span style="color:#fec418">RDD&lt;/span>&lt;span style="color:#5bc4bf">[&lt;/span>&lt;span style="color:#fec418">D&lt;/span>&lt;span style="color:#5bc4bf">],&lt;/span> writeConfig&lt;span style="color:#815ba4">:&lt;/span> &lt;span style="color:#fec418">WriteConfig&lt;/span>&lt;span style="color:#5bc4bf">)&lt;/span>&lt;span style="color:#815ba4">:&lt;/span> &lt;span style="color:#fec418">Unit&lt;/span> &lt;span style="color:#5bc4bf">=&lt;/span> &lt;span style="color:#5bc4bf">{&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#815ba4">val&lt;/span> mongoConnector &lt;span style="color:#815ba4">=&lt;/span> &lt;span style="color:#fec418">MongoConnector&lt;/span>&lt;span style="color:#5bc4bf">(&lt;/span>writeConfig&lt;span style="color:#5bc4bf">.&lt;/span>asOptions&lt;span style="color:#5bc4bf">)&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> rdd&lt;span style="color:#5bc4bf">.&lt;/span>foreachPartition&lt;span style="color:#5bc4bf">(&lt;/span>iter &lt;span style="color:#815ba4">=&amp;gt;&lt;/span> &lt;span style="color:#815ba4">if&lt;/span> &lt;span style="color:#5bc4bf">(&lt;/span>iter&lt;span style="color:#5bc4bf">.&lt;/span>nonEmpty&lt;span style="color:#5bc4bf">)&lt;/span> &lt;span style="color:#5bc4bf">{&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> mongoConnector&lt;span style="color:#5bc4bf">.&lt;/span>withCollectionDo&lt;span style="color:#5bc4bf">(&lt;/span>writeConfig&lt;span style="color:#5bc4bf">,&lt;/span> &lt;span style="color:#5bc4bf">{&lt;/span> collection&lt;span style="color:#815ba4">:&lt;/span> &lt;span style="color:#fec418">MongoCollection&lt;/span>&lt;span style="color:#5bc4bf">[&lt;/span>&lt;span style="color:#fec418">D&lt;/span>&lt;span style="color:#5bc4bf">]&lt;/span> &lt;span style="color:#815ba4">=&amp;gt;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> iter&lt;span style="color:#5bc4bf">.&lt;/span>grouped&lt;span style="color:#5bc4bf">(&lt;/span>&lt;span style="color:#fec418">DefaultMaxBatchSize&lt;/span>&lt;span style="color:#5bc4bf">).&lt;/span>foreach&lt;span style="color:#5bc4bf">(&lt;/span>batch &lt;span style="color:#815ba4">=&amp;gt;&lt;/span> collection&lt;span style="color:#5bc4bf">.&lt;/span>insertMany&lt;span style="color:#5bc4bf">(&lt;/span>batch&lt;span style="color:#5bc4bf">.&lt;/span>toList&lt;span style="color:#5bc4bf">.&lt;/span>asJava&lt;span style="color:#5bc4bf">))&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#5bc4bf">})&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#5bc4bf">})&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#5bc4bf">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>Mongo的逻辑是，纯RDD，没有schema，那么无法得知_id类型信息，于是直接insertMany。当Document数据里有_id字段时，insertMany可能就会发生_id冲突，报E11000 duplicate key error异常错误。&lt;br>
解决方案：&lt;/p>
&lt;ol>
&lt;li>改用 &lt;code>MongoSpark.save(dataFrame: DataFrame)&lt;/code>;&lt;/li>
&lt;li>爆改&lt;code>MongoSpark&lt;/code>, 将&lt;code>MongoSpark.save(rdd: RDD[D])&lt;/code>改成根据Docuemnt是否有_id而分别生成&lt;code>ReplaceOneModel&lt;/code>和&lt;code>InsertOneModel&lt;/code>，再批量插入。&lt;/li>
&lt;/ol>
&lt;p>我一开始用了方案1，后来还是觉得限制太多，但也没有直接爆改&lt;code>MongoSpark&lt;/code>，而是直接在代码里实现，不用&lt;code>MongoSpark&lt;/code>了。&lt;/p>
&lt;h2 id="list含null时写入失败">List含null时写入失败&lt;/h2>
&lt;p>原因是&lt;code>com.mongodb.spark.sql.MapFunctions&lt;/code>的&lt;code>arrayTypeToBsonValue&lt;/code>方法没有处理List里面的空元素，而是直接每个元素调&lt;code>convertToBsonValue&lt;/code>方法，后者再调用&lt;code>elementTypeToBsonValue&lt;/code>的时候，在模式匹配里面就匹配不上，进入最后的默认分支，抛&lt;code>MongoTypeConversionException&lt;/code>异常。&lt;br>
解决方案很简单：&lt;/p>
&lt;ol>
&lt;li>对数组/List做预处理，过滤null元素，但可能这些null元素是有用的，此时此法无用；&lt;/li>
&lt;li>爆改&lt;code>MapFunctions&lt;/code>：&lt;/li>
&lt;/ol>
&lt;p>其实也不算爆改，小改几个地方即可：&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#e7e9db;background-color:#2f1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-scala" data-lang="scala">&lt;span style="display:flex;">&lt;span> &lt;span style="color:#815ba4">private&lt;/span> &lt;span style="color:#815ba4">def&lt;/span> arrayTypeToBsonValue&lt;span style="color:#5bc4bf">(&lt;/span>elementType&lt;span style="color:#815ba4">:&lt;/span> &lt;span style="color:#fec418">DataType&lt;/span>&lt;span style="color:#5bc4bf">,&lt;/span> containsNull&lt;span style="color:#815ba4">:&lt;/span> &lt;span style="color:#fec418">Boolean&lt;/span>&lt;span style="color:#5bc4bf">,&lt;/span> data&lt;span style="color:#815ba4">:&lt;/span> &lt;span style="color:#fec418">Seq&lt;/span>&lt;span style="color:#5bc4bf">[&lt;/span>&lt;span style="color:#fec418">Any&lt;/span>&lt;span style="color:#5bc4bf">])&lt;/span>&lt;span style="color:#815ba4">:&lt;/span> &lt;span style="color:#fec418">BsonValue&lt;/span> &lt;span style="color:#5bc4bf">=&lt;/span> &lt;span style="color:#5bc4bf">{&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#815ba4">val&lt;/span> internalData &lt;span style="color:#815ba4">=&lt;/span> elementType &lt;span style="color:#815ba4">match&lt;/span> &lt;span style="color:#5bc4bf">{&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#776e71">/*....省略无关代码....*/&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#815ba4">case&lt;/span> &lt;span style="color:#815ba4">_&lt;/span> &lt;span style="color:#815ba4">=&amp;gt;&lt;/span> data&lt;span style="color:#5bc4bf">.&lt;/span>map&lt;span style="color:#5bc4bf">(&lt;/span>x &lt;span style="color:#815ba4">=&amp;gt;&lt;/span> &lt;span style="color:#815ba4">if&lt;/span>&lt;span style="color:#5bc4bf">(&lt;/span>x &lt;span style="color:#5bc4bf">==&lt;/span> &lt;span style="color:#815ba4">null&lt;/span> &lt;span style="color:#5bc4bf">&amp;amp;&amp;amp;&lt;/span> containsNull&lt;span style="color:#5bc4bf">)&lt;/span> &lt;span style="color:#815ba4">new&lt;/span> &lt;span style="color:#fec418">BsonNull&lt;/span>&lt;span style="color:#5bc4bf">()&lt;/span> &lt;span style="color:#815ba4">else&lt;/span> convertToBsonValue&lt;span style="color:#5bc4bf">(&lt;/span>x&lt;span style="color:#5bc4bf">,&lt;/span> elementType&lt;span style="color:#5bc4bf">)).&lt;/span>asJava
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#5bc4bf">}&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#815ba4">new&lt;/span> &lt;span style="color:#fec418">BsonArray&lt;/span>&lt;span style="color:#5bc4bf">(&lt;/span>internalData&lt;span style="color:#5bc4bf">)&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#5bc4bf">}&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#815ba4">private&lt;/span> &lt;span style="color:#815ba4">def&lt;/span> elementTypeToBsonValue&lt;span style="color:#5bc4bf">(&lt;/span>element&lt;span style="color:#815ba4">:&lt;/span> &lt;span style="color:#fec418">Any&lt;/span>&lt;span style="color:#5bc4bf">,&lt;/span> elementType&lt;span style="color:#815ba4">:&lt;/span> &lt;span style="color:#fec418">DataType&lt;/span>&lt;span style="color:#5bc4bf">)&lt;/span>&lt;span style="color:#815ba4">:&lt;/span> &lt;span style="color:#fec418">BsonValue&lt;/span> &lt;span style="color:#5bc4bf">=&lt;/span> &lt;span style="color:#5bc4bf">{&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> elementType &lt;span style="color:#815ba4">match&lt;/span> &lt;span style="color:#5bc4bf">{&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#776e71">/*....省略无关代码....*/&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#815ba4">case&lt;/span> arrayType&lt;span style="color:#815ba4">:&lt;/span> &lt;span style="color:#fec418">ArrayType&lt;/span> &lt;span style="color:#5bc4bf">=&amp;gt;&lt;/span> arrayTypeToBsonValue&lt;span style="color:#5bc4bf">(&lt;/span>arrayType&lt;span style="color:#5bc4bf">.&lt;/span>elementType&lt;span style="color:#5bc4bf">,&lt;/span> arrayType&lt;span style="color:#5bc4bf">.&lt;/span>containsNull&lt;span style="color:#5bc4bf">,&lt;/span> element&lt;span style="color:#5bc4bf">.&lt;/span>asInstanceOf&lt;span style="color:#5bc4bf">[&lt;/span>&lt;span style="color:#fec418">Seq&lt;/span>&lt;span style="color:#5bc4bf">[&lt;/span>&lt;span style="color:#815ba4">_&lt;/span>&lt;span style="color:#5bc4bf">]])&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#776e71">/*....省略无关代码....*/&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#5bc4bf">}&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#5bc4bf">}&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#815ba4">private&lt;/span> &lt;span style="color:#815ba4">def&lt;/span> mapTypeToBsonValue&lt;span style="color:#5bc4bf">(&lt;/span>valueType&lt;span style="color:#815ba4">:&lt;/span> &lt;span style="color:#fec418">DataType&lt;/span>&lt;span style="color:#5bc4bf">,&lt;/span> data&lt;span style="color:#815ba4">:&lt;/span> &lt;span style="color:#fec418">Map&lt;/span>&lt;span style="color:#5bc4bf">[&lt;/span>&lt;span style="color:#fec418">String&lt;/span>, &lt;span style="color:#fec418">Any&lt;/span>&lt;span style="color:#5bc4bf">])&lt;/span>&lt;span style="color:#815ba4">:&lt;/span> &lt;span style="color:#fec418">BsonValue&lt;/span> &lt;span style="color:#5bc4bf">=&lt;/span> &lt;span style="color:#5bc4bf">{&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#815ba4">val&lt;/span> internalData &lt;span style="color:#815ba4">=&lt;/span> valueType &lt;span style="color:#815ba4">match&lt;/span> &lt;span style="color:#5bc4bf">{&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#776e71">/*....省略无关代码....*/&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#815ba4">case&lt;/span> subArray&lt;span style="color:#815ba4">:&lt;/span> &lt;span style="color:#fec418">ArrayType&lt;/span> &lt;span style="color:#5bc4bf">=&amp;gt;&lt;/span> data&lt;span style="color:#5bc4bf">.&lt;/span>map&lt;span style="color:#5bc4bf">(&lt;/span>kv &lt;span style="color:#815ba4">=&amp;gt;&lt;/span> &lt;span style="color:#815ba4">new&lt;/span> &lt;span style="color:#fec418">BsonElement&lt;/span>&lt;span style="color:#5bc4bf">(&lt;/span>kv&lt;span style="color:#5bc4bf">.&lt;/span>_1&lt;span style="color:#5bc4bf">,&lt;/span> arrayTypeToBsonValue&lt;span style="color:#5bc4bf">(&lt;/span>subArray&lt;span style="color:#5bc4bf">.&lt;/span>elementType&lt;span style="color:#5bc4bf">,&lt;/span> subArray&lt;span style="color:#5bc4bf">.&lt;/span>containsNull&lt;span style="color:#5bc4bf">,&lt;/span> kv&lt;span style="color:#5bc4bf">.&lt;/span>_2&lt;span style="color:#5bc4bf">.&lt;/span>asInstanceOf&lt;span style="color:#5bc4bf">[&lt;/span>&lt;span style="color:#fec418">Seq&lt;/span>&lt;span style="color:#5bc4bf">[&lt;/span>&lt;span style="color:#fec418">Any&lt;/span>&lt;span style="color:#5bc4bf">]])))&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#776e71">/*....省略无关代码....*/&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#5bc4bf">}&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#815ba4">new&lt;/span> &lt;span style="color:#fec418">BsonDocument&lt;/span>&lt;span style="color:#5bc4bf">(&lt;/span>internalData&lt;span style="color:#5bc4bf">.&lt;/span>toList&lt;span style="color:#5bc4bf">.&lt;/span>asJava&lt;span style="color:#5bc4bf">)&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#5bc4bf">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;h2 id="objectid对象写入">ObjectId对象写入&lt;/h2>
&lt;p>Mongodb的_id默认是用ObjectId类型，如果在修改数据后重新写入Mongodb，也需要使用同样的ObjectId对象。&lt;br>
在直接使用Mongodb的SDK的情况，这个很简单，直接new一个&lt;code>org.bson.types.ObjectId&lt;/code>对象即可。&lt;br>
如果是使用DataFrame，则structType和具体的Row数据构造都有一小点麻烦，直接上代码吧。&lt;br>
构建Schema：&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#e7e9db;background-color:#2f1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-scala" data-lang="scala">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#815ba4">var&lt;/span> structFieldList &lt;span style="color:#815ba4">=&lt;/span> &lt;span style="color:#fec418">List&lt;/span>&lt;span style="color:#5bc4bf">()&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#776e71">/*....其他字段schema信息....*/&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#815ba4">val&lt;/span> idDataType &lt;span style="color:#815ba4">=&lt;/span> &lt;span style="color:#fec418">StructType&lt;/span>&lt;span style="color:#5bc4bf">(&lt;/span>&lt;span style="color:#fec418">List&lt;/span>&lt;span style="color:#5bc4bf">(&lt;/span>&lt;span style="color:#fec418">StructField&lt;/span>&lt;span style="color:#5bc4bf">(&lt;/span>&lt;span style="color:#48b685">&amp;#34;oid&amp;#34;&lt;/span>&lt;span style="color:#5bc4bf">,&lt;/span> &lt;span style="color:#fec418">StringType&lt;/span>&lt;span style="color:#5bc4bf">,&lt;/span> &lt;span style="color:#815ba4">true&lt;/span>&lt;span style="color:#5bc4bf">,&lt;/span> &lt;span style="color:#fec418">Metadata&lt;/span>&lt;span style="color:#5bc4bf">.&lt;/span>empty&lt;span style="color:#5bc4bf">)))&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>structFieldList &lt;span style="color:#5bc4bf">+=&lt;/span> &lt;span style="color:#fec418">StructField&lt;/span>&lt;span style="color:#5bc4bf">(&lt;/span>&lt;span style="color:#48b685">&amp;#34;_id&amp;#34;&lt;/span>&lt;span style="color:#5bc4bf">,&lt;/span> idDataType&lt;span style="color:#5bc4bf">,&lt;/span> &lt;span style="color:#815ba4">true&lt;/span>&lt;span style="color:#5bc4bf">,&lt;/span> &lt;span style="color:#fec418">Metadata&lt;/span>&lt;span style="color:#5bc4bf">.&lt;/span>empty&lt;span style="color:#5bc4bf">))&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#fec418">StructType&lt;/span>&lt;span style="color:#5bc4bf">(&lt;/span>structFieldList&lt;span style="color:#5bc4bf">);&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>写入数据的处理：&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#e7e9db;background-color:#2f1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-scala" data-lang="scala">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#fec418">GenericRow&lt;/span>&lt;span style="color:#5bc4bf">(&lt;/span>&lt;span style="color:#fec418">Array&lt;/span>&lt;span style="color:#5bc4bf">(&lt;/span>&lt;span style="color:#48b685">&amp;#34;5e1db87e5d080f6e7eb7b067&amp;#34;&lt;/span>&lt;span style="color:#5bc4bf">))&lt;/span> &lt;span style="color:#776e71">//这是一个Row里面的一个字段值
&lt;/span>&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div></description></item></channel></rss>