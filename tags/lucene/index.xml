<?xml version="1.0" encoding="utf-8" standalone="yes"?><rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom"><channel><title>lucene on Heaven's Door</title><link>https://leibnizhu.github.io/tags/lucene/</link><description>Recent content in lucene on Heaven's Door</description><generator>Hugo -- gohugo.io</generator><language>en-us</language><lastBuildDate>Tue, 15 May 2018 16:38:41 +0000</lastBuildDate><atom:link href="https://leibnizhu.github.io/tags/lucene/index.xml" rel="self" type="application/rss+xml"/><item><title>Lucene7获取所有有效文档</title><link>https://leibnizhu.github.io/p/Lucene7%E8%8E%B7%E5%8F%96%E6%89%80%E6%9C%89%E6%9C%89%E6%95%88%E6%96%87%E6%A1%A3/</link><pubDate>Tue, 15 May 2018 16:38:41 +0000</pubDate><guid>https://leibnizhu.github.io/p/Lucene7%E8%8E%B7%E5%8F%96%E6%89%80%E6%9C%89%E6%9C%89%E6%95%88%E6%96%87%E6%A1%A3/</guid><description>&lt;img src="https://leibnizhu.github.io/p/Lucene7%E8%8E%B7%E5%8F%96%E6%89%80%E6%9C%89%E6%9C%89%E6%95%88%E6%96%87%E6%A1%A3/mikuwing.jpg" alt="Featured image of post Lucene7获取所有有效文档" />&lt;p>最近在写一个&lt;code>Vert.X+Lucene&lt;/code>的搜索引擎,为Vert.X中国论坛提供的(详见&lt;a class="link" href="https://github.com/Leibnizhu/vertXearch" target="_blank" rel="noopener"
>Github&lt;/a>),在尝试更新文档索引的时候,遇到如何获取所有有效文档的问题(未被删除索引的). 官方没有直接查询的API,在Google和Stack Overflow搜了之后没有满意的效果,网上的资源很多都是Lucene 6甚至更老的3,4版本的,有些API已经过时.&lt;br>
经过深入查阅官方API文档之后,终于找到了解决方案.&lt;br>
Lucene删除索引之后,通过&lt;code>IndexReader.document()&lt;/code>还是可以查到的,因此当有文档被删除后,不能直接用这个来查; 而&lt;code>MultiFields.getLiveDocs()&lt;/code>在没有删除文档时返回&lt;code>null&lt;/code>,有删除过文档时返回一个&lt;code>Bits&lt;/code>对象,这里面可以通过&lt;code>get()&lt;/code>方法,获取每个documentID是否有效(未被删除).&lt;br>
因此可以这样写:&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#e7e9db;background-color:#2f1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-scala" data-lang="scala">&lt;span style="display:flex;">&lt;span> &lt;span style="color:#815ba4">private&lt;/span> &lt;span style="color:#815ba4">val&lt;/span> indexDirectory &lt;span style="color:#815ba4">=&lt;/span> &lt;span style="color:#fec418">FSDirectory&lt;/span>&lt;span style="color:#5bc4bf">.&lt;/span>open&lt;span style="color:#5bc4bf">(&lt;/span>&lt;span style="color:#fec418">Paths&lt;/span>&lt;span style="color:#5bc4bf">.&lt;/span>get&lt;span style="color:#5bc4bf">(&lt;/span>indexDirectoryPath&lt;span style="color:#5bc4bf">))&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#815ba4">private&lt;/span> &lt;span style="color:#815ba4">var&lt;/span> reader&lt;span style="color:#815ba4">:&lt;/span> &lt;span style="color:#fec418">DirectoryReader&lt;/span> &lt;span style="color:#5bc4bf">=&lt;/span> &lt;span style="color:#fec418">DirectoryReader&lt;/span>&lt;span style="color:#5bc4bf">.&lt;/span>open&lt;span style="color:#5bc4bf">(&lt;/span>indexDirectory&lt;span style="color:#5bc4bf">)&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#815ba4">var&lt;/span> indexSearcher &lt;span style="color:#815ba4">=&lt;/span> &lt;span style="color:#815ba4">new&lt;/span> &lt;span style="color:#fec418">IndexSearcher&lt;/span>&lt;span style="color:#5bc4bf">(&lt;/span>reader&lt;span style="color:#5bc4bf">)&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#776e71">/**
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#776e71"> * 获取所有有效文档
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#776e71"> *
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#776e71"> * @return
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#776e71"> */&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#815ba4">def&lt;/span> getAllDocuments&lt;span style="color:#815ba4">:&lt;/span> &lt;span style="color:#fec418">List&lt;/span>&lt;span style="color:#5bc4bf">[&lt;/span>&lt;span style="color:#fec418">Document&lt;/span>&lt;span style="color:#5bc4bf">]&lt;/span> &lt;span style="color:#815ba4">=&lt;/span> &lt;span style="color:#5bc4bf">{&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#776e71">//获取有哪些存活的文档
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#776e71">&lt;/span> &lt;span style="color:#815ba4">val&lt;/span> liveDocs &lt;span style="color:#815ba4">=&lt;/span> &lt;span style="color:#fec418">MultiFields&lt;/span>&lt;span style="color:#5bc4bf">.&lt;/span>getLiveDocs&lt;span style="color:#5bc4bf">(&lt;/span>reader&lt;span style="color:#5bc4bf">)&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#815ba4">if&lt;/span> &lt;span style="color:#5bc4bf">(&lt;/span>liveDocs &lt;span style="color:#5bc4bf">!=&lt;/span> &lt;span style="color:#815ba4">null&lt;/span>&lt;span style="color:#5bc4bf">)&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#776e71">//liveDocs非null时有删除过文件,遍历所有文档ID,liveDocs.get为true的话就是存活的,要过滤存活的文档对象
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#776e71">&lt;/span> &lt;span style="color:#5bc4bf">(&lt;/span>&lt;span style="color:#f99b15">0&lt;/span> until reader&lt;span style="color:#5bc4bf">.&lt;/span>maxDoc&lt;span style="color:#5bc4bf">()).&lt;/span>filter&lt;span style="color:#5bc4bf">(&lt;/span>liveDocs&lt;span style="color:#5bc4bf">.&lt;/span>get&lt;span style="color:#5bc4bf">).&lt;/span>map&lt;span style="color:#5bc4bf">(&lt;/span>reader&lt;span style="color:#5bc4bf">.&lt;/span>document&lt;span style="color:#5bc4bf">(&lt;/span>&lt;span style="color:#815ba4">_&lt;/span>&lt;span style="color:#5bc4bf">)).&lt;/span>toList
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#815ba4">else&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#776e71">//没有删除过文件的时候liveDocs为null,此时只能直接通过IndexSearcher去查询
&lt;/span>&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#776e71">&lt;/span> topDocsToDocumentList&lt;span style="color:#5bc4bf">(&lt;/span>indexSearcher&lt;span style="color:#5bc4bf">.&lt;/span>search&lt;span style="color:#5bc4bf">(&lt;/span>&lt;span style="color:#815ba4">new&lt;/span> &lt;span style="color:#fec418">MatchAllDocsQuery&lt;/span>&lt;span style="color:#5bc4bf">,&lt;/span> &lt;span style="color:#fec418">Integer&lt;/span>&lt;span style="color:#5bc4bf">.&lt;/span>&lt;span style="color:#fec418">MAX_VALUE&lt;/span>&lt;span style="color:#5bc4bf">))&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#5bc4bf">}&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#815ba4">def&lt;/span> topDocsToDocumentList&lt;span style="color:#5bc4bf">(&lt;/span>topDocs&lt;span style="color:#815ba4">:&lt;/span> &lt;span style="color:#fec418">TopDocs&lt;/span>&lt;span style="color:#5bc4bf">)&lt;/span>&lt;span style="color:#815ba4">:&lt;/span> &lt;span style="color:#fec418">List&lt;/span>&lt;span style="color:#5bc4bf">[&lt;/span>&lt;span style="color:#fec418">Document&lt;/span>&lt;span style="color:#5bc4bf">]&lt;/span> &lt;span style="color:#815ba4">=&lt;/span> topDocs&lt;span style="color:#5bc4bf">.&lt;/span>scoreDocs&lt;span style="color:#5bc4bf">.&lt;/span>map&lt;span style="color:#5bc4bf">(&lt;/span>&lt;span style="color:#815ba4">this&lt;/span>&lt;span style="color:#5bc4bf">.&lt;/span>getDocument&lt;span style="color:#5bc4bf">).&lt;/span>toList
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div></description></item></channel></rss>