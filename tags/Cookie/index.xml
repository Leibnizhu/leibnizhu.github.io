<?xml version="1.0" encoding="utf-8" standalone="yes"?><rss version="2.0" xmlns:atom="http://www.w3.org/2005/Atom"><channel><title>Cookie on Heaven's Door</title><link>https://leibnizhu.github.io/tags/Cookie/</link><description>Recent content in Cookie on Heaven's Door</description><generator>Hugo -- gohugo.io</generator><language>en-us</language><lastBuildDate>Thu, 12 Jan 2017 14:01:25 +0800</lastBuildDate><atom:link href="https://leibnizhu.github.io/tags/Cookie/index.xml" rel="self" type="application/rss+xml"/><item><title>js跨域获取Cookie的一种新方法</title><link>https://leibnizhu.github.io/p/js%E8%B7%A8%E5%9F%9F%E8%8E%B7%E5%8F%96Cookie%E7%9A%84%E4%B8%80%E7%A7%8D%E6%96%B0%E6%96%B9%E6%B3%95/</link><pubDate>Thu, 12 Jan 2017 14:01:25 +0800</pubDate><guid>https://leibnizhu.github.io/p/js%E8%B7%A8%E5%9F%9F%E8%8E%B7%E5%8F%96Cookie%E7%9A%84%E4%B8%80%E7%A7%8D%E6%96%B0%E6%96%B9%E6%B3%95/</guid><description>&lt;h2 id="背景">背景&lt;/h2>
&lt;p>同一个项目分配了多个域名，在其中一个域名（下称域名A）的一级域名上放了Cookie。&lt;br>
使用其他域名(下面统称域名B*)去访问某些页面时，需要使用js读取域名A下的那个Cookie。&lt;/p>
&lt;h2 id="已有的解决方案">已有的解决方案&lt;/h2>
&lt;p>网上已经有一些解决方案，如：&lt;a class="link" href="https://m.th7.cn/show/22/201503/88209.htm" target="_blank" rel="noopener"
>JS跨域（ajax跨域、iframe跨域）解决方法及原理详解（jsonp）&lt;/a>、&lt;a class="link" href="http://www.cnblogs.com/chris-shao/archive/2012/12/27/2835986.html" target="_blank" rel="noopener"
>JS 获取跨域的cookie&lt;/a>。&lt;br>
其中document.domain的方法已确认不可用于我的需求，iframe跨域可以实现，但是跨域后的页面在iframe中，此时js变量的作用域只在iframe中，需要通过一个中间元素的值或者属性来写入需要传递的值，比较麻烦；document.name的方法虽然可以跨域，但同时也跨页面了，处理起来要小心点。&lt;/p>
&lt;h2 id="本文的解决方案">本文的解决方案&lt;/h2>
&lt;h3 id="原理">原理&lt;/h3>
&lt;p>在域名B*的页面上，js的确不能直接获取到域名A的cookie，但显然，域名B*的页面如果发请求到域名A，会带上域名A的Cookie。&lt;br>
针对这一点，只要我们在域名A上面部署一个微服务，域名B*的页面发AJAX请求到这个服务，返回域名A的Cookie中我们感兴趣字段的值。域名B*的页面就能接收到域名A的Cookie，可以各种利用了。&lt;/p>
&lt;h3 id="netty实现">Netty实现&lt;/h3>
&lt;p>域名A的服务器端选用Netty实现。实现代码很简单，这里只给出核心Handler部分代码：&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#e7e9db;background-color:#2f1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-java" data-lang="java">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#815ba4">public&lt;/span> &lt;span style="color:#815ba4">class&lt;/span> &lt;span style="color:#fec418">RPCMissionHandler&lt;/span> &lt;span style="color:#815ba4">extends&lt;/span> SimpleChannelInboundHandler&lt;span style="color:#5bc4bf">&amp;lt;&lt;/span>FullHttpRequest&lt;span style="color:#5bc4bf">&amp;gt;&lt;/span> &lt;span style="color:#5bc4bf">{&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#815ba4">private&lt;/span> &lt;span style="color:#815ba4">static&lt;/span> Logger LOG &lt;span style="color:#5bc4bf">=&lt;/span> Logger&lt;span style="color:#5bc4bf">.&lt;/span>&lt;span style="color:#06b6ef">getLogger&lt;/span>&lt;span style="color:#5bc4bf">(&lt;/span>RPCMissionHandler&lt;span style="color:#5bc4bf">.&lt;/span>&lt;span style="color:#06b6ef">class&lt;/span>&lt;span style="color:#5bc4bf">);&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#5bc4bf">@Override&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#815ba4">public&lt;/span> &lt;span style="color:#fec418">void&lt;/span> &lt;span style="color:#06b6ef">channelRead0&lt;/span>&lt;span style="color:#5bc4bf">(&lt;/span>ChannelHandlerContext ctx&lt;span style="color:#5bc4bf">,&lt;/span> FullHttpRequest req&lt;span style="color:#5bc4bf">)&lt;/span> &lt;span style="color:#815ba4">throws&lt;/span> Exception &lt;span style="color:#5bc4bf">{&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#815ba4">if&lt;/span>&lt;span style="color:#5bc4bf">(!&lt;/span>req&lt;span style="color:#5bc4bf">.&lt;/span>&lt;span style="color:#06b6ef">decoderResult&lt;/span>&lt;span style="color:#5bc4bf">().&lt;/span>&lt;span style="color:#06b6ef">isSuccess&lt;/span>&lt;span style="color:#5bc4bf">()){&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> sendError&lt;span style="color:#5bc4bf">(&lt;/span>ctx&lt;span style="color:#5bc4bf">,&lt;/span> BAD_REQUEST&lt;span style="color:#5bc4bf">);&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#815ba4">return&lt;/span>&lt;span style="color:#5bc4bf">;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#5bc4bf">}&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#815ba4">if&lt;/span>&lt;span style="color:#5bc4bf">(&lt;/span>req&lt;span style="color:#5bc4bf">.&lt;/span>&lt;span style="color:#06b6ef">method&lt;/span>&lt;span style="color:#5bc4bf">()&lt;/span> &lt;span style="color:#5bc4bf">!=&lt;/span> GET&lt;span style="color:#5bc4bf">){&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> sendError&lt;span style="color:#5bc4bf">(&lt;/span>ctx&lt;span style="color:#5bc4bf">,&lt;/span> METHOD_NOT_ALLOWED&lt;span style="color:#5bc4bf">);&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#815ba4">return&lt;/span>&lt;span style="color:#5bc4bf">;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#5bc4bf">}&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> String uri &lt;span style="color:#5bc4bf">=&lt;/span> req&lt;span style="color:#5bc4bf">.&lt;/span>&lt;span style="color:#06b6ef">uri&lt;/span>&lt;span style="color:#5bc4bf">();&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> String paramUri &lt;span style="color:#5bc4bf">=&lt;/span> uri&lt;span style="color:#5bc4bf">.&lt;/span>&lt;span style="color:#06b6ef">substring&lt;/span>&lt;span style="color:#5bc4bf">(&lt;/span>uri&lt;span style="color:#5bc4bf">.&lt;/span>&lt;span style="color:#06b6ef">indexOf&lt;/span>&lt;span style="color:#5bc4bf">(&lt;/span>&lt;span style="color:#48b685">&amp;#34;?&amp;#34;&lt;/span>&lt;span style="color:#5bc4bf">)&lt;/span> &lt;span style="color:#5bc4bf">+&lt;/span> &lt;span style="color:#f99b15">1&lt;/span>&lt;span style="color:#5bc4bf">);&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> List&lt;span style="color:#5bc4bf">&amp;lt;&lt;/span>NameValuePair&lt;span style="color:#5bc4bf">&amp;gt;&lt;/span> params &lt;span style="color:#5bc4bf">=&lt;/span> URLEncodedUtils&lt;span style="color:#5bc4bf">.&lt;/span>&lt;span style="color:#06b6ef">parse&lt;/span>&lt;span style="color:#5bc4bf">(&lt;/span>paramUri&lt;span style="color:#5bc4bf">,&lt;/span> Charset&lt;span style="color:#5bc4bf">.&lt;/span>&lt;span style="color:#06b6ef">forName&lt;/span>&lt;span style="color:#5bc4bf">(&lt;/span>&lt;span style="color:#48b685">&amp;#34;UTF-8&amp;#34;&lt;/span>&lt;span style="color:#5bc4bf">));&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#815ba4">if&lt;/span>&lt;span style="color:#5bc4bf">(&lt;/span>uri&lt;span style="color:#5bc4bf">.&lt;/span>&lt;span style="color:#06b6ef">startsWith&lt;/span>&lt;span style="color:#5bc4bf">(&lt;/span>&lt;span style="color:#48b685">&amp;#34;/getid&amp;#34;&lt;/span>&lt;span style="color:#5bc4bf">)){&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> String refererDomain &lt;span style="color:#5bc4bf">=&lt;/span> &lt;span style="color:#815ba4">null&lt;/span>&lt;span style="color:#5bc4bf">;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#815ba4">for&lt;/span>&lt;span style="color:#5bc4bf">(&lt;/span>NameValuePair pair &lt;span style="color:#5bc4bf">:&lt;/span> params&lt;span style="color:#5bc4bf">){&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#815ba4">if&lt;/span>&lt;span style="color:#5bc4bf">(&lt;/span>&lt;span style="color:#48b685">&amp;#34;domain&amp;#34;&lt;/span>&lt;span style="color:#5bc4bf">.&lt;/span>&lt;span style="color:#06b6ef">equals&lt;/span>&lt;span style="color:#5bc4bf">(&lt;/span>pair&lt;span style="color:#5bc4bf">.&lt;/span>&lt;span style="color:#06b6ef">getName&lt;/span>&lt;span style="color:#5bc4bf">())){&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> refererDomain &lt;span style="color:#5bc4bf">=&lt;/span> pair&lt;span style="color:#5bc4bf">.&lt;/span>&lt;span style="color:#06b6ef">getValue&lt;/span>&lt;span style="color:#5bc4bf">();&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#5bc4bf">}&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#5bc4bf">}&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#815ba4">if&lt;/span>&lt;span style="color:#5bc4bf">(&lt;/span>refererDomain &lt;span style="color:#5bc4bf">!=&lt;/span> &lt;span style="color:#815ba4">null&lt;/span>&lt;span style="color:#5bc4bf">){&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#815ba4">if&lt;/span>&lt;span style="color:#5bc4bf">(&lt;/span>req&lt;span style="color:#5bc4bf">.&lt;/span>&lt;span style="color:#06b6ef">headers&lt;/span>&lt;span style="color:#5bc4bf">().&lt;/span>&lt;span style="color:#06b6ef">get&lt;/span>&lt;span style="color:#5bc4bf">(&lt;/span>&lt;span style="color:#48b685">&amp;#34;Cookie&amp;#34;&lt;/span>&lt;span style="color:#5bc4bf">)&lt;/span> &lt;span style="color:#5bc4bf">!=&lt;/span> &lt;span style="color:#815ba4">null&lt;/span>&lt;span style="color:#5bc4bf">)&lt;/span> &lt;span style="color:#5bc4bf">{&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> Set&lt;span style="color:#5bc4bf">&amp;lt;&lt;/span>Cookie&lt;span style="color:#5bc4bf">&amp;gt;&lt;/span> cookies &lt;span style="color:#5bc4bf">=&lt;/span> CookieDecoder&lt;span style="color:#5bc4bf">.&lt;/span>&lt;span style="color:#06b6ef">decode&lt;/span>&lt;span style="color:#5bc4bf">(&lt;/span>req&lt;span style="color:#5bc4bf">.&lt;/span>&lt;span style="color:#06b6ef">headers&lt;/span>&lt;span style="color:#5bc4bf">().&lt;/span>&lt;span style="color:#06b6ef">get&lt;/span>&lt;span style="color:#5bc4bf">(&lt;/span>&lt;span style="color:#48b685">&amp;#34;Cookie&amp;#34;&lt;/span>&lt;span style="color:#5bc4bf">));&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#815ba4">for&lt;/span> &lt;span style="color:#5bc4bf">(&lt;/span>Cookie cookie &lt;span style="color:#5bc4bf">:&lt;/span> cookies&lt;span style="color:#5bc4bf">)&lt;/span> &lt;span style="color:#5bc4bf">{&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#815ba4">if&lt;/span> &lt;span style="color:#5bc4bf">(&lt;/span>&lt;span style="color:#48b685">&amp;#34;ID&amp;#34;&lt;/span>&lt;span style="color:#5bc4bf">.&lt;/span>&lt;span style="color:#06b6ef">equals&lt;/span>&lt;span style="color:#5bc4bf">(&lt;/span>cookie&lt;span style="color:#5bc4bf">.&lt;/span>&lt;span style="color:#06b6ef">name&lt;/span>&lt;span style="color:#5bc4bf">()))&lt;/span> &lt;span style="color:#5bc4bf">{&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> LOG&lt;span style="color:#5bc4bf">.&lt;/span>&lt;span style="color:#06b6ef">info&lt;/span>&lt;span style="color:#5bc4bf">(&lt;/span>&lt;span style="color:#48b685">&amp;#34;Request ID = &amp;#34;&lt;/span> &lt;span style="color:#5bc4bf">+&lt;/span> cookie&lt;span style="color:#5bc4bf">.&lt;/span>&lt;span style="color:#06b6ef">value&lt;/span>&lt;span style="color:#5bc4bf">());&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> responseWithString&lt;span style="color:#5bc4bf">(&lt;/span>ctx&lt;span style="color:#5bc4bf">,&lt;/span> cookie&lt;span style="color:#5bc4bf">.&lt;/span>&lt;span style="color:#06b6ef">value&lt;/span>&lt;span style="color:#5bc4bf">(),&lt;/span> &lt;span style="color:#48b685">&amp;#34;http://&amp;#34;&lt;/span> &lt;span style="color:#5bc4bf">+&lt;/span> refererDomain&lt;span style="color:#5bc4bf">);&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#815ba4">return&lt;/span>&lt;span style="color:#5bc4bf">;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#5bc4bf">}&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#5bc4bf">}&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#5bc4bf">}&lt;/span> &lt;span style="color:#815ba4">else&lt;/span> &lt;span style="color:#5bc4bf">{&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> responseWithString&lt;span style="color:#5bc4bf">(&lt;/span>ctx&lt;span style="color:#5bc4bf">,&lt;/span> &lt;span style="color:#48b685">&amp;#34;&amp;#34;&lt;/span>&lt;span style="color:#5bc4bf">,&lt;/span> &lt;span style="color:#48b685">&amp;#34;http://&amp;#34;&lt;/span> &lt;span style="color:#5bc4bf">+&lt;/span> refererDomain&lt;span style="color:#5bc4bf">);&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#815ba4">return&lt;/span>&lt;span style="color:#5bc4bf">;&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#5bc4bf">}&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#5bc4bf">}&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#5bc4bf">}&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> responseWithImage&lt;span style="color:#5bc4bf">(&lt;/span>ctx&lt;span style="color:#5bc4bf">);&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#5bc4bf">}&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#815ba4">private&lt;/span> &lt;span style="color:#fec418">void&lt;/span> &lt;span style="color:#06b6ef">responseWithString&lt;/span>&lt;span style="color:#5bc4bf">(&lt;/span>ChannelHandlerContext ctx&lt;span style="color:#5bc4bf">,&lt;/span> String data&lt;span style="color:#5bc4bf">,&lt;/span> String referer&lt;span style="color:#5bc4bf">)&lt;/span> &lt;span style="color:#5bc4bf">{&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> FullHttpResponse resp &lt;span style="color:#5bc4bf">=&lt;/span> &lt;span style="color:#815ba4">new&lt;/span> DefaultFullHttpResponse&lt;span style="color:#5bc4bf">(&lt;/span>HttpVersion&lt;span style="color:#5bc4bf">.&lt;/span>&lt;span style="color:#06b6ef">HTTP_1_1&lt;/span>&lt;span style="color:#5bc4bf">,&lt;/span> OK&lt;span style="color:#5bc4bf">);&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#776e71">/*配置不缓存*/&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> resp&lt;span style="color:#5bc4bf">.&lt;/span>&lt;span style="color:#06b6ef">headers&lt;/span>&lt;span style="color:#5bc4bf">().&lt;/span>&lt;span style="color:#06b6ef">set&lt;/span>&lt;span style="color:#5bc4bf">(&lt;/span>&lt;span style="color:#48b685">&amp;#34;Cache-Control&amp;#34;&lt;/span>&lt;span style="color:#5bc4bf">,&lt;/span> &lt;span style="color:#48b685">&amp;#34;no-cache&amp;#34;&lt;/span>&lt;span style="color:#5bc4bf">);&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> resp&lt;span style="color:#5bc4bf">.&lt;/span>&lt;span style="color:#06b6ef">headers&lt;/span>&lt;span style="color:#5bc4bf">().&lt;/span>&lt;span style="color:#06b6ef">set&lt;/span>&lt;span style="color:#5bc4bf">(&lt;/span>&lt;span style="color:#48b685">&amp;#34;Pragma&amp;#34;&lt;/span>&lt;span style="color:#5bc4bf">,&lt;/span> &lt;span style="color:#48b685">&amp;#34;no-cache&amp;#34;&lt;/span>&lt;span style="color:#5bc4bf">);&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> resp&lt;span style="color:#5bc4bf">.&lt;/span>&lt;span style="color:#06b6ef">headers&lt;/span>&lt;span style="color:#5bc4bf">().&lt;/span>&lt;span style="color:#06b6ef">set&lt;/span>&lt;span style="color:#5bc4bf">(&lt;/span>&lt;span style="color:#48b685">&amp;#34;Expires&amp;#34;&lt;/span>&lt;span style="color:#5bc4bf">,&lt;/span> &lt;span style="color:#48b685">&amp;#34;Wed, 31 Dec 1969 23:59:59 GMT&amp;#34;&lt;/span>&lt;span style="color:#5bc4bf">);&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#776e71">/*配置跨域允许*/&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> resp&lt;span style="color:#5bc4bf">.&lt;/span>&lt;span style="color:#06b6ef">headers&lt;/span>&lt;span style="color:#5bc4bf">().&lt;/span>&lt;span style="color:#06b6ef">set&lt;/span>&lt;span style="color:#5bc4bf">(&lt;/span>&lt;span style="color:#48b685">&amp;#34;Access-Control-Allow-origin&amp;#34;&lt;/span>&lt;span style="color:#5bc4bf">,&lt;/span> referer&lt;span style="color:#5bc4bf">);&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> resp&lt;span style="color:#5bc4bf">.&lt;/span>&lt;span style="color:#06b6ef">headers&lt;/span>&lt;span style="color:#5bc4bf">().&lt;/span>&lt;span style="color:#06b6ef">set&lt;/span>&lt;span style="color:#5bc4bf">(&lt;/span>&lt;span style="color:#48b685">&amp;#34;Access-Control-Allow-Methods&amp;#34;&lt;/span>&lt;span style="color:#5bc4bf">,&lt;/span> &lt;span style="color:#48b685">&amp;#34;GET, POST&amp;#34;&lt;/span>&lt;span style="color:#5bc4bf">);&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> resp&lt;span style="color:#5bc4bf">.&lt;/span>&lt;span style="color:#06b6ef">headers&lt;/span>&lt;span style="color:#5bc4bf">().&lt;/span>&lt;span style="color:#06b6ef">set&lt;/span>&lt;span style="color:#5bc4bf">(&lt;/span>&lt;span style="color:#48b685">&amp;#34;Access-Control-Allow-Credentials&amp;#34;&lt;/span>&lt;span style="color:#5bc4bf">,&lt;/span> &lt;span style="color:#48b685">&amp;#34;true&amp;#34;&lt;/span>&lt;span style="color:#5bc4bf">);&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#776e71">/*响应类型*/&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> resp&lt;span style="color:#5bc4bf">.&lt;/span>&lt;span style="color:#06b6ef">headers&lt;/span>&lt;span style="color:#5bc4bf">().&lt;/span>&lt;span style="color:#06b6ef">set&lt;/span>&lt;span style="color:#5bc4bf">(&lt;/span>&lt;span style="color:#48b685">&amp;#34;Content-Type&amp;#34;&lt;/span>&lt;span style="color:#5bc4bf">,&lt;/span> &lt;span style="color:#48b685">&amp;#34;text/html;charset=UTF-8&amp;#34;&lt;/span>&lt;span style="color:#5bc4bf">);&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> ByteBuf buf &lt;span style="color:#5bc4bf">=&lt;/span> Unpooled&lt;span style="color:#5bc4bf">.&lt;/span>&lt;span style="color:#06b6ef">copiedBuffer&lt;/span>&lt;span style="color:#5bc4bf">(&lt;/span>&lt;span style="color:#815ba4">new&lt;/span> StringBuffer&lt;span style="color:#5bc4bf">(&lt;/span>data&lt;span style="color:#5bc4bf">),&lt;/span> CharsetUtil&lt;span style="color:#5bc4bf">.&lt;/span>&lt;span style="color:#06b6ef">UTF_8&lt;/span>&lt;span style="color:#5bc4bf">);&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> resp&lt;span style="color:#5bc4bf">.&lt;/span>&lt;span style="color:#06b6ef">content&lt;/span>&lt;span style="color:#5bc4bf">().&lt;/span>&lt;span style="color:#06b6ef">writeBytes&lt;/span>&lt;span style="color:#5bc4bf">(&lt;/span>buf&lt;span style="color:#5bc4bf">);&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> buf&lt;span style="color:#5bc4bf">.&lt;/span>&lt;span style="color:#06b6ef">release&lt;/span>&lt;span style="color:#5bc4bf">();&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> ctx&lt;span style="color:#5bc4bf">.&lt;/span>&lt;span style="color:#06b6ef">writeAndFlush&lt;/span>&lt;span style="color:#5bc4bf">(&lt;/span>resp&lt;span style="color:#5bc4bf">).&lt;/span>&lt;span style="color:#06b6ef">addListener&lt;/span>&lt;span style="color:#5bc4bf">(&lt;/span>ChannelFutureListener&lt;span style="color:#5bc4bf">.&lt;/span>&lt;span style="color:#06b6ef">CLOSE&lt;/span>&lt;span style="color:#5bc4bf">);&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#5bc4bf">}&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#815ba4">private&lt;/span> &lt;span style="color:#fec418">void&lt;/span> &lt;span style="color:#06b6ef">sendError&lt;/span>&lt;span style="color:#5bc4bf">(&lt;/span>ChannelHandlerContext ctx&lt;span style="color:#5bc4bf">,&lt;/span> HttpResponseStatus status&lt;span style="color:#5bc4bf">)&lt;/span> &lt;span style="color:#5bc4bf">{&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> FullHttpResponse resp &lt;span style="color:#5bc4bf">=&lt;/span> &lt;span style="color:#815ba4">new&lt;/span> DefaultFullHttpResponse&lt;span style="color:#5bc4bf">(&lt;/span>HttpVersion&lt;span style="color:#5bc4bf">.&lt;/span>&lt;span style="color:#06b6ef">HTTP_1_1&lt;/span>&lt;span style="color:#5bc4bf">,&lt;/span> status&lt;span style="color:#5bc4bf">,&lt;/span> Unpooled&lt;span style="color:#5bc4bf">.&lt;/span>&lt;span style="color:#06b6ef">copiedBuffer&lt;/span>&lt;span style="color:#5bc4bf">(&lt;/span>&lt;span style="color:#48b685">&amp;#34;Failure:&amp;#34;&lt;/span> &lt;span style="color:#5bc4bf">+&lt;/span> status&lt;span style="color:#5bc4bf">,&lt;/span> CharsetUtil&lt;span style="color:#5bc4bf">.&lt;/span>&lt;span style="color:#06b6ef">UTF_8&lt;/span>&lt;span style="color:#5bc4bf">));&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> resp&lt;span style="color:#5bc4bf">.&lt;/span>&lt;span style="color:#06b6ef">headers&lt;/span>&lt;span style="color:#5bc4bf">().&lt;/span>&lt;span style="color:#06b6ef">set&lt;/span>&lt;span style="color:#5bc4bf">(&lt;/span>CONTENT_TYPE&lt;span style="color:#5bc4bf">,&lt;/span> &lt;span style="color:#48b685">&amp;#34;text/plain; charset=UTF-8&amp;#34;&lt;/span>&lt;span style="color:#5bc4bf">);&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> ctx&lt;span style="color:#5bc4bf">.&lt;/span>&lt;span style="color:#06b6ef">writeAndFlush&lt;/span>&lt;span style="color:#5bc4bf">(&lt;/span>resp&lt;span style="color:#5bc4bf">).&lt;/span>&lt;span style="color:#06b6ef">addListener&lt;/span>&lt;span style="color:#5bc4bf">(&lt;/span>ChannelFutureListener&lt;span style="color:#5bc4bf">.&lt;/span>&lt;span style="color:#06b6ef">CLOSE&lt;/span>&lt;span style="color:#5bc4bf">);&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#5bc4bf">}&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#5bc4bf">@Override&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#815ba4">public&lt;/span> &lt;span style="color:#fec418">void&lt;/span> &lt;span style="color:#06b6ef">channelReadComplete&lt;/span>&lt;span style="color:#5bc4bf">(&lt;/span>ChannelHandlerContext ctx&lt;span style="color:#5bc4bf">)&lt;/span> &lt;span style="color:#815ba4">throws&lt;/span> Exception &lt;span style="color:#5bc4bf">{&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> ctx&lt;span style="color:#5bc4bf">.&lt;/span>&lt;span style="color:#06b6ef">writeAndFlush&lt;/span>&lt;span style="color:#5bc4bf">(&lt;/span>Unpooled&lt;span style="color:#5bc4bf">.&lt;/span>&lt;span style="color:#06b6ef">EMPTY_BUFFER&lt;/span>&lt;span style="color:#5bc4bf">);&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#815ba4">super&lt;/span>&lt;span style="color:#5bc4bf">.&lt;/span>&lt;span style="color:#06b6ef">channelReadComplete&lt;/span>&lt;span style="color:#5bc4bf">(&lt;/span>ctx&lt;span style="color:#5bc4bf">);&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#5bc4bf">}&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#5bc4bf">@Override&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#815ba4">public&lt;/span> &lt;span style="color:#fec418">void&lt;/span> &lt;span style="color:#06b6ef">exceptionCaught&lt;/span>&lt;span style="color:#5bc4bf">(&lt;/span>ChannelHandlerContext ctx&lt;span style="color:#5bc4bf">,&lt;/span> Throwable cause&lt;span style="color:#5bc4bf">)&lt;/span> &lt;span style="color:#815ba4">throws&lt;/span> Exception &lt;span style="color:#5bc4bf">{&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> LOG&lt;span style="color:#5bc4bf">.&lt;/span>&lt;span style="color:#06b6ef">error&lt;/span>&lt;span style="color:#5bc4bf">(&lt;/span>&lt;span style="color:#48b685">&amp;#34;抛出异常&amp;#34;&lt;/span>&lt;span style="color:#5bc4bf">,&lt;/span> cause&lt;span style="color:#5bc4bf">);&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#815ba4">super&lt;/span>&lt;span style="color:#5bc4bf">.&lt;/span>&lt;span style="color:#06b6ef">exceptionCaught&lt;/span>&lt;span style="color:#5bc4bf">(&lt;/span>ctx&lt;span style="color:#5bc4bf">,&lt;/span> cause&lt;span style="color:#5bc4bf">);&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#5bc4bf">}&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>&lt;span style="color:#5bc4bf">}&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>唯一需要注意的是，在请求的时候，通过&lt;code>domain&lt;/code>参数带上了域名B*，然后在响应的时候，配置跨域相关的一些HTTP响应头：&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#e7e9db;background-color:#2f1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-java" data-lang="java">&lt;span style="display:flex;">&lt;span>resp&lt;span style="color:#5bc4bf">.&lt;/span>&lt;span style="color:#06b6ef">headers&lt;/span>&lt;span style="color:#5bc4bf">().&lt;/span>&lt;span style="color:#06b6ef">set&lt;/span>&lt;span style="color:#5bc4bf">(&lt;/span>&lt;span style="color:#48b685">&amp;#34;Access-Control-Allow-origin&amp;#34;&lt;/span>&lt;span style="color:#5bc4bf">,&lt;/span> referer&lt;span style="color:#5bc4bf">);&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>resp&lt;span style="color:#5bc4bf">.&lt;/span>&lt;span style="color:#06b6ef">headers&lt;/span>&lt;span style="color:#5bc4bf">().&lt;/span>&lt;span style="color:#06b6ef">set&lt;/span>&lt;span style="color:#5bc4bf">(&lt;/span>&lt;span style="color:#48b685">&amp;#34;Access-Control-Allow-Methods&amp;#34;&lt;/span>&lt;span style="color:#5bc4bf">,&lt;/span> &lt;span style="color:#48b685">&amp;#34;GET, POST&amp;#34;&lt;/span>&lt;span style="color:#5bc4bf">);&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>resp&lt;span style="color:#5bc4bf">.&lt;/span>&lt;span style="color:#06b6ef">headers&lt;/span>&lt;span style="color:#5bc4bf">().&lt;/span>&lt;span style="color:#06b6ef">set&lt;/span>&lt;span style="color:#5bc4bf">(&lt;/span>&lt;span style="color:#48b685">&amp;#34;Access-Control-Allow-Credentials&amp;#34;&lt;/span>&lt;span style="color:#5bc4bf">,&lt;/span> &lt;span style="color:#48b685">&amp;#34;true&amp;#34;&lt;/span>&lt;span style="color:#5bc4bf">);&lt;/span>
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div>&lt;p>其中referer就是域名B*。&lt;/p>
&lt;h3 id="页面js调用">页面js调用&lt;/h3>
&lt;p>js发AJAX请求这块就更简单了。唯一注意的是，我们这个Cookie字段可能在页面加载后一段时间才能获取到，所以这里设置了重试机制，获取不到ID的时候等待1秒后重新发送一次请求，一共最多请求5次。&lt;br>
这里发送AJAX请求也涉及到一些跨域的配置，详见注释&lt;/p>
&lt;div class="highlight">&lt;pre tabindex="0" style="color:#e7e9db;background-color:#2f1e2e;-moz-tab-size:4;-o-tab-size:4;tab-size:4;">&lt;code class="language-javascript" data-lang="javascript">&lt;span style="display:flex;">&lt;span>&lt;span style="color:#06b6ef">$&lt;/span>(window).&lt;span style="color:#06b6ef">load&lt;/span>(&lt;span style="color:#815ba4">function&lt;/span>(){
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#06b6ef">setTimeout&lt;/span>(&lt;span style="color:#815ba4">function&lt;/span>(){&lt;span style="color:#06b6ef">getID&lt;/span>(&lt;span style="color:#f99b15">5&lt;/span>);}, &lt;span style="color:#f99b15">1000&lt;/span>);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#815ba4">function&lt;/span> &lt;span style="color:#06b6ef">getID&lt;/span>(&lt;span style="color:#06b6ef">times&lt;/span>){
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#06b6ef">$&lt;/span>.&lt;span style="color:#06b6ef">ajax&lt;/span>({
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#06b6ef">url&lt;/span>&lt;span style="color:#5bc4bf">:&lt;/span> &lt;span style="color:#48b685">&amp;#39;http://A.com/getid?domain=&amp;#39;&lt;/span>&lt;span style="color:#5bc4bf">+&lt;/span>document.&lt;span style="color:#06b6ef">domain&lt;/span>,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#06b6ef">type&lt;/span>&lt;span style="color:#5bc4bf">:&lt;/span> &lt;span style="color:#48b685">&amp;#39;get&amp;#39;&lt;/span>,
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#06b6ef">crossDomain&lt;/span>&lt;span style="color:#5bc4bf">:&lt;/span> &lt;span style="color:#815ba4">true&lt;/span>, &lt;span style="color:#776e71">/*允许跨域*/&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#06b6ef">xhrFields&lt;/span>&lt;span style="color:#5bc4bf">:&lt;/span> { &lt;span style="color:#06b6ef">withCredentials&lt;/span>&lt;span style="color:#5bc4bf">:&lt;/span> &lt;span style="color:#815ba4">true&lt;/span> }, &lt;span style="color:#776e71">/*允许跨域*/&lt;/span>
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#06b6ef">error&lt;/span>&lt;span style="color:#5bc4bf">:&lt;/span> &lt;span style="color:#815ba4">function&lt;/span>(&lt;span style="color:#06b6ef">data&lt;/span>){&lt;span style="color:#06b6ef">alert&lt;/span>(&lt;span style="color:#06b6ef">data&lt;/span>);},
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#06b6ef">success&lt;/span>&lt;span style="color:#5bc4bf">:&lt;/span> &lt;span style="color:#815ba4">function&lt;/span> (&lt;span style="color:#06b6ef">data&lt;/span>) {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#815ba4">if&lt;/span>(&lt;span style="color:#06b6ef">data&lt;/span> &lt;span style="color:#5bc4bf">!=&lt;/span> &lt;span style="color:#48b685">&amp;#34;&amp;#34;&lt;/span>){
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#06b6ef">ID&lt;/span> &lt;span style="color:#5bc4bf">=&lt;/span> &lt;span style="color:#06b6ef">data&lt;/span>;
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> } &lt;span style="color:#815ba4">else&lt;/span> {
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#815ba4">if&lt;/span>(&lt;span style="color:#5bc4bf">--&lt;/span>&lt;span style="color:#06b6ef">times&lt;/span> &lt;span style="color:#5bc4bf">&amp;gt;&lt;/span> &lt;span style="color:#f99b15">0&lt;/span>)
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> &lt;span style="color:#06b6ef">setTimeout&lt;/span>(&lt;span style="color:#815ba4">function&lt;/span>(){&lt;span style="color:#06b6ef">getID&lt;/span>(&lt;span style="color:#06b6ef">times&lt;/span>);}, &lt;span style="color:#f99b15">1000&lt;/span>);
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> });
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span> }
&lt;/span>&lt;/span>&lt;span style="display:flex;">&lt;span>});
&lt;/span>&lt;/span>&lt;/code>&lt;/pre>&lt;/div></description></item></channel></rss>